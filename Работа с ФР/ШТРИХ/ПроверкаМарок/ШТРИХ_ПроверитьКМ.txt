IF (TYPE("РАЗРЕШИТЬОТКЛЮЧАТЬККТ") == "U")
	РАЗРЕШИТЬОТКЛЮЧАТЬККТ = true;
	
//*обнуление переменных
РезультатЛокальнойПроверкиКМ = "";
ДанныеЛокальнойПроверки = "";
КМПроверенФН = "";
КМРезультатПроверкиФН = "";
КМПричинаОшибкиПроверкиФН = "";
ДанныеФоновойПроверки = "";
ДанныеОнлайнПроверки = "";
РезультатФоновойПроверкиГотов = false;
ФоноваяПроверкаКМВыполнена = false;
РезультатОбработкиСведенийОТоваре = "";
ИСМСведенияОТоваре = "";
КодОбработкиЗапроса = "";
ЗапросОКМОтправлен = false;
ККТАвтономно = false;
//\	
РЕЗУЛЬТАТПРОВЕРКИСВЕДЕНИЙОТОВАРЕ = "";

СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ = "";
СимволПереноса = CHR(13) + CHR(10);

//подключаемся к ККТ
IF ( !ФР.ШТРИХ_ОткрытьФР( КОДОБОРУДОВАНИЯ, "Проверка КМ" ) ) RETURN false;


ТипОперацииЧека = ПЕРЕМЕННАЯ("ОПЕРАЦИЯ", "ПРОДАЖА");

driverKKM.Barcode = ШТРИХКОДМАРКИРОВКИ; //значение кода маркировки (тег 2000)
driverKKM.ItemStatus = ЕСЛИ( ТипОперацииЧека == "ПРОДАЖА" ИЛИ ТипОперацииЧека == 1, 1, 3 ); //тэг 2003
																			//1 - Штучный товар, подлежащий обязательной маркировке средством идентификации, реализован
																			//2 - Мерный товар, подлежащий обязательной маркировке средством идентификации, в стадии реализации
																			//3 - Штучный товар, подлежащий обязательной маркировке средством идентификации, возвращен
																			//4 - Часть товара, подлежащего обязательной маркировке средством идентификации, возвращена
																			//255 - Статус товара, подлежащего обязательной маркировке средством идентификации, не изменился
driverKKM.CheckItemMode = 0; //Режим обработки кода товара (тег 2102)
driverKKM.DivisionalQuantity = false;	//Признак дробной реализации маркированного товара (ФФД 1.2)
//driverKKM.Numerator = 1; //(Строка - Строковое представление 8-байтного числа) Числитель дробной части реализации маркированного товара, DivisionalQuantity должно быть True (ФФД 1.2)
//driverKKM.Denominator = 10; //(Строка - Строковое представление 8-байтного числа) Знаменатель дробной части реализации маркированного товара, DivisionalQuantity должно быть True (ФФД 1.2)

ОТВЕТ = "";

IF ( driverKKM.FNCheckItemBarcode2() <> 0 )
{
	ФР.ШТРИХ_ОчиститьТаблицуПроверенныхКМ();
	ФР.ШТРИХ_ЗакрытьФРСПроверкойНаОшибки( КОДОБОРУДОВАНИЯ, "Проверка КМ" );
	RETURN false;
}

//ОБРАБОТКА РЕЗУЛЬТАТА ЗАДАНИЯ И ЗАПИСЬ В КОНТЕКСТ ПОЗИЦИЙ ЧЕКА

РезультатЛокальнойПроверкиКМ = driverKKM.CheckItemLocalResult; //Статус локальной проверки
															//0 – проверка не проводилась, (для симметричной криптографической системы).
															//1 – код маркировки проверен, достоверный.
															//2 – код маркировки проверен, недостоверный.
															//3 – проверка не проводилась, (криптографическая система асимметричная, но в ФН-М нет ключа с идентификатором КПКИЗ.ид).

ОписаниеОшибкиЛокальнойПроверки = driverKKM.CheckItemLocalError;  //Причина, по которой не была проведена локальная проверка.
															//0 – КМ проверен в ФН 
															//1 – КМ данного типа не подлежит проверки в ФН 
															//2 – ФН не содержит ключ проверки кода проверки этого КМ 
															//3 – Проверка невозможна, так как отсутствуют идентификаторы применения GS1 91 и / или 92 или их формат неверный 
															//4 – Внутренняя ошибка в ФН при проверке этого КМ

КодРезультатаПроверкиКМ = driverKKM.KMServerErrorCode;		//Код ответа ФН на команду онлайн-проверки
															//Ответ 0xFF означает, что сервер не ответил в течении таймаута. 
															//Если значение KMServerErrorCode равно 0x20, то в KMServerCheckingStatus возвращается причина ошибки.
															//Возможные значения:
															//0 – Статус успешно изменен (соединение с ИСМ установлено)
															//1 – КИЗ отсутствует в базе Серверы СКЗКМ или КИЗ отсутствует в базе ИСМ
															//2 – Не корректен формат КИЗ
															//3 – Криптографическая проверка КПКИЗ дала отрицательный результат
															//4 – КИЗ имеет в базе Серверы СКЗКМ статус не совместимый с запрашиваемым изменением. 
															//		Например, запрошено изменение статуса «Выбыл в розничной сети» в то время, как товар уже был продан. 
															//		Иными словами, запрашивается запрещенное изменение статуса кода маркировки
															//5 – В списке вложения обнаружены ошибки
															


ИСМСведенияОТоваре = driverKKM.KMServerCheckingStatus;		//Результат проверки КМ. (Тег 2106 ФФД).
															//Только если сервер ответил без ошибок, иначе значение -1.
															

РеквизитыТЛВ = driverKKM.TLVDataHex;						//TLV реквизитов ответа сервера в виде HEX строки.

КМПроверенФН = РезультатЛокальнойПроверкиКМ == 1; 			//может отсутствовать, если проверка в ФН не выполнена

//информация о коде маркировки, сформированная ККТ
КодТипаКМ = driverKKM.MarkingType2;							//Распознанный тип КМ, (Тег 2100 ФФД)
															//Возможные значения:
															//0 – Тип кода маркировки не идентифицирован 
															//		(код маркировки отсутствует, не может быть прочитан или может быть прочитан, но не может быть распознан);
															//1 – Короткий код маркировки;
															//2 – Код маркировки со значением кода проверки длиной 88 символов, подлежащим проверке в ФН;
															//3 – Код маркировки со значением кода проверки длиной 44 символа, не подлежащим проверке в ФН;
															//4 – Код маркировки со значением кода проверки длиной 44 символа, подлежащим проверке в ФН;
															//5 – Код маркировки со значением кода проверки длиной 4 символа, не подлежащим проверке в ФН.


ЗапросОКМОтправлен = ВСПИСКЕ( КодРезультатаПроверкиКМ, 0, 1, 2, 3, 4, 5 ) ;
//сохраним результат проверки сведений о товаре для последующей передачи в позиции чека
РЕЗУЛЬТАТПРОВЕРКИСВЕДЕНИЙОТОВАРЕ = ИСМСведенияОТоваре;

//получим сведения о статусе товара, по которым можно определить, автономно работает ккт или нет
ИСМСведенияОСтатусеТовара = ЕСЛИ( ИСМСведенияОТоваре == -1, "", ФР.ШТРИХ_ПолучитьСведенияОПроверкеТовара(ИСМСведенияОТоваре) );
IF ( !ПУСТО( ИСМСведенияОСтатусеТовара ) )
{
	//4й бит в результатах проверки. Берем 4й слева, т.к. и слева и справа он будет идти четвертым
	ККТАвтономно = VAL(ПОДСТРОКА( ИСМСведенияОСтатусеТовара, 4, 1 )) == 1;
}

//все данные прочитали из ответа, теперь проверим и обработаем значения
IF (КодРезультатаПроверкиКМ == 0 AND ИСМСведенияОТоваре == 15)
{
	РезультатПодтвержденияКМ = ФР.ШТРИХ_ПодтвердитьРеализациюКМ();
	//сохраним результат проверки сведений о товаре для последующей передачи в позиции чека
	РЕЗУЛЬТАТПРОВЕРКИСВЕДЕНИЙОТОВАРЕ = driverKKM.KMServerCheckingStatus; //2106
	ФР.ШТРИХ_ЗакрытьФРСПроверкойНаОшибки( КОДОБОРУДОВАНИЯ, "Проверка КМ" );
	RETURN true;
}
ELSE IF ( ВСПИСКЕ( КодРезультатаПроверкиКМ, 0, 1, 2, 3, 4, 5 ) )
{
	IF ( !ПУСТО( НАИМЕНОВАНИЕТОВАРА ) )
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Товар: " + НАИМЕНОВАНИЕТОВАРА + СимволПереноса + СимволПереноса;
		
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += СимволПереноса;
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Результаты онлайн проверки: " + СимволПереноса;
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += СимволПереноса;
	
	IF (КодРезультатаПроверкиКМ == 0)
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Соединение с ИСМ установлено." + СимволПереноса; 
	ELSE IF (КодРезультатаПроверкиКМ == 1)
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "КИЗ отсутствует в базе Серверы СКЗКМ или КИЗ отсутствует в базе ИСМ." + СимволПереноса; 
	ELSE IF (КодРезультатаПроверкиКМ == 2)
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Указанный в запросе код маркировки имеет некорректный формат." + СимволПереноса; 		
	ELSE IF (КодРезультатаПроверкиКМ == 3)
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Криптографическая проверка КПКИЗ дала отрицательный результат." + СимволПереноса; 
	ELSE IF (КодРезультатаПроверкиКМ == 4)
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "КИЗ имеет в базе Серверы СКЗКМ статус не совместимый с запрашиваемым изменением." + СимволПереноса; 	
	ELSE
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Запрос имеет некорректный формат." + СимволПереноса; 		
}

IF ( ИСМСведенияОТоваре <> -1 )
{
	//обработаем сведения о товаре
	РезультатОбработкиСведенийОТоваре = ФР.ШТРИХ_ОбработатьСведенияОТоваре(ИСМСведенияОТоваре);
	
	//СООБЩЕНИЕ("РезультатОбработкиСведенийОТоваре = " + РезультатОбработкиСведенийОТоваре + CHR(13) + CHR(10) + "ИСМСведенияОТоваре = " + ИСМСведенияОТоваре);
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Результат онлайн проверки товара: " + РезультатОбработкиСведенийОТоваре + СимволПереноса;	
}

//если проверка выполнена, но запрос не отправлялся, то ККТ в автономном режиме.
//В перечисленных случаях выводим только данные локальной проверки
IF ( !ЗапросОКМОтправлен )
{
	IF ( !ПУСТО( НАИМЕНОВАНИЕТОВАРА ) )
			СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Товар: " + НАИМЕНОВАНИЕТОВАРА + СимволПереноса + СимволПереноса;
			
	ТекстПричина = "";
	IF ( ОписаниеОшибкиЛокальнойПроверки == 0)
		ТекстПричина = "КМ проверен в ФН";
	ELSE IF ( ОписаниеОшибкиЛокальнойПроверки == 1)
		ТекстПричина = "КМ данного типа не подлежит проверки в ФН";
	ELSE IF ( ОписаниеОшибкиЛокальнойПроверки == 2)
		ТекстПричина = "ФН не содержит ключ проверки кода проверки этого КМ";
	ELSE IF ( ОписаниеОшибкиЛокальнойПроверки == 3)
		ТекстПричина = "Проверка невозможна, так как отсутствуют идентификаторы применения GS1 91 и / или 92 или их формат неверный ";
	ELSE
		ТекстПричина = "Внутренняя ошибка в ФН при проверке этого КМ";

	
	//если проводилась только локальная проверка без отправки запроса в ИСМ и завершилась успешно, то добавляем КМ в чек без подтверждения
	IF ( РезультатЛокальнойПроверкиКМ == 1 )
	{
		РезультатПодтвержденияКМ = ФР.ШТРИХ_ПодтвердитьРеализациюКМ();
		//сохраним результат проверки сведений о товаре для последующей передачи в позиции чека
		РЕЗУЛЬТАТПРОВЕРКИСВЕДЕНИЙОТОВАРЕ = driverKKM.KMServerCheckingStatus; //2106
		ФР.ШТРИХ_ЗакрытьФРСПроверкойНаОшибки( КОДОБОРУДОВАНИЯ, "Проверка КМ" );
		RETURN true;
	}
	
	
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Результаты локальной проверки: " + СимволПереноса;
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += СимволПереноса;
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Проверка КМ в ФН " + ЕСЛИ(КМПроверенФН == true OR КМПроверенФН == "true", "выполнена","не выполнена") + СимволПереноса;
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Результат проверки КМ в ФН - " + ЕСЛИ( РезультатЛокальнойПроверкиКМ == 1, "положительный","отрицательный") + СимволПереноса;
	IF ( !ПУСТО( ТекстПричина ) )
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Причина ошибки: " + ТекстПричина + СимволПереноса;
	
	СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += СимволПереноса;
	
	IF ( ККТАвтономно )
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "ККТ работает в автономном режиме" + СимволПереноса;
	ELSE
		СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Онлайн проверка КМ не выполнена" + СимволПереноса;
}

СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += СимволПереноса;
СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ += "Добавить КМ в чек?";
Ответ = СООБЩЕНИЕ(СООБЩЕНИЕПОЛЬЗОВАТЕЛЮ, "Проверка КМ", 4);
	
//если нажали нет, закрываем соединение с ККТ и возвращаем false
IF (Ответ == 7 )
{
	ФР.ШТРИХ_ОтказатьсяОтРеализацииКМ();
	ФР.ШТРИХ_ЗакрытьФРСПроверкойНаОшибки( КОДОБОРУДОВАНИЯ, "Проверка КМ" );
	RETURN false;
}

РезультатПодтвержденияКМ = ФР.ШТРИХ_ПодтвердитьРеализациюКМ();
//сохраним результат проверки сведений о товаре для последующей передачи в позиции чека
РЕЗУЛЬТАТПРОВЕРКИСВЕДЕНИЙОТОВАРЕ = driverKKM.KMServerCheckingStatus; //2106

ФР.ШТРИХ_ЗакрытьФРСПроверкойНаОшибки( КОДОБОРУДОВАНИЯ, "Проверка КМ" );
RETURN true;
