ТекстЧека = "";
ЗаголовокЧека = "";
ПозицииЧека = "";
БанковскиеПозицииЧека = "";

//ТИПОПЕРАЦИИ, СУММАОПЕРАЦИИ, НОМЕРССЫЛКИДЛЯВОЗВРАТА, КОДВАЛЮТЫ 
IF ( ТИПОПЕРАЦИИ == 0 OR ТИПОПЕРАЦИИ == 6 )
	КодОперацииАркус = 1;
ELSE IF ( ТИПОПЕРАЦИИ == 1 )
	КодОперацииАркус = 2;
ELSE
{
	СООБЩЕНИЕ( "Недопустимый вид операции", ФР.ПСИМЯОБОРУДОВАНИЯ() );
	RETURN false;
}	

IF ( !ФР.ПСАРКУС_Установлен() ) RETURN false;

IF ( ФР.ПСАРКУС_ВыполнитьКоманду(КодОперацииАркус, СУММАОПЕРАЦИИ, НОМЕРССЫЛКИДЛЯВОЗВРАТА, КОДВАЛЮТЫ ) ) RETURN false;

ОтветПС = ФР.ПСАРКУС_ПрочитатьОтветПС();

IF ( ОтветПС == "000" )
{
	ПозицииЧека = "";
	
	/*
	IF ( TYPE("КОДОБОРУДОВАНИЯ") == "U" )
		КОДОБОРУДОВАНИЯ = ФРКОДОБОРУДОВАНИЯ;
	*/
	
	//получаем слип-чек и добавляем в чек
	СлипЧек = ФР.ПСАРКУС_ПолучитьСлип();
	
	НОМЕРССЫЛКИ = "";
	КОЛИЧЕСТВОСЛИПОВ = ЗАПРОС("SELECT slipcount FROM sprequipment WHERE code = '" + КОДОБОРУДОВАНИЯ + "'");

	try
	{
		ЗАПРОС( "INSERT INTO paycardtrans ( equipment, owner, TransType, AuthCode, OperationType, Sum, CardNumber, SlipNumber, TransDate, TransTime, MsgNumber, TerminalID, ReferenceNumber, slip, slipcount, fr_code )
				VALUES ( '"	+ КОДОБОРУДОВАНИЯ + "', '" 
							+ _UNCONFIRMEDID + "', '" 
							+ ТипЧека + "', '"
							+ "" + "', " 							 
							+ КодОперацииАркус + ", " 
							+ VAL( СУММАОПЕРАЦИИ ) / 100 + ", '" 
							+ "" + "', " 
							+ "" + ", '" 
							+ "" + "', '" 
							+ "" + "', " 
							+ "" + ", '" 
							+ "" + "', '" 
							+ НОМЕРССЫЛКИ + "', '" 
							+ STDF( СлипЧек ) + "', '"
							+ КОЛИЧЕСТВОСЛИПОВ + "', '" 
							+ ФРКОДОБОРУДОВАНИЯ + 
							"' )" );
	}
	catch()
	{
		СООБЩЕНИЕ("Ошибка записи данных сверки итогов в базу", ФР.ПСИМЯОБОРУДОВАНИЯ());
	}
	
	//печатаем сверку
	IF ( Сервис.РМККоманда( "ОБОРУДОВАНИЕ", "ФР" ) )
	{
		IF ( ATC(_ОБОРУДОВАНИЕ, ФРКОДОБОРУДОВАНИЯ ) > 0 )
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ФРКОДОБОРУДОВАНИЯ;
		ELSE
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ЛЕВСИМВ( _ОБОРУДОВАНИЕ, 3 );
		
		//СООБЩЕНИЕ("Выполняем команду ФР с кодом " + КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ, ФР.ПСИМЯОБОРУДОВАНИЯ() );
		ТипОтчета = -1;		
		Сервис.РМККоманда( "ВЫПОЛНИТЬКОМАНДУПРОФИЛЯ", КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ + "|116|ЭтоБанковскийСлип=true" );
	}
}		
ELSE
{
	СООБЩЕНИЕ( "Ошибка платежной системы: " + ОтветПС + "." + CHR(13) + CHR(10) +
	ФР.ПСАРКУС_ПолучитьСлип( ), ФР.ПСИМЯОБОРУДОВАНИЯ() );
	RETURN false;
}

RETURN true;
