//+ одна пустая строка
ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, " ", false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ );
	 
//------- Опредяляем общие реквизиты чека
КОДУТМ				= КомандыЧека.utm_code;
ЕГАИССКЛАД			= ЗАПРОС( "SELECT value FROM param_ex WHERE param = 'EGAIS_SKLAD" + КОДУТМ + "'" );
ЕГАИСФИРМА			= ЗАПРОС( "SELECT value FROM param_ex WHERE param = 'EGAIS_FIRM" + КОДУТМ + "'" );

ЧЕКИНН				= ЗАПРОС( "SELECT inn FROM sprfirm WHERE code = '" + ЕГАИСФИРМА + "'" );
ЧЕККПП				= ЗАПРОС( "SELECT kpp FROM sprskl WHERE code = '" + ЕГАИССКЛАД + "'" );
IF ( ПУСТО( ЧЕККПП ) )
	ЧЕККПП			= ЗАПРОС( "SELECT kpp FROM sprfirm WHERE code = '" + ЕГАИСФИРМА + "'" );
	ЧЕКНАИМЕНОВАНИЕ	= ЗАПРОС( "SELECT name FROM sprfirm WHERE code = '" + ЕГАИСФИРМА + "'" );
	ЧЕКАДРЕС		= ЗАПРОС( "SELECT address FROM sprskl WHERE code = '" + ЕГАИССКЛАД + "'" );
IF ( ПУСТО( ЧЕКАДРЕС ) )
	ЧЕКАДРЕС		= ЗАПРОС( "SELECT adress FROM sprfirm WHERE code = '" + ЕГАИСФИРМА + "'" );

ЧЕККАССА			= ЗАПРОС( "SELECT serialnumber FROM sprequipment WHERE code = '" + КОДОБОРУДОВАНИЯ + "'" );
ЧЕКСМЕНА			= НомерСменыККМ;
ЧЕКНОМЕР			= НомерЧекаККМ;
	
ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, ЧЕКНАИМЕНОВАНИЕ, false, "text", "center", "words", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ );
ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, PADR( "ИНН: " + ЧЕКИНН, 20 ) + "КПП: " + ЧЕККПП, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ );
ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, PADR( "КАССА: " + ЧЕККАССА, 20 ) + "СМЕНА: " + ЧЕКСМЕНА, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ );
ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, PADR( "ЧЕК: " + ЧЕКНОМЕР, 14 ) + "ДАТА: " + LEFT( TTOC( ДАТАВРЕМЯ( ) ), 16 ), false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ );

//+ одна пустая строка
ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, " ", false, "text", "left", "none", "" );
	
//ВЫВОД QR КОДА НА ЧЕКЕ
IF ( _ВАРИАНТВЫВОДАШКЕГАИС == 1 )
{
	//ВАРИАНТ 1: вывода ШК по центру без оверлея и все подписи под ШК кодом по центру
	НоваяСтрокаШК = "{
		""type"": ""barcode"",
		""barcode"": """ + КомандыЧека.egais_url + """,
		""barcodeType"": ""QR"",
		""scale"": " + _КОЭФФИЦИЕНТУВЕЛИЧЕНИЯШКЕГАИС + ",
		""alignment"": ""center""
	}
	";
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, НоваяСтрокаШК, false, "barcode", "", "", "");
	//+ одна пустая строка
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, " ", false, "text", "left", "none", "");
	//ссылка ЕГАИС под QR кодом
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, КомандыЧека.egais_url, false, "text", "center", "chars", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
	//+ одна пустая строка
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, " ", false, "text", "left", "none", "");
	//цифровая подпись
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, КомандыЧека.egais_sign, false, "text", "center", "chars", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
	//+ одна пустая строка
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, " ", false, "text", "left", "none", "");
}
ELSE
{
	//ВАРИАНТ 2: (ШК справа, ссылка слева и цифровая подпись снизу
	НоваяСтрокаШК = "{
		""type"": ""barcode"",
		""barcode"": """ + КомандыЧека.egais_url + """,
		""barcodeType"": ""QR"",
		""scale"": " + _КОЭФФИЦИЕНТУВЕЛИЧЕНИЯШКЕГАИС + ",
		""alignment"": ""right"",";
		
	//Определим параметры печати с оверлеем.
	//Чтобы ссылка егаис не скрывалась под QR кодом, разобъем её на подстроки и выведем эти подстроки слева от QR кода
	ТекстСсылкиЕГАИС 			= КомандыЧека.egais_url;
	ШиринаПечатиСсылки			= _КОЛИЧЕСТВОСИМВОЛОВЧЕКОВОЙЛЕНТЫ - _ШИРИНАШКЕГАИС;
	КоличествоСимволовВссылке	= ДЛИНА( ТекстСсылкиЕГАИС );
	КоличествоПодстрок 			= ЦЕЛОЕ( КоличествоСимволовВссылке / ЕСЛИ(ШиринаПечатиСсылки == 0,1, ШиринаПечатиСсылки ) );
	IF ( КоличествоСимволовВссылке % ЕСЛИ( ШиринаПечатиСсылки==0,1, ШиринаПечатиСсылки ) <> 0 )
		КоличествоПодстрок++;
		
	Оверлей 					= "
	""overlay"": [";
	
	НачальнаяПозиция = 1;
	FOR ( index = 1; index <= КоличествоПодстрок ; index++ )
	{
		КоличествоСимволовВссылке = ЕСЛИ(КоличествоСимволовВссылке - ШиринаПечатиСсылки <= 0, КоличествоСимволовВссылке, КоличествоСимволовВссылке - ШиринаПечатиСсылки);	
		ТекстПодстроки = ПОДСТРОКА( ТекстСсылкиЕГАИС, НачальнаяПозиция, ЕСЛИ( index == КоличествоПодстрок, КоличествоСимволовВссылке, ШиринаПечатиСсылки ) );
		НачальнаяПозиция += ШиринаПечатиСсылки;
		Оверлей += ЕСЛИ( ПРАВСИМВ( Оверлей, 1 ) == "}", ",", "" ) + "
		{
		""type"": ""text"",
		""text"": """ + ТекстПодстроки + """,
		""alignment"": ""left"",
		""wrap"": ""chars"",
		""font"":" + VAL( _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ ) + "
		}";
	}
	//закрывающая оверлей квадратная скобка
	Оверлей = Оверлей + "
	]";
	//соберем объект для печати QR кода со ссылкой
	НоваяСтрокаШК = НоваяСтрокаШК + Оверлей + "
	}";
	//добавим полученный объект со штрихкодом к позициям чека
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, НоваяСтрокаШК, false, "barcode", "", "", "" );
	//+ одна пустая строка
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, " ", false, "text", "left", "none", "");
	//далее цифровая подпись
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, КомандыЧека.egais_sign, false, "text", "center", "chars", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
	//+ одна пустая строка
	ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, " ", false, "text", "left", "none", "");
}
				
IF ( _ОТДЕЛЬНЫЙСЛИПЕГАИС )
{
	ЗаголовокЧека = "
	{
		""type"": ""nonFiscal"",";
		
	ТекстЧека = ЗаголовокЧека + "
	""items"": [
	" + ПозицииЧека + "
	]
	}";
	РезультатПечати 	= ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, false, "" );
	IF ( !РезультатПечати )	RETURN false;

	//Если успешно напечатали нефискальный чек, то обнуляем текст чека и нефискальные строки
	ТекстЧека 		= "";
	ЗаголовокЧека	= "";
	ПозицииЧека 	= "";
}

RETURN true;
