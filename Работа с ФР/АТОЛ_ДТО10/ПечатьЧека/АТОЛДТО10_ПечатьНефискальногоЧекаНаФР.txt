//"ПечатьНефискальногоЧекаНаФР" - функция, которая будет заниматься формированием нефискального чека в формате JSON для его последующей отправки в ККМ

ТекстЧека 		= "";
ЗаголовокЧека	= "";
ПозицииЧека		= "";
СтрокиОплатЧека = "";
ФискальныйЧек	= false; 	//Признак фискального чека
//ВерсияФФД		= "";

ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяТаблицыСтрокЧека + " ORDER BY identity_column", "КомандыЧека" );
WHILE ( !КОНЕЦКОНТЕКСТА( "КомандыЧека" ) )
{
	IF ( КомандыЧека.operation == "ЕГАИС слип" )
	{
		IF ( !ФР.АТОЛДТО10_ПечатьСлипаЕГАИС( ) ) RETURN false;
	}
	IF ( КомандыЧека.operation == "Открыть чек" )
	{
		ЗаголовокЧека	= ФР.АТОЛДТО10_ЗаголовокНефискальногоЧека( );
		
		IF ( КомандыЧека.checktype != "ПРЕЧЕК")
		{
			//добавляем слово ЧЕК по центру
			IF (ПЕРЕМЕННАЯ("_ЭТОКОПИЯЧЕКА", false))
				СТРОКАЗАГОЛОВОКЧЕКАКОПИИ = "КОПИЯ ЧЕКА";
			ELSE
				СТРОКАЗАГОЛОВОКЧЕКАКОПИИ = "ТОВАРНЫЙ ЧЕК";
			
			ФР.АТОЛДТО10_ДобавитьСтрокуЧека(ПозицииЧека, СТРОКАЗАГОЛОВОКЧЕКАКОПИИ, false, "text", "center", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
		}
	}
	ELSE IF ( КомандыЧека.operation == "Печать строки" )
	{
		ФР.АТОЛДТО10_ПечатьСтроки( КомандыЧека.name, КомандыЧека.mode, КомандыЧека.checktype );
	}
	ELSE IF ( КомандыЧека.operation == "Регистрация" OR КомандыЧека.operation == "Возврат" )
	{
		ФР.АТОЛДТО10_ДобавитьВЧекНефискальнуюРегистрациюВозврат( );
	}	
	ELSE IF ( КомандыЧека.operation == "ИТОГ" )
	{
		СтрокаСИтогом = ФР.ФормированиеСтрокиДляНефискальнойПечати("ИТОГ", "LR", "", "="+STR( КомандыЧека.price, 16, 2), "");
		ФР.АТОЛДТО10_ДобавитьСтрокуЧека(ПозицииЧека, СтрокаСИтогом, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
	}
	ELSE IF ( КомандыЧека.operation == "Оплата" )
	{
		//СтрокаИтог = "ИТОГ        = " + STR( КомандыЧека.price, 16, 2)
		IF (КомандыЧека.closetype == "cash")
			СТРОКАНАИМЕНОВАНИЕОПЛАТЫ = "НАЛИЧНЫМИ";
		ELSE IF (КомандыЧека.closetype == "electronically")
			СТРОКАНАИМЕНОВАНИЕОПЛАТЫ = "БЕЗНАЛИЧНЫМИ";
		ELSE IF (КомандыЧека.closetype == "prepaid")	
			СТРОКАНАИМЕНОВАНИЕОПЛАТЫ = "ПРЕДОПЛАТОЙ";
		ELSE IF (КомандыЧека.closetype == "credit")	
			СТРОКАНАИМЕНОВАНИЕОПЛАТЫ = "КРЕДИТОМ";	
		ELSE IF (КомандыЧека.closetype == "other")	
			СТРОКАНАИМЕНОВАНИЕОПЛАТЫ = "ВСТРЕЧНОЕ ПРЕДОСТАВЛЕНИЕ";
		ELSE
			СТРОКАНАИМЕНОВАНИЕОПЛАТЫ = "ПРОЧАЯ";
			
		СтрокаОплаты = ФР.ФормированиеСтрокиДляНефискальнойПечати(СТРОКАНАИМЕНОВАНИЕОПЛАТЫ, "LR", "", "="+STR( КомандыЧека.price, 16, 2), "");
		ФР.АТОЛДТО10_ДобавитьСтрокуЧека(ПозицииЧека, СтрокаОплаты, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
	}	
	ELSE IF ( КомандыЧека.operation == "Закрытие чека" )
	{
		//соберем итоговый чек в формате JSON
		ФР.АТОЛДТО10_ДобавитьСтрокуЧека(ПозицииЧека, "КАССИР " + _ИМЯКАССИРА, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
		ИМЯЮРЛИЦО = ЗАПРОС("SELECT name FROM sprfirm WHERE code = (SELECT firm FROM sprequipment WHERE code = '" + ФР.КОДОБОРУДОВАНИЯ() + "')");		
		ФР.АТОЛДТО10_ДобавитьСтрокуЧека(ПозицииЧека, ИМЯЮРЛИЦО, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
		
		ИМЯСКЛАД = ЗАПРОС("SELECT name FROM sprskl WHERE code = (SELECT sklad FROM sprequipment WHERE code = '" + ФР.КОДОБОРУДОВАНИЯ() + "')");
		СтрокаМестоРасчетов = ФР.ФормированиеСтрокиДляНефискальнойПечати("Место расчетов", "L", "", "", "");
		ФР.АТОЛДТО10_ДобавитьСтрокуЧека(ПозицииЧека, СтрокаМестоРасчетов, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
		СтрокаМестоРасчетовИмя = ФР.ФормированиеСтрокиДляНефискальнойПечати(" ", "LR", "", "" + ИМЯСКЛАД + "", "");
		ФР.АТОЛДТО10_ДобавитьСтрокуЧека(ПозицииЧека, СтрокаМестоРасчетовИмя, false, "text", "left", "none", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
		
		//1. Добавим фискальные/нефискальные строки 
		ТекстЧека = ЗаголовокЧека + ЕСЛИ( ПРАВСИМВ(ЗаголовокЧека,1) <> ",", ",", "") + "
		""items"": [
		" + ПозицииЧека + "
		]";
		
		//добавим информацию о бонусах и скидках в чек
		ТекстБонусов = "";
		ТекстИтоговойСкидки = "";
		НомерКартыНаПечать = "";
		IF ( TYPE( "НОМЕРКАРТЫ" ) <> "U" )
			НомерКартыНаПечать = НОМЕРКАРТЫ;
			
		IF ( ПЕРЕМЕННАЯ("_ВЫВОДИТЬИНФОРМАЦИЮОБОНУСАХНАЧЕКЕ", true) == true AND !ПУСТО( НомерКартыНаПечать ) )
			ТекстБонусов = ФР.АТОЛДТО10_ТекстБонусов( );			
				
		IF ( ПЕРЕМЕННАЯ("_ВЫВОДИТЬИТОГОВУЮСКИДКУНАЧЕКЕ", true) == true )
		{
			IF (TYPE("_СУММАСКИДКИВСЕГО") == "I" OR TYPE("_СУММАСКИДКИВСЕГО") == "B" )
			{
				IF ( _СУММАСКИДКИВСЕГО > 0 )
					ТекстИтоговойСкидки = ФР.АТОЛДТО10_ТекстИтоговойСкидки( );
			}
		}
		
		ТекстБонусовСкидки = ТекстБонусов + ЕСЛИ( !ПУСТО(ТекстБонусов) AND !ПУСТО(ТекстИтоговойСкидки), ",", "" ) + ТекстИтоговойСкидки;
		
		IF ( !ПУСТО( ТекстБонусовСкидки ) )
		{
			ТекстЧека	+=  ",
			""postItems"": [
			" + ТекстБонусовСкидки + "
			]";
		}
					
		//3. Закрывающая фигурная скобка
		ТекстЧека = ТекстЧека + "}";
		
		//Пробъем на ККМ итоговый чек
		РезультатПечатиЧека = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, ФискальныйЧек, "", ВерсияФФД );
		
		//если печать завершилась ошибкой, то предложим повторить печать
		WHILE ( !РезультатПечатиЧека )
		{
			СообщениеПользователю 	= "Чек не завершен в ККМ." + CHR( 13 ) + "Повторить печать чека?";
			КодОтвета 				= СООБЩЕНИЕ( СообщениеПользователю, "Ошибка печати чека", 5 );
			IF ( КодОтвета == 4 ) //если нажали "Повторить"
			{
				РезультатПечатиЧека = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, ФискальныйЧек, "", ВерсияФФД ); //повторим печать чека
			}
			ELSE //если нажали "Отмена"
			{
				РезультатПечатиЧека	= false;
				BREAK;
			}
		}
		//конец повтора печати чека
		
		IF ( !РезультатПечатиЧека )
		{
			_ОШИБКАВЫПОЛНЕНИЯ		= true;
			УДАЛИТЬКОНТЕКСТ( "КомандыЧека" );
			// Удаляем временную таблицу
			ЗАПРОС( "DROP TABLE " + ИмяТаблицыСтрокЧека );
			RETURN false;
		}
	}
	
	ПРОПУСТИТЬ( 1, "КомандыЧека" );
}
УДАЛИТЬКОНТЕКСТ( "КомандыЧека" );


// Удаляем временную таблицу
ЗАПРОС( "DROP TABLE " + ИмяТаблицыСтрокЧека );
RETURN true;
