
// Очищаем массив заголовков, чтобы заголовки из других отправок не мешали
Заголовки[ 0 ]			= "";
Заголовки[ 1 ]			= "";
Заголовки[ 2 ]			= "";
Заголовки[ 3 ]			= "";
Заголовки[ 4 ]			= "";

IF ( ПУСТО( СЕРТИФИКАТ ) )
	СЕРТИФИКАТ			= ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_CERTIFICATE" + ПРЕДПРИЯТИЕ + "'" );
ТЕСТОВЫЙКОНТУР			= VAL( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_APITEST" + ПРЕДПРИЯТИЕ + "'" ) ) != 0 ;
ЭДО.ЭДОИНФОРМАЦИЯ( ПРЕДПРИЯТИЕ );

// Токены авторизации храним в контексте мз трех полей Предприятие, Токен, ВремяАвторизации
IF ( !ВЫБРАТЬКОНТЕКСТ( "ТокеныТаксКом" ) )
	IF ( !ДОБАВИТЬКОНТЕКСТ( "LOCAL: Предприятие char, Токен char, ВремяАвторизации int", "ТокеныТаксКом" ) ) RETURN "";
	
ВЫБРАТЬКОНТЕКСТ( "" );
НАШЛИ			= false;
_ERRORCODE		= 0;

ПЕРЕЙТИВНАЧАЛО( "ТокеныТаксКом" );
WHILE ( !КОНЕЦКОНТЕКСТА( "ТокеныТаксКом" ) && !НАШЛИ )
{
	Нашли		= UPPER( ALLTRIM( ТокеныТаксКом.Предприятие ) ) == Предприятие;
	IF ( !НАШЛИ ) ПРОПУСТИТЬ( 1, "ТокеныТаксКом" );
}
IF ( !НАШЛИ )
{
	ДОБАВИТЬСТРОКИ( 1, "ТокеныТаксКом" );
	ИЗМЕНИТЬПОЛЕ( "ТокеныТаксКом", "Предприятие", ПРЕДПРИЯТИЕ );
}
ELSE IF ( ( TICKCOUNT( ) - ТокеныТаксКом.ВремяАвторизации ) < 100000 && !ПУСТО( ТокеныТакском.Токен ) ) RETURN ТокеныТакском.Токен;

// Авторизуемся
ТАКСКОМТОКЕН		= "";
АдресСервера 		= ЭДО.ТАКСКОМАдресСервера( ТЕСТОВЫЙКОНТУР );
Заголовки[ 0 ]		= ЭДО.ТАКСКОМИнтегратор( );
Заголовки[ 1 ]		= "";

try
{
	//edxClientId=2AL-93D14F72-E2A4-4DE6-8859-03B70C547106-00000
	ТекстОшибки			= "Сервер " + АдресСервера + CHR( 13 ) + "вернул сообщение об ошибке: " + CHR( 13 );
	Соединение 			= HTTPCONNECT( АдресСервера, "", true, ЭДО.ФАЙЛЖУРНАЛА( ) );
	ШифрованныеДанные	= ШИФРОВАНИЕ( СЕРТИФИКАТ, "", 7, false, false, _ЭДО_ХРАНИЛИЩЕСЕРТИФИКАТОВ );

	Ответ				= _ERRORDESCRIPTION;
	IF ( ПУСТО( ШифрованныеДанные ) ) THROW( Ответ );

	Ответ				= HTTPPOST( Соединение, "v1.3/API/CertificateLogin?edxClientId=" + ЭДОИНФО_ИДФирмы, ШифрованныеДанные, "Заголовки", "B" );
	IF ( !ЭДО.ТАКСКОМПРОВЕРКАНАОШИБКИ( @Ответ, true ) ) THROW ( Ответ );
	
	ТАКСКОМТОКЕН		= СТРОКАИЗМАССИВА( ШИФРОВАНИЕ( СЕРТИФИКАТ, Ответ, 5, false, false, _ЭДО_ХРАНИЛИЩЕСЕРТИФИКАТОВ ) );
	IF ( ПУСТО( ШифрованныеДанные ) ) THROW( "Не удалось расшифровать токен ТАКСКОМ" );
}
catch ( ТекстСообщения )
{
	HTTPCLOSE( Соединение );
	СООБЩЕНИЕ( ТекстСообщения );
	ИЗМЕНИТЬПОЛЕ( "ТокеныТакском", "Токен", "" );
	RETURN "";
}
HTTPCLOSE( Соединение );

ИЗМЕНИТЬПОЛЕ( "ТокеныТакском", "Токен", ТАКСКОМТОКЕН );
ИЗМЕНИТЬПОЛЕ( "ТокеныТакском", "ВремяАвторизации", TICKCOUNT( ) );
RETURN ТАКСКОМТОКЕН;
