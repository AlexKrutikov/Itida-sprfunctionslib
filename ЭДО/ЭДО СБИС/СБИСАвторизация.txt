
// Очищаем массив заголовков, чтобы заголовки из других отправок не мешали
Заголовки[ 0 ]		= "";
Заголовки[ 1 ]		= "";
Заголовки[ 2 ]		= "";
Заголовки[ 3 ]		= "";
Заголовки[ 4 ]		= "";

ЛОГИН				= ДАННЫЕ_JSON( "Логин", ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDILOGIN" + ПРЕДПРИЯТИЕ + "'" ) );
ПАРОЛЬ				= ДАННЫЕ_JSON( "Пароль", ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIPASSWORD" + ПРЕДПРИЯТИЕ + "'" ) );
АККАУНТ				= ДАННЫЕ_JSON( "НомерАккаунта", ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIACCOUNT" + ПРЕДПРИЯТИЕ + "'" ) );

// Токены авторизации храним в контексте мз трех полей Предприятие, Токен, ВремяАвторизации
IF ( !ВЫБРАТЬКОНТЕКСТ( "ТокеныСБИС" ) )
	IF ( !ДОБАВИТЬКОНТЕКСТ( "LOCAL: Предприятие char, Токен char, ВремяАвторизации int", "ТокеныСБИС" ) ) RETURN "";
	
ВЫБРАТЬКОНТЕКСТ( "" );
НАШЛИ			= false;
ПРЕДПРИЯТИЕ		= UPPER( ALLTRIM( ПРЕДПРИЯТИЕ ) );
_ERRORCODE		= 0;

ПЕРЕЙТИВНАЧАЛО( "ТокеныСБИС" );
WHILE ( !КОНЕЦКОНТЕКСТА( "ТокеныСБИС" ) && !НАШЛИ )
{
	Нашли		= UPPER( ALLTRIM( ТокеныСБИС.Предприятие ) ) == ПРЕДПРИЯТИЕ;
	IF ( !НАШЛИ ) ПРОПУСТИТЬ( 1, "ТокеныСБИС" );
}
IF ( !НАШЛИ )
{
	ДОБАВИТЬСТРОКИ( 1, "ТокеныСБИС" );
	ИЗМЕНИТЬПОЛЕ( "ТокеныСБИС", "Предприятие", Предприятие );
}
ELSE IF ( ( TICKCOUNT( ) - ТокеныСБИС.ВремяАвторизации ) < 100000 && !ПУСТО( ТокеныСБИС.Токен ) ) RETURN ТокеныСБИС.Токен;

// Авторизуемся
СБИСТОКЕН			= "";
АдресСервера 		= ЭДО.СБИСАдресСервера( false );
Заголовки[ 0 ]		= "Content-Type: application/json";
Заголовки[ 1 ]		= "";

try
{
	ТекстОшибки			= "Сервер " + АдресСервера + CHR( 13 ) + "вернул сообщение об ошибке: " + CHR( 13 );
	Соединение 			= HTTPCONNECT( АдресСервера, "", true, ЭДО.ФАЙЛЖУРНАЛА( ) );
//	Текст				= ПЕРЕКОДИРОВАТЬ( "{""jsonrpc"": ""2.0"",""method"": ""СБИС.Аутентифицировать"",""params"": {""Параметр"": { " + ЛОГИН + "," + ПАРОЛЬ + "," + АККАУНТ + "}},""id"": 0}", "ANSI", "UTF-8" );
	Текст				= "{""jsonrpc"": ""2.0"",""method"": ""СБИС.Аутентифицировать"",""params"": {""Параметр"": { " + ЛОГИН + "," + ПАРОЛЬ + "," + АККАУНТ + "}},""id"": 0}";
	Ответ				= HTTPPOST( Соединение, "auth/service/", Текст, "Заголовки" );
	IF ( !ЭДО.СБИСПРОВЕРКАНАОШИБКИ( @Ответ, true ) ) THROW ( Ответ );
	ЗАГРУЗИТЬJSON( "Авторизация", Ответ );
	if ( ТИП( "Авторизация.result" ) != "C" ) THROW( ТекстОшибки + Ответ );
	СБИСТОКЕН			= ЗНАЧЕНИЕПОЛЯ( "Авторизация", "result" );
}
catch ( ТекстСообщения )
{
	HTTPCLOSE( Соединение );
	СООБЩЕНИЕ( ТекстСообщения );
	ИЗМЕНИТЬПОЛЕ( "ТокеныСБИС", "Токен", "" );
	RETURN "";
}
HTTPCLOSE( Соединение );

ИЗМЕНИТЬПОЛЕ( "ТокеныСБИС", "Токен", СБИСТОКЕН );
ИЗМЕНИТЬПОЛЕ( "ТокеныСБИС", "ВремяАвторизации", TICKCOUNT( ) );
RETURN СБИСТОКЕН;
