
IF ( !ЭДО.ПрочитатьУПД( GUIDДокумента ) ) RETURN "";
ЭДО.ЭДОИНФОРМАЦИЯ( ПРЕДПРИЯТИЕ );
КодДокумента			= ЗАПРОС( "SELECT code, ic, cediid FROM edioutcome WHERE guid = '" + GUIDДокумента + "'", "code" );
ИДДокумента				= ЗАПРОС( "", "ic" );
КлиентЭДОИД 			= ЗАПРОС( "", "cediid" );

// К имени файла добавляем путь
ПОДПИСАНТИМЯ			= ЗАМЕНИТЬ( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIFIRSTNAME" + ПРЕДПРИЯТИЕ + "'" ), " ", "_" );
ПОДПИСАНТФАМИЛИЯ		= ЗАМЕНИТЬ( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDISURNAME" + ПРЕДПРИЯТИЕ + "'" ), " ", "_" );
ПОДПИСАНТОТЧЕСТВО		= ЗАМЕНИТЬ( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIMIDDLENAME" + ПРЕДПРИЯТИЕ + "'" ), " ", "_" );
ПОДПИСАНТДОЛЖНОСТЬ		= ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIPOSITION" + ПРЕДПРИЯТИЕ + "'" );

ПутьКФайлу				= ПОКРУЖЕНИЯ( "TEMP" );
IF ( RIGHT( ПутьКФайлу, 1 ) != "\" ) ПутьКФайлу+= "\";

GUID					= ЗАПРОС( "SELECT NEWID( )" );
ИмяФайла				= 'DP_REZRUISP_' + КлиентЭДОИД + '_' + ЭДОИНФО_ИДФирмы + "_" + DTOC( ДАТА( ), 7, "" ) + "_" + GUID;
Файл					= ФАЙЛСОЗДАТЬ( ПутьКФайлу + ИмяФайла + ".xml", 0 );

// Стандартный заголовок XML. Кодировка 1251
ФАЙЛЗАПИСАТЬСТРОКУ( Файл, "<?xml version=""1.0"" encoding=""windows-1251""?>" );
АТРИБУТЫИМЯ[ 0 ] 		= "ИдФайл";
АТРИБУТЫИМЯ[ 1 ] 		= "ВерсФорм";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ИмяФайла;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "5.02";
ЭДО.ЗаписатьНачалоТЭГа( Файл, 0, "Файл", 2 );
АТРИБУТЫИМЯ[ 0 ] 		= "ИдОтпр";
АТРИБУТЫИМЯ[ 1 ] 		= "ИдПол";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ЭДОИНФО_ИДФирмы;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= КлиентЭДОИД;
ЭДО.ЗаписатьНачалоТЭГа( Файл, 1, "СвУчДокОбор", 2 );
АТРИБУТЫИМЯ[ 0 ] 		= "НаимОрг";
АТРИБУТЫИМЯ[ 1 ] 		= "ИННЮЛ";
АТРИБУТЫИМЯ[ 2 ] 		= "ИдЭДО";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ЭДОИНФО_НаимОрг;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= ЭДОИНФО_ИННЮЛ;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= ЭДОИНФО_ИдЭДО;
ЭДО.ЗаписатьТЭГ( Файл, 2, "СвОЭДОтпр", "", 3 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 1, "СвУчДокОбор" );

АТРИБУТЫИМЯ[ 0 ] 		= "КНД";
АТРИБУТЫИМЯ[ 1 ] 		= "ДатаИнфИсп";
АТРИБУТЫИМЯ[ 2 ] 		= "ВремИнфИсп";
АТРИБУТЫИМЯ[ 3 ] 		= "НаимЭконСубСост";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "1175012";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= DTOC( ДАТА( ), 4, "." );
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= ALLTRIM( ЗАМЕНИТЬ( TTOC( ДАТА( ), 8 ), ":", "." ) );
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= Документ.firmname;
ЭДО.ЗаписатьНачалоТЭГа( Файл, 1, "Документ", 4 );
ЭДО.ЗаписатьНачалоТЭГа( Файл, 2, "СвДокПРУ", 0 );

АТРИБУТЫИМЯ[ 0 ] 		= "НаимДокОпр";
АТРИБУТЫИМЯ[ 1 ] 		= "ПоФактХЖ";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "Акт о передаче результатов работ (Акт об оказании услуг)";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "Документ о передаче результатов работ (Документ об оказании услуг)";
ЭДО.ЗаписатьТЭГ( Файл, 2, "НаимДок", "", 2 );

АТРИБУТЫИМЯ[ 0 ] 		= "ДатаДокПРУ";
АТРИБУТЫИМЯ[ 1 ] 		= "НомДокПРУ";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= DTOC( Документ.date, 4, "." );
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.ndok;
ЭДО.ЗаписатьТЭГ( Файл, 2, "ИдентДок", "", 2 );

АТРИБУТЫИМЯ[ 0 ] 		= "КодОКВ";
АТРИБУТЫИМЯ[ 1 ] 		= "НаимОКВ";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "643";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "Российский рубль";
ЭДО.ЗаписатьТЭГ( Файл, 2, "ДенИзм", "", 2 );

ЭДО.ЗаписатьНачалоТЭГа( Файл, 2, "СодФХЖ1", 0 );
ЭДО.ЗаписатьТЭГ( Файл, 3, "ЗагСодОпер", "Мы, нижеподписавшиеся, представитель ИСПОЛНИТЕЛЯ, с одной стороны и представитель ЗАКАЗЧИКА с другой стороны, составили настоящий акт в том, что ИСПОЛНИТЕЛЬ выполнил, а ЗАКАЗЧИК принял следующие работы (услуги)", 0 );

////// Продавец
ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "Исполнитель", 0 );
ЭДО.ВыгрузитьИДСВАкт( Файл, Документ.firminn, Документ.firmkpp, Документ.firmname, Документ.firmfirstname, Документ.firmmidname, Документ.firmlastname );

ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "Адрес", 0 );
АТРИБУТЫИМЯ[ 0 ] 		= "Индекс";
АТРИБУТЫИМЯ[ 1 ] 		= "КодРегион";
АТРИБУТЫИМЯ[ 2 ] 		= "Город";
АТРИБУТЫИМЯ[ 3 ] 		= "Улица";
АТРИБУТЫИМЯ[ 4 ] 		= "Дом";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firmpostcode;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.firmregion;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= Документ.firmcity;
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= Документ.firmstreet;
АТРИБУТЫЗНАЧЕНИЕ[ 4 ] 	= Документ.firmbuilding;
ЭДО.ЗаписатьТЭГ( Файл, 5, "АдрРФ", "", 5 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 4, "Адрес" );

АТРИБУТЫИМЯ[ 0 ] 		= "Тлф";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firmtelefon;
ЭДО.ЗаписатьТЭГ( Файл, 5, "Контакт", "", 1 );

АТРИБУТЫИМЯ[ 0 ] 		= "НомерСчета";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.rs;
ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "БанкРекв", 1 );

АТРИБУТЫИМЯ[ 0 ] 		= "НаимБанк";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firmbankname;
АТРИБУТЫИМЯ[ 1 ] 		= "БИК";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.firmbankmfo;
ЭДО.ЗаписатьТЭГ( Файл, 5, "СвБанк", "", 2 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 4, "БанкРекв" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Исполнитель" );

////// Покупатель
ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "Заказчик", 0 );
ЭДО.ВыгрузитьИДСВАкт( Файл, Документ.clientinn, Документ.clientkpp, Документ.clientname, Документ.clientfirstname, Документ.clientmidname, Документ.clientlastname );

ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "Адрес", 0 );
АТРИБУТЫИМЯ[ 0 ] 		= "Индекс";
АТРИБУТЫИМЯ[ 1 ] 		= "КодРегион";
АТРИБУТЫИМЯ[ 2 ] 		= "Город";
АТРИБУТЫИМЯ[ 3 ] 		= "Улица";
АТРИБУТЫИМЯ[ 4 ] 		= "Дом";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.clientpostcode;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.clientregion;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= Документ.clientcity;
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= Документ.clientstreet;
АТРИБУТЫЗНАЧЕНИЕ[ 4 ] 	= Документ.clientbuilding;
ЭДО.ЗаписатьТЭГ( Файл, 5, "АдрРФ", "", 5 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Адрес" );

АТРИБУТЫИМЯ[ 0 ] 		= "Тлф";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.clienttelefon;
ЭДО.ЗаписатьТЭГ( Файл, 4, "Контакт", "", 1 );

АТРИБУТЫИМЯ[ 0 ] 		= "НомерСчета";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.clientrs;
ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "БанкРекв", 1 );

АТРИБУТЫИМЯ[ 0 ] 		= "НаимБанк";
АТРИБУТЫИМЯ[ 1 ] 		= "БИК";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.clientbankname;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.clientbankmfo;
ЭДО.ЗаписатьТЭГ( Файл, 5, "СвБанк", "", 2 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 4, "БанкРекв" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Заказчик" );

// Основание формируем по полю desc_ или договору, выбранному в документе
// Если основание в поле desc_, то дату основания указываем датой документа
АТРИБУТЫИМЯ[ 0 ] 	= "ДатаОсн";
АТРИБУТЫИМЯ[ 1 ] 	= "НаимОсн";
IF ( !ПУСТО( Документ.desc_ ) )
{
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= DTOC( Документ.date, 4, "." );
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.desc_;
} 
ELSE IF ( !ПУСТО( Документ.contract ) )
{
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= DTOC( ЗАПРОС( "SELECT date, name FROM sprcontract WHERE code = '" + Документ.contract + "'", "date" ), 4, "." );
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= ЗАПРОС( "", "name" );
}
ELSE
{
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "";
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "-";
}
ЭДО.ЗаписатьТЭГ( Файл, 5, "Основание", "", 2 );

ИтогоБезНДС				= 0.00;
ИтогоСумма				= 0.00;
ИтогоНДС				= 0.00;

ВЫБРАТЬКОНТЕКСТ( "Спецификация" );
ПЕРЕЙТИВНАЧАЛО( "Спецификация" );
WHILE ( !КОНЕЦКОНТЕКСТА( "Спецификация" ) )
{
	ИтогоБезНДС				+= Спецификация.sumwonds;
	ИтогоСумма				+= Спецификация.summa;
	ИтогоНДС				+= Спецификация.sumnds;
	ПРОПУСТИТЬ( 1, "Спецификация" );
}
АТРИБУТЫИМЯ[ 0 ] 		= "СтБезНДСИт";
АТРИБУТЫИМЯ[ 1 ] 		= "СтУчНДСИт";
АТРИБУТЫИМЯ[ 2 ] 		= "СумНДСИт";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= STR( ИтогоБезНДС, 16, 2 );
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= STR( ИтогоСумма, 16, 2 );
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= STR( ИтогоНДС, 16, 2 );
ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "ОписРабот", 3 );

ПЕРЕЙТИВНАЧАЛО( "Спецификация" );
WHILE ( !КОНЕЦКОНТЕКСТА( "Спецификация" ) )
{
	АТРИБУТЫИМЯ[ 0 ] 		= "Номер";
	АТРИБУТЫИМЯ[ 1 ] 		= "НаимРабот";
	АТРИБУТЫИМЯ[ 2 ] 		= "ОКЕИ";
	АТРИБУТЫИМЯ[ 3 ] 		= "Количество";
	АТРИБУТЫИМЯ[ 4 ] 		= "Цена";
	АТРИБУТЫИМЯ[ 5 ] 		= "СтоимБезНДС";
	АТРИБУТЫИМЯ[ 6 ] 		= "НалСт";
	АТРИБУТЫИМЯ[ 7 ] 		= "СтоимУчНДС";
	АТРИБУТЫИМЯ[ 8 ] 		= "СумНДС";
	АТРИБУТЫИМЯ[ 9 ] 		= "НаимЕдИзм";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Спецификация.npp;
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Спецификация.nnname;
	АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= ЗАПРОС( "SELECT ex_code FROM spredn WHERE code= '" + Спецификация.ed + "'" );
	АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= STR( Спецификация.kolp, 16, 3 );
	АТРИБУТЫЗНАЧЕНИЕ[ 4 ] 	= STR( Спецификация.cenawonds, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 5 ] 	= STR( Спецификация.sumwonds, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 6 ] 	= ЕСЛИ( Спецификация.procnds <> 0, STR( Спецификация.procnds ) + "%", "без НДС" );
	АТРИБУТЫЗНАЧЕНИЕ[ 7 ] 	= STR( Спецификация.summa, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 8 ] 	= STR( Спецификация.sumnds, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 9 ] 	= Спецификация.ed;
	ЭДО.ЗаписатьНачалоТЭГа( Файл, 5, "Работа", 10 );
	АТРИБУТЫИМЯ[ 0 ] 		= "Значен";
	АТРИБУТЫИМЯ[ 1 ] 		= "Идентиф";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= STR( Спецификация.cena, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "Цена";
	ЭДО.ЗаписатьТЭГ( Файл, 6, "ИнфПолеОписРабот", "", 2 );
	ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 5, "Работа" );
	
	ИтогоБезНДС				+= Спецификация.sumwonds;
	ИтогоСумма				+= Спецификация.summa;
	ИтогоНДС				+= Спецификация.sumnds;
	ПРОПУСТИТЬ( 1, "Спецификация" );
}
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 4, "ОписРабот" );
ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "ИнфПолФХЖ1", 0 );
АТРИБУТЫИМЯ[ 0 ] 		= "Значен";
АТРИБУТЫИМЯ[ 1 ] 		= "Идентиф";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "Да";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "СуммаВключаетНДС";
ЭДО.ЗаписатьТЭГ( Файл, 5, "ТекстИнф", "", 2 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 4, "ИнфПолФХЖ1" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "СодФХЖ1" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 2, "СвДокПРУ" );

УДАЛИТЬКОНТЕКСТ( "Спецификация" );
АТРИБУТЫИМЯ[ 0 ] 		= "СодОпер";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "Результаты работ переданы (услуги оказаны)";
ЭДО.ЗаписатьТЭГ( Файл, 2, "СодФХЖ2", "", 1 );

АТРИБУТЫИМЯ[ 0 ] 		= "ОблПолн";
АТРИБУТЫИМЯ[ 1 ] 		= "Статус";
АТРИБУТЫИМЯ[ 2 ] 		= "ОснПолнПодп";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "1";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "1";
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= "Должностные обязанности";
ЭДО.ЗаписатьНачалоТЭГа( Файл, 2, "Подписант", 3 );
IF ( LEN( Документ.firminn ) == 12 )
{
	АТРИБУТЫИМЯ[ 0 ] 		= "ИННФЛ";
	АТРИБУТЫИМЯ[ 1 ] 		= "СвГосРегИП";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firminn;
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.firmogrn;
	ЭДО.ЗаписатьНачалоТЭГа( Файл, 2, "ИП", 2 );

	АТРИБУТЫИМЯ[ 0 ] 		= "Фамилия";
	АТРИБУТЫИМЯ[ 1 ] 		= "Имя";
	АТРИБУТЫИМЯ[ 2 ] 		= "Отчество";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ПОДПИСАНТФАМИЛИЯ;
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= ПОДПИСАНТИМЯ;
	АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= ПОДПИСАНТОТЧЕСТВО;
	ЭДО.ЗаписатьТЭГ( Файл, 4, "ФИО", "", 3 );
	ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "ИП" );
}
ELSE
{
	АТРИБУТЫИМЯ[ 0 ] 		= "ИННЮЛ";
	АТРИБУТЫИМЯ[ 1 ] 		= "НаимОрг";
	АТРИБУТЫИМЯ[ 2 ] 		= "Должн";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firminn;
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.firmname;
	АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= ПОДПИСАНТДОЛЖНОСТЬ;
	ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "ЮЛ", 3 );

	АТРИБУТЫИМЯ[ 0 ] 		= "Фамилия";
	АТРИБУТЫИМЯ[ 1 ] 		= "Имя";
	АТРИБУТЫИМЯ[ 2 ] 		= "Отчество";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ПОДПИСАНТФАМИЛИЯ;
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= ПОДПИСАНТИМЯ;
	АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= ПОДПИСАНТОТЧЕСТВО;
	ЭДО.ЗаписатьТЭГ( Файл, 4, "ФИО", "", 3 );
	ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "ЮЛ" );
}
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 2, "Подписант" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 1, "Документ" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 0, "Файл" );


УДАЛИТЬКОНТЕКСТ( "Документ" );
ФАЙЛЗАКРЫТЬ( Файл );
RETURN ПутьКФайлу + ИмяФайла + ".xml";
