IF ( !ЭДО.ПрочитатьУПД( GUIDДокумента ) ) RETURN "";
ЭДО.ЭДОИНФОРМАЦИЯ( ПРЕДПРИЯТИЕ );
КодДокумента			= ЗАПРОС( "SELECT code, ic, cediid FROM edioutcome WHERE guid = '" + GUIDДокумента + "'", "code" );
ИДДокумента				= ЗАПРОС( "", "ic" );
КлиентЭДОИД 			= ЗАПРОС( "", "cediid" );

// К имени файла добавляем путь
ПОДПИСАНТИМЯ			= ЗАМЕНИТЬ( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIFIRSTNAME" + ПРЕДПРИЯТИЕ + "'" ), " ", "_" );
ПОДПИСАНТФАМИЛИЯ		= ЗАМЕНИТЬ( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDISURNAME" + ПРЕДПРИЯТИЕ + "'" ), " ", "_" );
ПОДПИСАНТОТЧЕСТВО		= ЗАМЕНИТЬ( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIMIDDLENAME" + ПРЕДПРИЯТИЕ + "'" ), " ", "_" );
ПОДПИСАНТДОЛЖНОСТЬ		= ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'EDI_EDIPOSITION" + ПРЕДПРИЯТИЕ + "'" );

ПутьКФайлу				= ПОКРУЖЕНИЯ( "TEMP" );
IF ( RIGHT( ПутьКФайлу, 1 ) != "\" ) ПутьКФайлу+= "\";

GUID					= ЗАПРОС( "SELECT NEWID( )" );
ИмяФайла				= 'ON_ORDER_' + КлиентЭДОИД + '_' + ЭДОИНФО_ИДФирмы + "_" + DTOC( ДАТА( ), 7, "" ) + "_" + GUID;
Файл					= ФАЙЛСОЗДАТЬ( ПутьКФайлу + ИмяФайла + ".xml", 0 );

// Стандартный заголовок XML. Кодировка 1251
ФАЙЛЗАПИСАТЬСТРОКУ( Файл, "<?xml version=""1.0"" encoding=""windows-1251""?>" );
АТРИБУТЫИМЯ[ 0 ] 		= "Имя";
АТРИБУТЫИМЯ[ 1 ] 		= "ВерсияФормата";
АТРИБУТЫИМЯ[ 2 ] 		= "ВерсПрог";
АТРИБУТЫИМЯ[ 3 ] 		= "Формат";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ИмяФайла;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "3.01";
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= "Айтида";
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= "Заказ";
ЭДО.ЗаписатьНачалоТЭГа( Файл, 0, "Файл", 4 );

АТРИБУТЫИМЯ[ 0 ] 		= "Дата";
АТРИБУТЫИМЯ[ 1 ] 		= "Номер";
АТРИБУТЫИМЯ[ 2 ] 		= "Срок";
АТРИБУТЫИМЯ[ 3 ] 		= "СрокВремя";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= DTOC( Документ.date, 4, "." );
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.ndok;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= DTOC( Документ.dat_end, 4, "." );
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= "00:00:00";
ЭДО.ЗаписатьНачалоТЭГа( Файл, 1, "Документ", 4 );

АТРИБУТЫИМЯ[ 0 ] 		= "КодОКВ";
АТРИБУТЫИМЯ[ 1 ] 		= "Название";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "643";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= "Рубль";
ЭДО.ЗаписатьТЭГ( Файл, 2, "Валюта", 2 );

ЭДО.ЗаписатьНачалоТЭГа( Файл, 2, "ТаблДетал", 0 );
ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "ИтогТабл", 0 );
АТРИБУТЫИМЯ[ 0 ] 		= "КодОКВ";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "643";
ЭДО.ЗаписатьТЭГ( Файл, 4, "Валюта", 1 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "ИтогТабл" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 2, "ТаблДетал" );

////// Поставщик
АТРИБУТЫИМЯ[ 0 ] 		= "GLN";
АТРИБУТЫИМЯ[ 1 ] 		= "Название";
АТРИБУТЫИМЯ[ 2 ] 		= "Роль";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ЗАПРОС( "SELECT barcode FROM sprclient WHERE code= '" + Документ.client + "'" );
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.clientname;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= "Поставщик";
ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "Поставщик", 3 );
ЭДО.ВыгрузитьИДСВ( Файл, Документ.clientinn, Документ.clientkpp, Документ.clientname, Документ.clientfirstname, Документ.clientmidname, Документ.clientlastname );

ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "Адрес", 0 );
АТРИБУТЫИМЯ[ 0 ] 		= "Индекс";
АТРИБУТЫИМЯ[ 1 ] 		= "КодРегион";
АТРИБУТЫИМЯ[ 2 ] 		= "Город";
АТРИБУТЫИМЯ[ 3 ] 		= "Улица";
АТРИБУТЫИМЯ[ 4 ] 		= "Дом";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.clientpostcode;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.clientregion;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= Документ.clientcity;
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= Документ.clientstreet;
АТРИБУТЫЗНАЧЕНИЕ[ 4 ] 	= Документ.clientbuilding;
ЭДО.ЗаписатьТЭГ( Файл, 5, "АдрРФ", "", 5 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 4, "Адрес" );

АТРИБУТЫИМЯ[ 0 ] 		= "Тлф";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.clienttelefon;
ЭДО.ЗаписатьТЭГ( Файл, 5, "Контакт", "", 1 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Поставщик" );

////// Покупатель
АТРИБУТЫИМЯ[ 0 ] 		= "GLN";
АТРИБУТЫИМЯ[ 1 ] 		= "Название";
АТРИБУТЫИМЯ[ 2 ] 		= "Роль";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.clientname;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= "Покупатель";
ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "Покупатель", 3 );
ЭДО.ВыгрузитьИДСВ( Файл, Документ.firminn, Документ.firmkpp, Документ.firmname, Документ.firmfirstname, Документ.firmmidname, Документ.firmlastname );

ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "Адрес", 0 );
АТРИБУТЫИМЯ[ 0 ] 		= "Индекс";
АТРИБУТЫИМЯ[ 1 ] 		= "КодРегион";
АТРИБУТЫИМЯ[ 2 ] 		= "Город";
АТРИБУТЫИМЯ[ 3 ] 		= "Улица";
АТРИБУТЫИМЯ[ 4 ] 		= "Дом";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firmpostcode;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.firmregion;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= Документ.firmcity;
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= Документ.firmstreet;
АТРИБУТЫЗНАЧЕНИЕ[ 4 ] 	= Документ.firmbuilding;
ЭДО.ЗаписатьТЭГ( Файл, 5, "АдрРФ", "", 5 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Адрес" );

АТРИБУТЫИМЯ[ 0 ] 		= "Тлф";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firmtelefon;
ЭДО.ЗаписатьТЭГ( Файл, 4, "Контакт", "", 1 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Покупатель" );

////// Грузополучатель
АТРИБУТЫИМЯ[ 0 ] 		= "GLN";
АТРИБУТЫИМЯ[ 1 ] 		= "Название";
АТРИБУТЫИМЯ[ 2 ] 		= "Роль";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= "";
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.clientname;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= "Грузополучатель";
ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "Грузополучатель", 3 );
ЭДО.ВыгрузитьИДСВ( Файл, Документ.firminn, Документ.firmkpp, Документ.firmname, Документ.firmfirstname, Документ.firmmidname, Документ.firmlastname );

ЭДО.ЗаписатьНачалоТЭГа( Файл, 4, "Адрес", 0 );
АТРИБУТЫИМЯ[ 0 ] 		= "Индекс";
АТРИБУТЫИМЯ[ 1 ] 		= "КодРегион";
АТРИБУТЫИМЯ[ 2 ] 		= "Город";
АТРИБУТЫИМЯ[ 3 ] 		= "Улица";
АТРИБУТЫИМЯ[ 4 ] 		= "Дом";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firmpostcode;
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= Документ.firmregion;
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= Документ.firmcity;
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= Документ.firmstreet;
АТРИБУТЫЗНАЧЕНИЕ[ 4 ] 	= Документ.firmbuilding;
ЭДО.ЗаписатьТЭГ( Файл, 5, "АдрРФ", "", 5 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Адрес" );

АТРИБУТЫИМЯ[ 0 ] 		= "Тлф";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= Документ.firmtelefon;
ЭДО.ЗаписатьТЭГ( Файл, 4, "Контакт", "", 1 );

ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "Грузополучатель" );

ИтогоБезНДС				= 0.00;
ИтогоСумма				= 0.00;
ИтогоНДС				= 0.00;
ИтогоКоличество			= 0.00;

ЭДО.ЗаписатьНачалоТЭГа( Файл, 2, "ТаблДок", 0 );
ПЕРЕЙТИВНАЧАЛО( "Спецификация" );
WHILE ( !КОНЕЦКОНТЕКСТА( "Спецификация" ) )
{
	АТРИБУТЫИМЯ[ 0 ] 		= "GTIN";
	АТРИБУТЫИМЯ[ 1 ] 		= "Код";
	АТРИБУТЫИМЯ[ 2 ] 		= "КодПокупателя";
	АТРИБУТЫИМЯ[ 3 ] 		= "КодПоставщика";
	АТРИБУТЫИМЯ[ 4 ] 		= "Кол_во";
	АТРИБУТЫИМЯ[ 5 ] 		= "Название";
	АТРИБУТЫИМЯ[ 6 ] 		= "ОКЕИ";
	АТРИБУТЫИМЯ[ 7 ] 		= "Сумма";
	АТРИБУТЫИМЯ[ 8 ] 		= "СуммаБезНал";
	АТРИБУТЫИМЯ[ 9 ] 		= "Цена";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= ЗАПРОС( "SELECT gtin FROM sprres WHERE code = '" + Спецификация.nn + "'" );
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= ЗАПРОС( "SELECT maincode FROM sprres WHERE code = '" + Спецификация.nn + "'" );
	АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= АТРИБУТЫЗНАЧЕНИЕ[ 1 ];
	АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= ЗАПРОС( "SELECT ex_code FROM sprres_clients WHERE code = '" + Спецификация.nn + "' AND client = '" + Документ.client + "'" );
	АТРИБУТЫЗНАЧЕНИЕ[ 4 ] 	= STR( Спецификация.kolp, 16, 3 );
	АТРИБУТЫЗНАЧЕНИЕ[ 5 ] 	= Спецификация.nnname;
	АТРИБУТЫЗНАЧЕНИЕ[ 6 ] 	= ЗАПРОС( "SELECT ex_code FROM spredn WHERE code= '" + Спецификация.ed + "'" );
	АТРИБУТЫЗНАЧЕНИЕ[ 7 ] 	= STR( Спецификация.summa, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 8 ] 	= STR( Спецификация.sumwonds, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 9 ] 	= STR( Спецификация.cena, 16, 2 );
	
	ЭДО.ЗаписатьНачалоТЭГа( Файл, 3, "СтрТабл", 10 );
	АТРИБУТЫИМЯ[ 0 ] 		= "Ставка";
	АТРИБУТЫИМЯ[ 1 ] 		= "Сумма";
	АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= STR( Спецификация.procnds, 16, 2 );
	АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= STR( Спецификация.sumnds, 16, 2 );
	ЭДО.ЗаписатьТЭГ( Файл, 4, "НДС", "", 2 );

	ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 3, "СтрТабл" );
	
	ИтогоБезНДС				+= Спецификация.sumwonds;
	ИтогоСумма				+= Спецификация.summa;
	ИтогоНДС				+= Спецификация.sumnds;
	ИтогоКоличество			+= Спецификация.kolp;
	ПРОПУСТИТЬ( 1, "Спецификация" );
}
УДАЛИТЬКОНТЕКСТ( "Спецификация" );

АТРИБУТЫИМЯ[ 0 ] 		= "Кол_во";
АТРИБУТЫИМЯ[ 1 ] 		= "Сумма";
АТРИБУТЫИМЯ[ 2 ] 		= "СуммаБезНал";
АТРИБУТЫИМЯ[ 3 ] 		= "СуммаНДС";
АТРИБУТЫЗНАЧЕНИЕ[ 0 ] 	= STR( ИтогоКоличество, 16, 2 );
АТРИБУТЫЗНАЧЕНИЕ[ 1 ] 	= STR( ИтогоСумма, 16, 2 );
АТРИБУТЫЗНАЧЕНИЕ[ 2 ] 	= STR( ИтогоБезНДС, 16, 2 );
АТРИБУТЫЗНАЧЕНИЕ[ 3 ] 	= STR( ИтогоНДС, 16, 2 );
ЭДО.ЗаписатьТЭГ( Файл, 3, "ИтогТабл", "", 4 );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 2, "ТаблДок" );

ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 1, "Документ" );
ЭДО.ЗаписатьОкончаниеТЭГа( Файл, 0, "Файл" );


УДАЛИТЬКОНТЕКСТ( "Документ" );
ФАЙЛЗАКРЫТЬ( Файл );
RETURN ПутьКФайлу + ИмяФайла + ".xml";
