_ЕСТЬПАРАМЕТР = ЗАПРОС("SELECT code FROM sprparams WHERE name='КОДПОДТВЕРЖДЕНИЯ'");
IF (_ЕСТЬПАРАМЕТР==false OR ПУСТО(_ЕСТЬПАРАМЕТР))
{
	СООБЩЕНИЕ("Для работы функции подтверждения бонусов через СМС необходимо создать символьный параметр ""КОДПОДТВЕРЖДЕНИЯ"" в справочник параметров системы." + CHR(13) + CHR(10) +
		"Доступ к справочнику параметров системы возможен только из режима расширенного конфигурирования." + CHR(13) + CHR(10) + 
		"Свяжитесь с вашим системным администратором.", "Списание бонусов");
	RETURN 0;
}

//подтведржение списания бонусов через СМС
КодПодтверждения = СЛУЧАЙНОЕЧИСЛО(9999);
ТекстОтправки = КодПодтверждения + " - сообщите этот код кассиру для списания баллов.";
//Определим номер телефона по карте
//вариант 1 - клиент в карте
ТелефонКлиента = ЗАПРОС("SELECT telefon FROM sprmclient WHERE code = (SELECT client FROM sprmcard WHERE cardn = '" + НОМЕРКАРТЫ + "')");
//вариант 2 - карта в клиенте
IF ( ПУСТО( ТелефонКлиента ) )
	ТелефонКлиента = ЗАПРОС("SELECT telefon FROM sprmclient WHERE cardn = '" + НОМЕРКАРТЫ + "'");

//СпособОтправки = 3; //(число). Значения: 1 - SMS.RU; 2 - INFOSMS; 3 - SMSAERO; 4 - СМС ЦЕНТР

//отправка смс со случайным числом
//1. SMS.RU
IF ( СпособОтправки == 1 )
	ITIDASENDER.SMSRU_ОТПРАВКАСМС(ТелефонКлиента, ТекстОтправки);
//2. INFOSMS
IF ( СпособОтправки == 2 )
	ITIDASENDER.ИНФОСМС_ОТПРАВКАСМС(ТелефонКлиента, ТекстОтправки);
//3. SMSAERO
IF ( СпособОтправки == 3 )
	ITIDASENDER.СМСАЭРО_ОТПРАВКАСМС(ТелефонКлиента, ТекстОтправки);
//4. СМС ЦЕНТР
IF ( СпособОтправки == 4 )
	ITIDASENDER.СМСЦЕНТР_ОТПРАВКАСМС(ТелефонКлиента, ТекстОтправки);
	

//запрашиваем у кассира ввода числа и сравниваем с отправленным
РезультатВводаКассира = ОТПРАВИТЬСООБЩЕНИЕ( _ГЛАВНОЕОКНОПРИЛОЖЕНИЯ, _СООБЩЕНИЕВЫПОЛНИТЬКОМАНДУ,"ЗАПРОСПАРАМЕТРОВ", "'КОДПОДТВЕРЖДЕНИЯ'" );

IF ( РезультатВводаКассира <> КодПодтверждения )
{
	СООБЩЕНИЕ("Введен не правильный код подтверждения", "Списание бонусов");
	RETURN 0;
}


// Для продажи возвращается сумма остатка бонусов
// Для возврата сумма бонусов, бывших в оплате возвращаемого чека
IF ( _ОПЕРАЦИЯ != "ВОЗВРАТ" AND _ОПЕРАЦИЯ != "ВОЗВРАТПРИХОДА" )
	RETURN ЗАПРОС( "SELECT dbo.fn_calccard_bonus( '" + НОМЕРКАРТЫ + "', DEFAULT, DEFAULT )" );
RETURN ЗАПРОС( "SELECT bonus FROM chequelist WHERE identity_column= " + _ИДВОЗВРАЩАЕМОГОЧЕКА );
