ТекущаяДатаВремя = ДАТАВРЕМЯ();
ТекущаяДатаВремя = ДАТАВРЕМЯ();
ЧасНАЧАЛОРАССЫЛОК = 10; 
МинутаНАЧАЛОРАССЫЛОК = 0; 
ЧасОКОНЧАНИЕРАССЫЛОК = 20; 
МинутаОКОНЧАНИЕРАССЫЛОК = 0;

НомерЧаса = ЧАС(ТекущаяДатаВремя);
НомерМинуты = МИНУТА(ТекущаяДатаВремя);

//не рассылаем в нерабочие часы
IF (НомерЧаса < ЧасНАЧАЛОРАССЫЛОК OR НомерЧаса > ЧасОКОНЧАНИЕРАССЫЛОК)
	RETURN true;
	
КодСчетчикаДР = 10; //код счетчика, на который записывается информация о том, что клиенту уже начислили бонусы на день рождения
//СуммаБонусовНаДР = 100;
//СрокДействияДней = 10;
IF ( ПУСТО( ИМЯСЧЕТЧИКАБОНУСОВ ) )
	ИМЯСЧЕТЧИКАБОНУСОВ = "БОНУС";

//заполним контекст клиентами владельцами дисконтных карт (только с картами, которые не заблокированы и с действующим сроком)
ДОБАВИТЬКОНТЕКСТ("SELECT client.code AS clientcode, card.code AS cardcode, ISNULL(client.ctext, client.name) AS clientname, client.telefon, client.birthdate AS birthdate, client.clientgroup, client.cardn AS clientcardn,
client.sex, card.name AS cardname, card.cardn AS cardn, card.card_type, card.block, card.note AS cardnote, card.str_date, card.end_date
FROM sprmclient client
INNER JOIN sprmcard card ON client.code = card.client
WHERE client.folder = 0 AND client.notavail = 0 AND card.block <> 1 AND DATEDIFF(day, card.str_date, GETDATE()) >= 0 AND DATEDIFF(day, card.end_date, GETDATE()) <= 0", "КлиентыКарты");
ВЫБРАТЬКОНТЕКСТ("КлиентыКарты");
КоличествоНачислений = 0;
WHILE (!КОНЕЦКОНТЕКСТА("КлиентыКарты"))
{
	КодКарты = КлиентыКарты.cardcode;
	НомерКарты = КлиентыКарты.cardn;
	Телефон = STRTRANC(КлиентыКарты.telefon,"+","");
	ИмяКлиента = КлиентыКарты.clientname;
	
	ДатаРождения = КлиентыКарты.birthdate;
	ДатаРожденияМЕСЯЦ = МЕСЯЦ(ДатаРождения);
	ДатаРожденияДЕНЬ = ДЕНЬ(ДатаРождения);
	
	ТЕКУЩАЯДАТА = Дата();
	
	ТекущаяДатаДЕНЬ = ДЕНЬ(ТЕКУЩАЯДАТА);
	ТекущаяДатаМЕСЯЦ = МЕСЯЦ(ТЕКУЩАЯДАТА);
	ТекущаяДатаГОД = ГОД(ТЕКУЩАЯДАТА);
	
	ДАТАРОЖДЕНИЯСРАВНЕНИЕТЕКСТ = ALLTRIM(ДатаРожденияДЕНЬ) + "." + ALLTRIM(ДатаРожденияМЕСЯЦ) + "." + ALLTRIM(ТекущаяДатаГОД);
	ДАТАРОЖДЕНИЯСРАВНЕНИЕ = CTOD(ДАТАРОЖДЕНИЯСРАВНЕНИЕТЕКСТ);
	
	//условие - за 1 день до ДР начисляются 500 бонусов и действуют за 1д до ДР, в день ДР и 7 дней после
	//сроком управлять будет Фронтол, мы будем только начислять и отправлять смс тому, у кого ДР
	РазницаВДатах = DATEDIFF(ТЕКУЩАЯДАТА,ДАТАРОЖДЕНИЯСРАВНЕНИЕ, 'day');
	СООБЩЕНИЕ("Телефон = " + Телефон + " / КодКарты = " + КодКарты + " / НомерКарты = " + НомерКарты + " / ИмяКлиента = " + ИмяКлиента);
	СООБЩЕНИЕ("РазницаВДатах = " + РазницаВДатах + " / ДатаРождения = " + ДатаРождения + " / ТЕКУЩАЯДАТА = " + ТЕКУЩАЯДАТА + " / ДАТАРОЖДЕНИЯСРАВНЕНИЕ = " + ДАТАРОЖДЕНИЯСРАВНЕНИЕ);
	//СООБЩЕНИЕ("ДАТАРОЖДЕНИЯСРАВНЕНИЕ: " + ALLTRIM(ДАТАРОЖДЕНИЯСРАВНЕНИЕ) + CHR(13) + CHR(10) + "Дата текстом: " + ДАТАРОЖДЕНИЯСРАВНЕНИЕТЕКСТ + CHR(13) + CHR(10) + "Разница с текущей датой (дней): " + РазницаВДатах);
	IF ( РазницаВДатах >= -1 AND РазницаВДатах <= 1 ) // РазницаВДатах == 0
	{	
		ДОБАВИТЬКОНТЕКСТ("SELECT * FROM specmcard_counters WHERE cardn= '" + STDF( НомерКарты ) + "' AND counter = '" + КодСчетчикаДР + "'", "ДанныеПоНачислениям", 1);
		ВЫБРАТЬКОНТЕКСТ("ДанныеПоНачислениям");
		IF ( КОЛИЧЕСТВОСТРОК("ДанныеПоНачислениям") > 0 )
		{
			ДатаИзменения = ДанныеПоНачислениям.edit_dat;
			ДатаИзмененияГОД = ГОД(ДатаИзменения);
			ДатаИзмененияМЕСЯЦ = МЕСЯЦ(ДатаИзменения);
			ДатаИзмененияДЕНЬ = ДЕНЬ(ДатаИзменения);
			//если в этом году начисляли, то пропускаем
			IF ( ДатаИзмененияГОД == ТекущаяДатаГОД )
			{
				СООБЩЕНИЕ("Пропускаем клиента. т.к. уже было начисление на ДР в этом году");
				УДАЛИТЬКОНТЕКСТ("ДанныеПоНачислениям");
				ВЫБРАТЬКОНТЕКСТ("КлиентыКарты");
				ПРОПУСТИТЬ( 1, "КлиентыКарты");
				CONTINUE;
			}
		}
		
		КоличествоНачислений++;
		// Обновляем информацию о начислениях и бонусах
		ЗАПРОС("DELETE FROM specmcard_counters WHERE cardn= '" + STDF( НомерКарты ) + "' AND counter = '" + КодСчетчикаДР + "'" );
		// Добавляем сумму к начислению к общей сумме начислений и сумму бонуса к общей сумме бонусов
		ЗАПРОС("INSERT INTO specmcard_counters (cardn, date, counter, summa )
			   VALUES ('" + STDF( НомерКарты ) + "', '', '" + КодСчетчикаДР + "', " + STR( СуммаБонусовНаДР, 20, 8 ) + ")");
			   
		ДатаСгоранияБонусов = ДОБАВИТЬДНИ(ДАТАРОЖДЕНИЯСРАВНЕНИЕ, СрокДействияДней);
		ЗАПРОС("EXEC sp_bonuscharge '" + НомерКарты + "', '" + ИМЯСЧЕТЧИКАБОНУСОВ + "', " + СуммаБонусовНаДР + ", 1, '" + ДАТАВРЕМЯ() + "', '" + ДАТАРОЖДЕНИЯСРАВНЕНИЕ + "', '" + ДатаСгоранияБонусов + "'");
				
		//оповестим пользователя о начислении бонусов
		ТекстСообщения = ЕСЛИ( !ПУСТО(ИмяКлиента), ALLTRIM(ИмяКлиента) + " ", "")  + "C Днём Рождения! Дарим " + СуммаБонусовНаДР + " бонусов. Они сгорят " + ДатаСгоранияБонусов;
		СООБЩЕНИЕ("Сообщение для отправки = " + ТекстСообщения);
				
		//1. SMS.RU
		IF ( СпособОтправки == 1 )
			ITIDASENDER.SMSRU_ОТПРАВКАСМС(Телефон, ПЕРЕКОДИРОВАТЬ(ТекстСообщения, "ANSI", "UTF-8"));
		//2. INFOSMS
		IF ( СпособОтправки == 2 )
			ITIDASENDER.ИНФОСМС_ОТПРАВКАСМС(Телефон, ПЕРЕКОДИРОВАТЬ(ТекстСообщения, "ANSI", "UTF-8"));
		//3. SMSAERO
		IF ( СпособОтправки == 3 )
			ITIDASENDER.СМСАЭРО_ОТПРАВКАСМС(Телефон, ПЕРЕКОДИРОВАТЬ(ТекстСообщения, "ANSI", "UTF-8"));
		//4. СМС ЦЕНТР
		IF ( СпособОтправки == 4 )
			ITIDASENDER.СМСЦЕНТР_ОТПРАВКАСМС(Телефон, ПЕРЕКОДИРОВАТЬ(ТекстСообщения, "ANSI", "UTF-8"));
		
		УДАЛИТЬКОНТЕКСТ("ДанныеПоНачислениям");
		ВЫБРАТЬКОНТЕКСТ("КлиентыКарты");
	}
	ПРОПУСТИТЬ( 1, "КлиентыКарты");
}
IF (КоличествоНачислений == 0)
	СООБЩЕНИЕ("Нет клиентов с ближайшими ДР для рассылки СМС");
ELSE
	СООБЩЕНИЕ("Отправлено " + КоличествоНачислений + " СМС");
	
RETURN true;
