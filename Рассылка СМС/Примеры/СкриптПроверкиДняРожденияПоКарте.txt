/*
Переменная _ПРОЦЕНТСКИДКИНАДЕНЬРОЖДЕНИЯ определяется в скрипте создания нового чека в схеме РМК.
Ниже текст для вставки в скрипт:

//Начало объявления и инициализации переменной
PUBLIC _ПРОЦЕНТСКИДКИНАДЕНЬРОЖДЕНИЯ;
_ПРОЦЕНТСКИДКИНАДЕНЬРОЖДЕНИЯ = 0;
//Конец объявления и инициализации переменной

Далее в карточке скидки в скрипте расчета значения скидки указывается следующее выражение.

//начало
_СУММАПРОДАЖИ = cena * kolp;
IF ( TYPE( "_ПРОЦЕНТСКИДКИНАДЕНЬРОЖДЕНИЯ" ) == "U" )
	RETURN 0;
	
RETURN ROUND(_СУММАПРОДАЖИ * _ПРОЦЕНТСКИДКИНАДЕНЬРОЖДЕНИЯ / 100, 0);
//конец

Тип скидки: -$ (минус сумма).
Назначение скидки: позиция
Тип: автоматическая

*/

КАРТАКЛИЕНТА = "";
IF ( UPPER( ALLTRIM( _ИМЯПОЛЯ ) ) == "CLIENT" )
	КАРТАКЛИЕНТА = ЗАПРОС("SELECT cardn FROM sprmclient WHERE code = '" + STDF( _ЗНАЧЕНИЕПОЛЯ ) + "'");
ELSE IF ( UPPER( ALLTRIM( _ИМЯПОЛЯ ) ) == "CARDN" )
	КАРТАКЛИЕНТА = _ЗНАЧЕНИЕПОЛЯ;

IF ( !ПУСТО( КАРТАКЛИЕНТА ) )
{
	РАЗНИЦАВДНЯХДЛЯСКИДКИ = 5;
	ЕстьДР = false;	
	СписокДнейРождения = "";
	СимвПС = CHR(13) + CHR(10);
		
	ДОБАВИТЬКОНТЕКСТ("SELECT cl.code, cl.name, cl.birthdate AS birthdate0, 
							dbo.fn_getdatetime_ex('SPR', 'S6D', 'ДеньРождения1', cl.code, '', '', '') AS birthdate1,
							dbo.fn_getdatetime_ex('SPR', 'S6D', 'ДеньРождения2', cl.code, '', '', '') AS birthdate2,
							dbo.fn_getdatetime_ex('SPR', 'S6D', 'ДеньРождения3', cl.code, '', '', '') AS birthdate3,
							dbo.fn_getdatetime_ex('SPR', 'S6D', 'ДеньРождения4', cl.code, '', '', '') AS birthdate4
						FROM sprmclient cl 
						WHERE cl.cardn = '" + STDF( КАРТАКЛИЕНТА ) + "'", "ДниРождения");
						
	ВЫБРАТЬКОНТЕКСТ("ДниРождения");
	WHILE ( !КОНЕЦКОНТЕКСТА("ДниРождения") )
	{		
		IF ( ITIDASENDER.ДАТАРОЖДЕНИЯВХОДИТВДИАПАЗОН( ДниРождения.birthdate0, РАЗНИЦАВДНЯХДЛЯСКИДКИ, РАЗНИЦАВДНЯХДЛЯСКИДКИ, @СписокДнейРождения ) )
			ЕстьДР = true;
		IF ( ITIDASENDER.ДАТАРОЖДЕНИЯВХОДИТВДИАПАЗОН( ДниРождения.birthdate1, РАЗНИЦАВДНЯХДЛЯСКИДКИ, РАЗНИЦАВДНЯХДЛЯСКИДКИ, @СписокДнейРождения ) )
			ЕстьДР = true;
		IF ( ITIDASENDER.ДАТАРОЖДЕНИЯВХОДИТВДИАПАЗОН( ДниРождения.birthdate2, РАЗНИЦАВДНЯХДЛЯСКИДКИ, РАЗНИЦАВДНЯХДЛЯСКИДКИ, @СписокДнейРождения ) )
			ЕстьДР = true;
		IF ( ITIDASENDER.ДАТАРОЖДЕНИЯВХОДИТВДИАПАЗОН( ДниРождения.birthdate3, РАЗНИЦАВДНЯХДЛЯСКИДКИ, РАЗНИЦАВДНЯХДЛЯСКИДКИ, @СписокДнейРождения ) )
			ЕстьДР = true;
		IF ( ITIDASENDER.ДАТАРОЖДЕНИЯВХОДИТВДИАПАЗОН( ДниРождения.birthdate4, РАЗНИЦАВДНЯХДЛЯСКИДКИ, РАЗНИЦАВДНЯХДЛЯСКИДКИ, @СписокДнейРождения ) )
			ЕстьДР = true;
		
		ПРОПУСТИТЬ( 1, "ДниРождения");
	}
	УДАЛИТЬКОНТЕКСТ("ДниРождения");
	
	IF ( ЕстьДР AND !(ПУСТО( СписокДнейРождения ) ) )
	{
		_ПРОЦЕНТСКИДКИНАДЕНЬРОЖДЕНИЯ = 15;
		
		ТекстПоздравления = "С днём рождения!" + СимвПС;
		ТекстПоздравления += "Ближайшие даты рождения: " + СимвПС;
		ТекстПоздравления += СписокДнейРождения;
		СООБЩЕНИЕ(ТекстПоздравления, "Поздравление");
	}
}

RETURN ПЕРЕМЕННАЯ( "_ПРОЦЕНТСКИДКИНАДЕНЬРОЖДЕНИЯ", 0 );
