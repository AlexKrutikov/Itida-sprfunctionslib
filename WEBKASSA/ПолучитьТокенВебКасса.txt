//берем значения Логин и Пароль из карточки ТО1
ЛогинWebKassa = ALLTRIM( ЗАПРОС("SELECT login FROM sprequipment WHERE code= '" + КОДОБОРУДОВАНИЯ + "'" ) );
ПарольWebKassa = ALLTRIM( ЗАПРОС("SELECT password FROM sprequipment WHERE code= '" + КОДОБОРУДОВАНИЯ + "'" ) );
//если данные не заполнены, то ничего не делаем
IF (ПУСТО(ЛогинWebKassa) OR ПУСТО(ПарольWebKassa))
{
	RETURN false;
}
//проверим наличие полученного ранее токена
ПолучаемНовыйТокен	= false;
//получаем токен с датой редактирования менее суток (срок жизни токена равен 24 часам)
ТокенВебКассы		= ЗАПРОС("SELECT value FROM param_ex WHERE param = 'WEBKASSA_TOKEN" + ALLTRIM(КОДОБОРУДОВАНИЯ) + "' AND DATEDIFF(day,edit_dat,GETDATE()) < 1");
IF ( ПУСТО(ТокенВебКассы) )
{
	//если токен не нашли в параметрах или данные в параметрах устарели, то нужен новый токен
	ПолучаемНовыйТокен = true;
}
ELSE
{
	СИСТЕМНОЕСООБЩЕНИЕ("Соединение с https://devkkm.webkassa.kz. Проверка токена.");
	//для проверки токена получим список касс
	Соединение		= HTTPCONNECT( "https://devkkm.webkassa.kz", 443, true);
	Заголовки[ 0 ]	= "Content-Type:application/json";
	АдресРесурса	= "/api/Cashboxes";
	
	ТелоЗапроса		= "{""Token"": """ + ТокенВебКассы + """}";
	Ответ			= HTTPPOST(Соединение, АдресРесурса, ТелоЗапроса, "Заголовки");
	JSONстрока		= ПЕРЕКОДИРОВАТЬ( Ответ, "UTF-8", "ANSI" );
	Data = "";
	Errors = "";
	ЗАГРУЗИТЬJSON( "json", JSONСтрока );
	ВЫБРАТЬКОНТЕКСТ("json");
	IF ( ЧИТАТЬЗАПИСЬ("json") )
	{
		//если в структуре json вернулась не пустая структура Error, то значит есть ошибки и вероятнее всего на данном этапе они из-за токена
		ЕстьОшибки = !ПУСТО(Errors) OR ПУСТО(Data);
		IF (ЕстьОшибки == true)
		{
			ПолучаемНовыйТокен = true;
		}
	}
	ELSE
	{
		ПолучаемНовыйТокен = true;
	}
	УДАЛИТЬКОНТЕКСТ("json");
}
IF (ПолучаемНовыйТокен)
{
	СИСТЕМНОЕСООБЩЕНИЕ("Соединение с https://devkkm.webkassa.kz. Получение токена.");
	ТокенВебКассы	= "";
	Соединение		= HTTPCONNECT( "https://devkkm.webkassa.kz", 443, true);
	Заголовки[ 0 ]	= "Content-Type:application/json";
	АдресРесурса	= "/api/Authorize";
	
	ТелоЗапроса		= "{""Login"": """ + ЛогинWebKassa + """, ""Password"": """ + ПарольWebKassa + """}";
	Ответ			= HTTPPOST(Соединение, АдресРесурса, ТелоЗапроса, "Заголовки");
	JSONстрока		= ПЕРЕКОДИРОВАТЬ( Ответ, "UTF-8", "ANSI" );
	ЗАГРУЗИТЬJSON( "json", JSONСтрока );
	ЗАГРУЗИТЬJSON( "Данные", json.Data );
	
	WHILE (!КОНЕЦКОНТЕКСТА("Данные"))
	{
		IF (!ПУСТО(Данные.Token))
		{
			ТокенВебКассы = Данные.Token;			
		}
		ПРОПУСТИТЬ( 1, "Данные"  );
	}
	IF ( !ПУСТО(ТокенВебКассы) )
	{
		ЕстьПараметр = !( ПУСТО( ЗАПРОС("SELECT value FROM param_ex WHERE param = 'WEBKASSA_TOKEN" + ALLTRIM(КОДОБОРУДОВАНИЯ) + "'") ) );
		IF (ЕстьПараметр)
			ЗАПРОС("UPDATE param_ex SET value = '" + ALLTRIM(ТокенВебКассы) + "' WHERE param = 'WEBKASSA_TOKEN" + ALLTRIM(КОДОБОРУДОВАНИЯ) + "'");
		ELSE
			ЗАПРОС("INSERT INTO param_ex (param, value) VALUES ('WEBKASSA_TOKEN" + ALLTRIM(КОДОБОРУДОВАНИЯ) + "', '" + ALLTRIM(ТокенВебКассы) + "')");
	}
	УДАЛИТЬКОНТЕКСТ("Данные");
	УДАЛИТЬКОНТЕКСТ("json");
}
СИСТЕМНОЕСООБЩЕНИЕ( );
RETURN true;
