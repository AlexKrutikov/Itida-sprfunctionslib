IF ( ПУСТО( КОДОБОРУДОВАНИЯ ) )
{
	СООБЩЕНИЕ( "Ошибка работы с ФР (" + МестоВызова + ")." + CHR( 13 ) +"Не определен код оборудования", "Ошибка работы с ККМ" );
	RETURN false;
}

//IF ( TYPE( "_КЛЮЧ_СЕССИИ" ) == "U" )
//	_КЛЮЧ_СЕССИИ = "";

IF ( !ПУСТО( _МАССИВКЛЮЧЕЙФР[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ]  ) )
	RETURN true;
	
ПоловинаУстройств = ЦЕЛОЕ( ФР.МЕРКУРИЙФР_КоличествоУстройств() / 2 );

IF (TYPE("НОМЕРУСТРОЙСТВА") == "U")
	НОМЕРУСТРОЙСТВА = ЗАПРОС("SELECT devicenumber FROM sprequipment WHERE code = '" + КОДОБОРУДОВАНИЯ + "'");

НомерПорта			= ЕСЛИ(НОМЕРУСТРОЙСТВА > ПоловинаУстройств, НОМЕРУСТРОЙСТВА - ПоловинаУстройств, НОМЕРУСТРОЙСТВА);
МОДЕЛЬУСТРОЙСТВА	= ЕСЛИ(НОМЕРУСТРОЙСТВА > ПоловинаУстройств, "119F", "185F");
СерийныйНомер		= ЗАПРОС("SELECT serialnumber FROM sprequipment WHERE code = '" + КОДОБОРУДОВАНИЯ + "'");

Команда = ДАННЫЕ_JSON("command", "OpenSession");
Порт = ДАННЫЕ_JSON("portName", "COM" + НОМЕРУСТРОЙСТВА );
Скорость = ДАННЫЕ_JSON("baudRate", 115200 );
Модель = ДАННЫЕ_JSON("model", МОДЕЛЬУСТРОЙСТВА );
СН = ДАННЫЕ_JSON("serialNumber", СерийныйНомер );

Отладка = ДАННЫЕ_JSON("debug", true );
ПутьКЛогу = ДАННЫЕ_JSON("logPath", ФР.МЕРКУРИЙФР_ФАЙЛЖУРНАЛА() );

ТекстЗапроса = "{ ""sessionKey"": null, " + Команда + ", " + Порт + ", " + Скорость + ", " + Модель + ", " + СН + ", " + Отладка + ", " + ПутьКЛогу + " }";

ОТВЕТ = "";
IF ( !ФР.МЕРКУРИЙФР_HTTPPOST( ФР.МЕРКУРИЙФР_АДРЕССЕРВЕРА(), "/api.json", ТекстЗапроса, "", @ОТВЕТ) )
	RETURN false;
	
IF ( ПУСТО( ОТВЕТ) )
{
	ТекстСообщения		= "ФР Меркурий: Ошибка получения ключа сессии";
	СООБЩЕНИЕ(ТекстСообщения);
	RETURN false;
}

ЗАГРУЗИТЬJSON( "ДанныеОтвета", ПЕРЕКОДИРОВАТЬ( ОТВЕТ, "UTF-8", "ANSI" ) );

//_МАССИВ_КЛЮЧЕЙСЕССИИ[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ] = ALLTRIM( ЗНАЧЕНИЕПОЛЯ( "ДанныеОтвета", "sessionKey" ) );
_КЛЮЧ_СЕССИИ = ALLTRIM( ЗНАЧЕНИЕПОЛЯ( "ДанныеОтвета", "sessionKey", "" ) );
IF ( ПУСТО( _КЛЮЧ_СЕССИИ ) )
{
	ТекстСообщения		= "ФР Меркурий: Ошибка получения ключа сессии";
	СООБЩЕНИЕ(ТекстСообщения);
	RETURN false;
}
_МАССИВКЛЮЧЕЙФР[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ]  = _КЛЮЧ_СЕССИИ;

RETURN true;
