
// Печать Z-отчета
// Параметр - FROperatorProfile число, профиль из карточки сотрудника
ТекстВопроса = "Вы действительно хотите снять Z-отчет?";
IF ( СООБЩЕНИЕ( ТекстВопроса, "ВОПРОС", 4 ) == 7 ) //если нажали "Нет"
	RETURN false;
	
IF ( !ФР.МЕРКУРИЙФР_ОткрытьСессию( КОДОБОРУДОВАНИЯ, "Z-отчет" ) ) RETURN false;
	
//получим информацию о кассире
_ИМЯКАССИРА		= "";
_ИННКАССИРА		= "";
IF ( !ФР.МЕРКУРИЙФР_ПолучитьДанныеКассира(froperator, @_ИМЯКАССИРА, @_ИННКАССИРА) )
	_ИМЯКАССИРА = "Кассир";

//ДОПОЛНИТЕЛЬНЫЕ ПРОВЕРКИ ПЕРЕД ЗАКРЫТИЕМ СМЕНЫ
//Проверим статус смены в ККМ
ОтветСостояниеККТ 	= ФР.МЕРКУРИЙФР_ПолучениеСостоянияККТ( );
		
СостояниеСмены 		= ПОЛЕ_JSON( ПОЛЕ_JSON( ОтветСостояниеККТ, "shiftInfo", "" ), "isOpen", "" ) == "true";
Состояние24Часа		= ПОЛЕ_JSON( ПОЛЕ_JSON( ОтветСостояниеККТ, "shiftInfo", "" ), "is24Expired", "" ) == "true";

СменаОткрыта 		= СостояниеСмены == true OR Состояние24Часа == true OR СостояниеСмены == "true" OR Состояние24Часа =="true";

IF ( !СменаОткрыта )
{
	СООБЩЕНИЕ( "Смена закрыта в ККМ" );
	RETURN true;
}

//КОНЕЦ ДОПОЛНИТЕЛЬНЫХ ПРОВЕРОК ПЕРЕД ЗАКРЫТИЕМ СМЕНЫ

Команда = ДАННЫЕ_JSON("command", "CloseShift");
ПечататьДокумент = ДАННЫЕ_JSON("printDoc", true);
КассирИмя = ДАННЫЕ_JSON("cashierName", _ИМЯКАССИРА );
КассирИНН = ДАННЫЕ_JSON("cashierINN", _ИННКАССИРА);

ТекстЗапроса = "{ 
	""sessionKey"": """ + _МАССИВКЛЮЧЕЙФР[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ] + """, 
	" + Команда + ", 
	" + ПечататьДокумент + ", 
	""cashierInfo"": {	
		" + КассирИмя + ", 
		" + КассирИНН + " 
	} 
}";

ОТВЕТ = "";

IF ( !ФР.МЕРКУРИЙФР_HTTPPOST(ФР.МЕРКУРИЙФР_АДРЕССЕРВЕРА(), "/api.json", ТекстЗапроса, "", @ОТВЕТ) )
{
	ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "ZОтчет" );
	RETURN false;
}

IF ( !ПУСТО( ОТВЕТ ) )
{
	НомерСменыККМ = VAL( ПОЛЕ_JSON( ОТВЕТ, "shiftNum", "") );
	
	IF ( !ПУСТО ( НомерСменыККМ ) )
		ЗАПРОС( "UPDATE sprequipment SET ecrsession = " + (НомерСменыККМ + 1) + " WHERE code = '" + ФР.КОДОБОРУДОВАНИЯ() + "'" );
}

//Проверим возраст буфера чеков
ФР.МЕРКУРИЙФР_ПроверкаВозрастаБуфера( );		

RETURN ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "ZОтчет" );
