
//подключаемся к ККТ
IF ( !ФР.МЕРКУРИЙФР_ОткрытьСессию( КОДОБОРУДОВАНИЯ, "Получение результата проверки" ) ) RETURN false;

ПроверкаЗавершена = false;
Команда = ДАННЫЕ_JSON("command", "GetMarkingCodeCheckResult");
ТекстЗапросаРезультатФоновойПроверки = "{ ""sessionKey"": """ + _МАССИВКЛЮЧЕЙФР[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ] + """, " + Команда + " }";
КонецОжидания = TICKCOUNT() + ТАЙМАУТ;
JSONРезультатФоновойПроверкиКМ = "";

WHILE (!ПроверкаЗавершена AND TICKCOUNT() < КонецОжидания)
{
	IF ( TICKCOUNT() % 1000 == 0 )
	{
		ОТВЕТ = "";

		IF ( !ФР.МЕРКУРИЙФР_HTTPPOST( ФР.МЕРКУРИЙФР_АДРЕССЕРВЕРА(), "/api.json", ТекстЗапросаРезультатФоновойПроверки, "", @ОТВЕТ ) )
		{
			ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "Получение результата проверки" );
			УДАЛИТЬКОНТЕКСТ("НовыеКомандыЧека");
			УДАЛИТЬКОНТЕКСТ("ПозицииЧека");
			RETURN false;
		}

		JSONРезультатГотов = ПОЛЕ_JSON( ОТВЕТ, "isCompleted", false);
		ПроверкаЗавершена = (JSONРезультатГотов == true) OR (JSONРезультатГотов == "true");
		
		IF ( ПроверкаЗавершена )
		{
			JSONРезультатФоновойПроверкиКМ	= ОТВЕТ;
			//JSONРезультатФоновойПроверкиКМ	= ПОЛЕ_JSON( ОТВЕТ, "onlineCheck", "");
		}
	}
}

RETURN JSONРезультатФоновойПроверкиКМ;
