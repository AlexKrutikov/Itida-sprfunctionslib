//"ПечатьЧекаНаФР" - функция, которая будет заниматься формирование чека в формате JSON для его последующей отправки в ККМ
IF ( !ФР.МЕРКУРИЙФР_ОткрытьСессию( КОДОБОРУДОВАНИЯ, "Печать чека" ) ) RETURN false;

ТекстЧека 		= "";
ЗаголовокЧека	= "";
ПозицииЧека		= "";
СтрокиОплатЧека = "";
ФискальныйЧек	= true; 	//Признак фискального чека
	
ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяТаблицыСтрокЧека + " ORDER BY identity_column", "КомандыЧека" );
WHILE ( !КОНЕЦКОНТЕКСТА( "КомандыЧека" ) )
{
	IF ( КомандыЧека.operation == "ЕГАИС слип" )
	{
		IF ( !ФР.МЕРКУРИЙФР_ПечатьСлипаЕГАИС( ) ) RETURN false;
	}
	IF ( КомандыЧека.operation == "Открыть чек" )
	{
		IF ( КомандыЧека.checktype == "ПРЕЧЕК" )
		{
			_ERROR = false;
		}
		ELSE
		{
			IF ( !ФР.МЕРКУРИЙФР_ОткрытьЧекВККМ( ) ) RETURN false;
		}
	}
	ELSE IF ( КомандыЧека.operation == "Печать строки" )
	{
		IF ( !ФР.МЕРКУРИЙФР_ПечатьСтроки( КомандыЧека.name ) ) RETURN false;
	}
	ELSE IF ( КомандыЧека.operation == "Регистрация" OR КомандыЧека.operation == "Возврат" )
	{
		IF ( КомандыЧека.checktype == "ПРЕЧЕК" )
		{
			IF ( !ФР.МЕРКУРИЙФР_ПечатьСтроки( КомандыЧека.name ) ) RETURN false;
		}
		ELSE
		{
			IF ( !ФР.МЕРКУРИЙФР_РегистрацияПозицииВККТ( ) ) RETURN false;
		}
	}					
	ELSE IF ( КомандыЧека.operation == "Оплата" )
	{
		КоэффициентСумм = 100;
		СтрокаОплаты = ДАННЫЕ_JSON( КомандыЧека.closetype, VAL( STR( КомандыЧека.price * КоэффициентСумм, 16, 0) ) );
		СтрокиОплатЧека += ЕСЛИ(!ПУСТО(СтрокиОплатЧека),",","") + СтрокаОплаты;
	}	
	ELSE IF ( КомандыЧека.operation == "Закрытие чека" )
	{	
		
		IF ( КомандыЧека.checktype <> "ПРЕЧЕК" )
		{
			//добавим информацию о бонусах в чек
			ТекстБонусов = "";
			НомерКартыНаПечать = "";
			IF ( TYPE( "НОМЕРКАРТЫ" ) <> "U" )
				НомерКартыНаПечать = НОМЕРКАРТЫ;
				
			IF ( ПЕРЕМЕННАЯ( "_ВЫВОДИТЬИНФОРМАЦИЮОБОНУСАХНАЧЕКЕ", true ) == true AND !ПУСТО( НомерКартыНаПечать ) )
			{
				IF ( !ФР.МЕРКУРИЙФР_ТекстБонусов() )
					RETURN false;			
			}
			
			//выведем информацию о скидке на чек
			IF ( ПЕРЕМЕННАЯ( "_ВЫВОДИТЬИТОГОВУЮСКИДКУНАЧЕКЕ" , true) == true )
			{
				IF (TYPE("_СУММАСКИДКИВСЕГО") == "I" OR TYPE("_СУММАСКИДКИВСЕГО") == "B" AND ПУСТО( ТекстБонусов ) )
				{
					IF ( _СУММАСКИДКИВСЕГО > 0 )
					{
						IF ( !ФР.МЕРКУРИЙФР_ТекстИтоговойСкидки() )
						{
							ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "Печать чека" )
							RETURN false;
						}
					}
				}
			}
						
			Команда = ДАННЫЕ_JSON("command", "CloseCheck");
			
			ДанныеПокупателя = "";
			IF (!ПУСТО(ПОЧТА))
				ДанныеПокупателя = ДАННЫЕ_JSON("sendCheckTo", ПОЧТА);
				
			ДанныеОплат = " ""payment"": { " + СтрокиОплатЧека + " } ";	
				
			ТекстЗапроса = "{ ""sessionKey"": """ + _МАССИВКЛЮЧЕЙФР[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ] + """, " + Команда + ЕСЛИ( !ПУСТО( ДанныеПокупателя ), "," + ДанныеПокупателя, "") + ", " + ДанныеОплат + " }";

			ОТВЕТ = "";
			
			IF ( !ФР.МЕРКУРИЙФР_HTTPPOST(ФР.МЕРКУРИЙФР_АДРЕССЕРВЕРА(), "/api.json", ТекстЗапроса, "", @ОТВЕТ) )
			{
				_ОШИБКАВЫПОЛНЕНИЯ		= true;
				УДАЛИТЬКОНТЕКСТ( "КомандыЧека" );			
				ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "Печать чека" );
				RETURN false;
			}
			ELSE
			{
				IF ( !ПУСТО( ОТВЕТ) )
				{
					НомерЧекаККМ = VAL( ПОЛЕ_JSON( ОТВЕТ, "fiscalDocNum", "" ) );
					НомерСменыККМ = VAL( ПОЛЕ_JSON( ОТВЕТ, "shiftNum", "" ) );
					//ФискальныйПризнакЧека = ПОЛЕ_JSON( ОТВЕТ, "fiscalSign", "" );
					IF ( !ПУСТО( НомерЧекаККМ ) )
						ЗАПРОС( "UPDATE sprequipment SET chequeNumber = " + (НомерЧекаККМ + 1) + " WHERE code = '" + ФР.КодОборудования() + "'" );
				}
				
				//в случае успешного пробития сохраненные значения проверок можно очистить
				//1. удалим контекст с результатами проверок КМ			
				УДАЛИТЬКОНТЕКСТ("РезультатыОбработкиКМ");
				//2. очистим результаты предыдущей проверки
				ЭТОРМК = false;			
				IF (TYPE("_МРП") <> "U")
					ЭТОРМК = _МРП == "2";
					
				IF ( !ЭТОРМК AND ALLTRIM(ПЕРЕМЕННАЯ("ВерсияФФД", "1.05")) == "1.2")
					ФР.МЕРКУРИЙФР_ОчиститьТаблицуПроверенныхКМ( ФР.КОДОБОРУДОВАНИЯ() );
			}
		}
	}
	
	ПРОПУСТИТЬ( 1, "КомандыЧека" );
}
УДАЛИТЬКОНТЕКСТ( "КомандыЧека" );
		
RETURN ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "Печать чека" );
