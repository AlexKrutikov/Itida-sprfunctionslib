// Закрытие банковского дня при наличии безналичных платежей

ТекстЧека = "";
ЗаголовокЧека = "";
ПозицииЧека = "";

try
{
	DriverPayCard = CreateObject( "SBRFSRV.Server", 1 );
}
catch()
{
	DriverPayCard = false;
}
IF ( TYPE("DriverPayCard") <> "O")
{
	Сообщение("Не удалось создать объект драйвера платежных систем." + CHR(13) + "Проверьте корректность установки компонент Сбербанка.","Ошибка загрузки драйвера ПС");
	RETURN false;
}
DriverPayCard.Clear();
Результат = DriverPayCard.NFun(6000);
IF ( Результат <> 0 )
{
	СООБЩЕНИЕ ( "Ошибка при закрытии банковского дня" );
	RETURN false;
}
ELSE
{	
	НОМЕРУСТРОЙСТВАДЛЯПС		= ЗАПРОС( "SELECT code FROM sprequipment WHERE f_paysystem = 1" );
	ИНДЕКСУСТРОЙСВАПЕЧАТИ		= ЕСЛИ(!ПУСТО(НОМЕРУСТРОЙСТВАДЛЯПС), НОМЕРУСТРОЙСТВАДЛЯПС, КОДОБОРУДОВАНИЯ);
	
	КоличествоПустыхСтрок = 0;
	//получаем слип-чек и добавляем в чек
	СлипЧек = DriverPayCard.GParamString("Cheque");	

	try
	{
		ЗАПРОС( "INSERT INTO paycardtrans ( equipment, TransType, slip, fr_code )
			 VALUES ( '"	+ КОДОБОРУДОВАНИЯ + "', '" 
							+ ТипЧека + ", "
							+ STDF( СлипЧек ) + "', '"
							+ ФРКОДОБОРУДОВАНИЯ + 
							"' )" );
	}
	catch()
	{
		СООБЩЕНИЕ("Ошибка записи данных сверки итогов в базу", ФР.ИМЯОБОРУДОВАНИЯ());
	}
	
}
DriverPayCard.Clear();
DriverPayCard = false;

RETURN true;
