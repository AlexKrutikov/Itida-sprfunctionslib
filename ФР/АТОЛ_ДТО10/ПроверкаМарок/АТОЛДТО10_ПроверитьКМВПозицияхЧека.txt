//подключаемся к ККТ
IF ( !ФР.АТОЛДТО10_ОткрытьФР( КОДОБОРУДОВАНИЯ, "Проверка массива КМ" ) ) RETURN false;

ТипЗадания		= ДАННЫЕ_JSON("type", "validateMarks");
Таймаут			= ДАННЫЕ_JSON("timeout", 5000); //5 секунд

//вычислим номер первой строки с товарной позицией
НомерПервойСтрокиТовара = ЗАПРОС("SELECT TOP 1 identity_column FROM " + ИмяТаблицыСтрокЧека + " WHERE operation = 'Регистрация' OR operation = 'Возврат' ORDER BY identity_column ASC");
//вычислим номер последней строки с товарной позицией
НомерПоследнейСтрокиТовара = ЗАПРОС("SELECT TOP 1 identity_column FROM " + ИмяТаблицыСтрокЧека + " WHERE operation = 'Регистрация' OR operation = 'Возврат' ORDER BY identity_column DESC");
	


//копируем все команды, располагающиеся до первой строки товаров в новую таблицу команд чека
ДОБАВИТЬКОНТЕКСТ("SELECT * FROM " + ИмяТаблицыСтрокЧека + " WHERE identity_column < " + НомерПервойСтрокиТовара,"НовыеКомандыЧека");
	
//отдельно обработаем позиции чека
ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяТаблицыСтрокЧека + " WHERE operation = 'Регистрация' OR operation = 'Возврат' ORDER BY identity_column", "ПозицииЧека" );
WHILE ( !КОНЕЦКОНТЕКСТА( "ПозицииЧека" ) )
{
	КоличествоТовара	= ПозицииЧека.quantity;
	СуммаТовара			= ПозицииЧека.summa;
	СуммаСкидкиПозиции	= ПозицииЧека.discountvalue;
	Наименование		= ПозицииЧека.name;
	_Цена_Учет			= ПозицииЧека._price_u;
	СекцияККМ			= ПозицииЧека.department;
	КодНалога			= ПозицииЧека.kodn;
	ПредметРасчета		= ПозицииЧека.rsubject;
	СпособРасчета		= ПозицииЧека.rvariant;
	ПарольОперации		= ПозицииЧека.password;
	ИмяОперации			= ПозицииЧека.operation;
	ТипМаркировки		= ПозицииЧека.marktype;
	ШтрихКодМаркировки	= ПозицииЧека.markbc;
	ВерсияФФД			= ПозицииЧека.ffd_version;
	
	JSONПроверяемыйКМ	= "";
	ТэгТипКодаМаркировки = ДАННЫЕ_JSON("imcType", "auto"); //определить тип КМ автоматически;
	ТэгКодМаркировки = ДАННЫЕ_JSON("imc", ПЕРЕКОДИРОВАТЬ(ШтрихКодМаркировки,,"BASE64")); //base64-представление значения кода маркировки (тег 2000)
	ТэгПланируемыйСтатус = ДАННЫЕ_JSON("itemEstimatedStatus", "itemPieceSold"); //1 - itemPieceSold - штучный товар, реализован;
																				//2 - itemDryForSale - мерный товар, в стадии реализации;
																				//3 - itemPieceReturn - штучный товар, возвращен;
																				//4 - itemDryReturn - часть товара, возвращена;
																				//255 - itemStatusUnchanged - статус товара, не изменился;
	ТэгРежимОбработкиКМ = ДАННЫЕ_JSON("imcModeProcessing", 0); //Режим обработки кода товара (тег 2102)
	//ТэгДробноеКоличествоТовара = ДАННЫЕ_JSON("itemFractionalAmount", "1/5"); //Дробное количество маркированного товара (тег 1291). Используется только для КМ в позициях без проверки в чеке
	ТэгКоличествоТовара = ДАННЫЕ_JSON("itemQuantity", КоличествоТовара); //Количество товара (тег 1023)
	ТэгМераТовара = ДАННЫЕ_JSON("itemUnits", "piece"); //Мера количества товара (тег 2108). Используется только для проверки КМ
	
	JSONПроверяемыйКМ += "{" + ТэгТипКодаМаркировки + "," + ТэгКодМаркировки + "," + ТэгПланируемыйСтатус + "," + ТэгРежимОбработкиКМ + "," + ТэгКоличествоТовара + "," + ТэгМераТовара + "}";
	
	//формируем задание
	ТекстЗадания = "{" + ТипЗадания + "," + Таймаут + "," + """params"":" + JSONПроверяемыйКМ + "}";


	fptr.setParam( fptr.LIBFPTR_PARAM_JSON_DATA, ТекстЗадания );
	fptr.processJson( );
	
	IF (ФР.АТОЛДТО10_ЗакрытьФРСПроверкойНаОшибки("Проверка КМ", false))
	{
		ФР.АТОЛДТО10_ОтключитьККТ();
		УДАЛИТЬКОНТЕКСТ("НовыеКомандыЧека");
		УДАЛИТЬКОНТЕКСТ("ПозицииЧека");
		RETURN false;
	}
	
	//ОБРАБОТКА РЕЗУЛЬТАТА ЗАДАНИЯ И ЗАПИСЬ В КОНТЕКСТ ПОЗИЦИЙ ЧЕКА
	РезультатПроверкиКМ = "";
	
	
	РезультатНачалаПроверкиКМ	= fptr.getParamString( fptr.LIBFPTR_PARAM_JSON_DATA );
	
	ЗАГРУЗИТЬJSON( "РезультатЗадания", ПОЛЕ_JSON(РезультатНачалаПроверкиКМ), "offlineValidation", "" );
	ВЫБРАТЬКОНТЕКСТ( "РезультатЗадания" );
	
	КМПроверенФН = ПОЛЕ_JSON(РезультатЗадания, "fmCheck", "");
	КМРезультатПроверкиФН = ПОЛЕ_JSON(РезультатЗадания, "fmCheckResult", "");
	КМПричинаОшибкиПроверкиФН = ПОЛЕ_JSON(РезультатЗадания, "fmCheckErrorReason", "");
	
	//получаем результат проверки
	ФоноваяПроверкаЗавершена = ФР.АТОЛДТО10_ПроверитьОкончаниеФоновойПроверки(3000);
	
	IF (!ФоноваяПроверкаЗавершена)
	{
		WHILE (СООБЩЕНИЕ("Результат проверки КМ в ИСМ не получен. Повторить проверку?", "Проверка КМ", 5) == 4)
		{
			ФоноваяПроверкаЗавершена = ФР.АТОЛДТО10_ПроверитьОкончаниеФоновойПроверки(3000);
		}
	}
	
	IF (ФоноваяПроверкаЗавершена)
	{
		//получим результат выполнения проверки		
		
		РезультатФоновойПроверкиКМ	= ФР.АТОЛДТО10_ПолучитьРезультатФоновойПроверки();
		ЗАГРУЗИТЬJSON("ДанныеФоновойПроверки", РезультатФоновойПроверкиКМ);
		ВЫБРАТЬКОНТЕКСТ("ДанныеФоновойПроверки");
		ДанныеОнлайнПроверки = ПОЛЕ_JSON(ДанныеФоновойПроверки, "onlineValidation", "");
		
		РезультатыОбработкиЗапросаИСМ = ПОЛЕ_JSON(ДанныеОнлайнПроверки, "markOperatorResponse", ""); //2005
		ИСМРезультатПроверкиКПКМ = ПОЛЕ_JSON(РезультатыОбработкиЗапросаИСМ, "responseStatus", "");
		ИСМСтатусТовараКорректен = ПОЛЕ_JSON(РезультатыОбработкиЗапросаИСМ, "itemStatusCheck", "");
		
		ТипКМ = ПОЛЕ_JSON(ДанныеОнлайнПроверки, "imcType", ""); //2100
		КМТовара = ПОЛЕ_JSON(ДанныеОнлайнПроверки, "imcBarcode", ""); //2101
		РежимОбработкиКМ = ПОЛЕ_JSON(ДанныеОнлайнПроверки, "imcModeProcessing", ""); //2102
		КодОбработкиЗапроса = ПОЛЕ_JSON(ДанныеОнлайнПроверки, "markOperatorResponseResult", ""); //2105
		
		СведенияОТоваре = ПОЛЕ_JSON(ДанныеОнлайнПроверки, "itemInfoCheckResult", ""); //2106		
		КМПроверен = ПОЛЕ_JSON(СведенияОТоваре, "imcCheckFlag", ""); //2106, бит 0
		КМРезультатПроверки = ПОЛЕ_JSON(СведенияОТоваре, "imcCheckResult", ""); //2106, бит 1
		КМСтатусИСМ = ПОЛЕ_JSON(СведенияОТоваре, "imcStatusInfo", ""); //2106, бит 2
		КМПланируемыйСтатус = ПОЛЕ_JSON(СведенияОТоваре, "imcEstimatedStatusCorrect", ""); //2106, бит 3
		КМККТАвтономная = ПОЛЕ_JSON(СведенияОТоваре, "ecrStandAloneFlag", ""); //2106, бит 4
		
		СведенияОСтатусеТовара = ПОЛЕ_JSON(ДанныеОнлайнПроверки, "markOperatorItemStatus", ""); //2109
	}
	
	
	
	//добавляем строку		
	ДОБАВИТЬСТРОКИ(1, "НовыеКомандыЧека");
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "operation", ИмяОперации);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "password", ПарольОперации);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "mode", "1");
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "checktype", "0");
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "name", Наименование);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "quantity", STR( КоличествоТовара, 16, 3 ));
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "price", STR( ЦенаТоварнойПозиции, 16, 2 ));
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "_price_u", STR( _Цена_Учет, 16, 2 ));
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "summa", STR( СуммаТовара, 16, 2 ));
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "destination", 0);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "department", ЕСЛИ( ПУСТО( СекцияККМ ), 1, СекцияККМ ));
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "discounttype", 0);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "discountvalue", STR( СуммаСкидкиПозиции, 16, 3 ));
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "kodn", КодНалога);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "rsubject", ПредметРасчета);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "rvariant", СпособРасчета);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "marktype", ТипМаркировки);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "markbc", ШтрихКодМаркировкиОстаток);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "ffd_version",  ВерсияФФД);
	ИЗМЕНИТЬПОЛЕ("НовыеКомандыЧека", "kmcheckresult",  РезультатПроверкиКМ);
	
	
	
	ПРОПУСТИТЬ( 1, "ПозицииЧека" );
}
УДАЛИТЬКОНТЕКСТ("ПозицииЧека");

//копируем все команды, располагающиеся после последней строки товаров в новую таблицу команд чека
ДОБАВИТЬКОНТЕКСТ("SELECT * FROM " + ИмяТаблицыСтрокЧека + " WHERE identity_column > " + НомерПоследнейСтрокиТовара,"ПоследниеКомандыЧека");
	
//теперь удалим все строки из таблицы позиций
ЗАПРОС("DELETE FROM " + ИмяТаблицыСтрокЧека);

//и загрузим в неё данные из сформированных контекстов
ВЫГРУЗИТЬ(ИмяТаблицыСтрокЧека,"","identity_column","НовыеКомандыЧека");
ВЫГРУЗИТЬ(ИмяТаблицыСтрокЧека,"","identity_column","ПоследниеКомандыЧека");


УДАЛИТЬКОНТЕКСТ("НовыеКомандыЧека");
УДАЛИТЬКОНТЕКСТ("ПоследниеКомандыЧека");

		
RETURN ФР.АТОЛДТО10_ЗакрытьФРСПроверкойНаОшибки( "Проверка массива КМ" );
