//пропускаем ФР, у которых не установлен флаг проверки КМ
//возвращаем true чтобы прошла проверка по остальным ФР, если они есть
ПроверятьКМНаФР = ЗАПРОС("SELECT f_checkkm FROM sprequipment WHERE code = '" + КОДОБОРУДОВАНИЯ + "'");
IF (!ПроверятьКМНаФР)
	RETURN true;

//короткие коды маркировки не проверяем, а сразу возвращаем ошибку проверки
IF ( ПУСТО(ШТРИХКОДМАРКИРОВКИ) OR LEN(ШТРИХКОДМАРКИРОВКИ) <= 13 )
	RETURN false;
	
//проверять КМ будем только для продажи и возврата	
ТипОперацииЧека = ПЕРЕМЕННАЯ("ОПЕРАЦИЯ", "ПРОДАЖА");
IF ( !ВСПИСКЕ(ТипОперацииЧека, "ПРОДАЖА", "ВОЗВРАТ") ) 
	RETURN true;
	
РезультатПроверкиСведенийОКМ  = "";
	
IF ( !ФР.АТОЛДТО10_ПроверитьКМ( КОДОБОРУДОВАНИЯ, false, ШТРИХКОДМАРКИРОВКИ, "", @РезультатПроверкиСведенийОКМ ) )
	RETURN false;

//проверим существование контекста с результатами проверок и, если нет констекста, создадим его
IF ( !ВЫБРАТЬКОНТЕКСТ( "РезультатыОбработкиКМ" ) )
	IF ( !ДОБАВИТЬКОНТЕКСТ( "LOCAL: Штрихкод text, Результат text", "РезультатыОбработкиКМ" ) ) 
	{
		СООБЩЕНИЕ("Не удалось сохранить результаты проверки кода маркировки");
		RETURN false;
	}

ВЫБРАТЬКОНТЕКСТ( "РезультатыОбработкиКМ" );
ПЕРЕЙТИВНАЧАЛО( "РезультатыОбработкиКМ" );
НАШЛИ			= false;

WHILE ( !КОНЕЦКОНТЕКСТА( "РезультатыОбработкиКМ" ) && !НАШЛИ )
{
	НАШЛИ		= ALLTRIM( РезультатыОбработкиКМ.Штрихкод ) == ALLTRIM( ШТРИХКОДМАРКИРОВКИ );
	IF ( !НАШЛИ ) ПРОПУСТИТЬ( 1, "РезультатыОбработкиКМ" );
}
IF ( !НАШЛИ )
{
	//если нет такого КМ в результатах, то добавляем новую строку
	ДОБАВИТЬСТРОКИ( 1, "РезультатыОбработкиКМ" );	
	ИЗМЕНИТЬПОЛЕ( "РезультатыОбработкиКМ", "Штрихкод", ALLTRIM(ШТРИХКОДМАРКИРОВКИ) );
}
//сохраним результаты проверки в контекст
ИЗМЕНИТЬПОЛЕ( "РезультатыОбработкиКМ", "Результат", РезультатПроверкиСведенийОКМ );
	
RETURN true;
