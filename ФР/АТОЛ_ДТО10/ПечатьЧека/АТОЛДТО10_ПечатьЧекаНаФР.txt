//"ПечатьЧекаНаФР" - функция, которая будет заниматься формирование чека в формате JSON для его последующей отправки в ККМ

ТекстЧека 		= "";
ЗаголовокЧека	= "";
ПозицииЧека		= "";
СтрокиОплатЧека = "";
ФискальныйЧек	= true; 	//Признак фискального чека
//ВерсияФФД		= "";
	
ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяТаблицыСтрокЧека + " ORDER BY identity_column", "КомандыЧека" );
WHILE ( !КОНЕЦКОНТЕКСТА( "КомандыЧека" ) )
{
	IF ( КомандыЧека.operation == "ЕГАИС слип" )
	{
		IF ( !ФР.АТОЛДТО10_ПечатьСлипаЕГАИС( ) ) RETURN false;
	}
	IF ( КомандыЧека.operation == "Открыть чек" )
	{
		ЗаголовокЧека	= ФР.АТОЛДТО10_ЗаголовокЧека( );
	}
	ELSE IF ( КомандыЧека.operation == "Печать строки" )
	{
		ФР.АТОЛДТО10_ПечатьСтроки( КомандыЧека.name, КомандыЧека.mode, КомандыЧека.checktype );
	}
	ELSE IF ( КомандыЧека.operation == "Регистрация" OR КомандыЧека.operation == "Возврат" )
	{
		ФР.АТОЛДТО10_ДобавитьВЧекРегистрациюВозврат( );
	}					
	ELSE IF ( КомандыЧека.operation == "Оплата" )
	{
		СтрокаОплаты = "{
			""type"": """ + КомандыЧека.closetype + """,
			""sum"": " + STR( КомандыЧека.price, 16, 2) + "
			}";
		ФР.АТОЛДТО10_ДобавитьОплатуЧека( СтрокиОплатЧека, СтрокаОплаты, true, "payments");	
	}	
	ELSE IF ( КомандыЧека.operation == "Закрытие чека" )
	{
		//соберем итоговый чек в формате JSON
		ТекстЧека = ЗаголовокЧека;
		//0. добавим банковский слип, если установлен режим печати слипа вместе с чеком
		IF ( _БАКОВСКИЙСЛИПВМЕСТЕСЧЕКОМ == true AND !ПУСТО( БанковскиеПозицииЧека ) )
		{
			ТекстЧека += ЕСЛИ( ПРАВСИМВ(ТекстЧека,1) <> ",", ",", "") + "
			""preItems"": [
			" + БанковскиеПозицииЧека + "
			],";
		}
		
		//1. Добавим фискальные/нефискальные строки 
		ТекстЧека += ЕСЛИ( ПРАВСИМВ(ТекстЧека,1) <> ",", ",", "") + "
		""items"": [
		" + ПозицииЧека + "
		]";
		
		//добавим информацию о бонусах и скидках в чек
		ТекстБонусов = "";
		ТекстИтоговойСкидки = "";
		НомерКартыНаПечать = "";
		IF ( TYPE( "НОМЕРКАРТЫ" ) <> "U" )
			НомерКартыНаПечать = НОМЕРКАРТЫ;
			
		IF ( ПЕРЕМЕННАЯ("_ВЫВОДИТЬИНФОРМАЦИЮОБОНУСАХНАЧЕКЕ", true) == true AND !ПУСТО( НомерКартыНаПечать ) )
			ТекстБонусов = ФР.АТОЛДТО10_ТекстБонусов( );			
				
		IF ( ПЕРЕМЕННАЯ("_ВЫВОДИТЬИТОГОВУЮСКИДКУНАЧЕКЕ", true) == true )
		{
			IF (TYPE("_СУММАСКИДКИВСЕГО") == "I" OR TYPE("_СУММАСКИДКИВСЕГО") == "B" )
			{
				IF ( _СУММАСКИДКИВСЕГО > 0 )
					ТекстИтоговойСкидки = ФР.АТОЛДТО10_ТекстИтоговойСкидки( );
			}
		}
		
		ТекстБонусовСкидки = ТекстБонусов + ЕСЛИ( !ПУСТО(ТекстБонусов) AND !ПУСТО(ТекстИтоговойСкидки), ",", "" ) + ТекстИтоговойСкидки;
		
		IF ( !ПУСТО( ТекстБонусовСкидки ) )
		{
			ТекстЧека	+= ",
			""postItems"": [
			" + ТекстБонусовСкидки + "
			]";
		}
					
		IF ( ФискальныйЧек )
		{	
			//2. Если фискальный чек, то добавим оплаты и итоговую сумму чека
			//total (число)	- Итог чека. Может отличаться от суммы позиций на значение, равное копейкам чека. Если не задан - высчитывается автоматически из суммы всех позиций
			ТекстЧека = ТекстЧека + ",
			""payments"": [
			" + СтрокиОплатЧека + "
			]";
			
			//передача итога чека (если не передавать, то будет рассчитываться сам по суммам позиций)
			IF ( VAL( КомандыЧека.price ) <> 0 )
			{
				ТекстЧека = ТекстЧека + ",
				""total"": " + STR( КомандыЧека.price, 16, 2) + "
				";
			}
			ELSE
			{
				ТекстЧека = ТекстЧека + CHR(13);					
			}
		}
		//3. Закрывающая фигурная скобка
		ТекстЧека = ТекстЧека + "}";
		
		//Пробъем на ККМ итоговый чек
		РезультатПечатиЧека = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, ФискальныйЧек, "", ВерсияФФД );
		
		//если печать завершилась ошибкой, то предложим повторить печать
		WHILE ( !РезультатПечатиЧека )
		{
			СообщениеПользователю 	= "Чек не завершен в ККМ." + CHR( 13 ) + "Повторить печать чека?";
			КодОтвета 				= СООБЩЕНИЕ( СообщениеПользователю, "Ошибка печати чека", 5 );
			IF ( КодОтвета == 4 ) //если нажали "Повторить"
			{
				РезультатПечатиЧека = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, ФискальныйЧек, "", ВерсияФФД ); //повторим печать чека
			}
			ELSE //если нажали "Отмена"
			{
				РезультатПечатиЧека	= false;
				BREAK;
			}
		}
		//конец повтора печати чека
		
		IF ( !РезультатПечатиЧека )
		{
			_ОШИБКАВЫПОЛНЕНИЯ		= true;
			УДАЛИТЬКОНТЕКСТ( "КомандыЧека" );
			// Удаляем временную таблицу
			ЗАПРОС( "DROP TABLE " + ИмяТаблицыСтрокЧека );
			RETURN false;
		}
		ELSE
		{
			//в случае успешного пробития сохраненные значения проверок можно очистить
			//1. удалим контекст с результатами проверок КМ			
			УДАЛИТЬКОНТЕКСТ("РезультатыОбработкиКМ");
			//2. очистим результаты предыдущей проверки
			ЭТОРМК = false;			
			IF (TYPE("_МРП") <> "U")
				ЭТОРМК = _МРП == "2";
				
			IF ( !ЭТОРМК AND ALLTRIM(ПЕРЕМЕННАЯ("ВерсияФФД", "1.05")) == "1.2")
				ФР.АТОЛДТО10_ОчиститьТаблицуПроверенныхКМ( ФР.КОДОБОРУДОВАНИЯ() );
		}
	}
	
	ПРОПУСТИТЬ( 1, "КомандыЧека" );
}
УДАЛИТЬКОНТЕКСТ( "КомандыЧека" );

IF ( ПЕЧАТАТЬКОПИЮ )
	ФР.АТОЛДТО10_ПечатьКопииЧекаНаФР( );

// Удаляем временную таблицу
ЗАПРОС( "DROP TABLE " + ИмяТаблицыСтрокЧека );
RETURN true;
