// Проверим статус ККТ
ТекстЗапросаСтатусККТ = "
{
	""type"": ""getDeviceStatus""
}
";
fptr.setParam( fptr.LIBFPTR_PARAM_JSON_DATA, ТекстЗапросаСтатусККТ );
fptr.processJson( );
ОтветСтатусККТ 			= fptr.getParamString( fptr.LIBFPTR_PARAM_JSON_DATA );
ДатаВремяВККМСтрокой	= ПОЛЕ_JSON( ПОЛЕ_JSON( ОтветСтатусККТ, "deviceStatus", "" ), "currentDateTime", "" );

ДатаВККМ 				= ПОДСТРОКА( ДатаВремяВККМСтрокой, 1, 10 );
ВремяВККМ 				= ПОДСТРОКА( ДатаВремяВККМСтрокой, 12, 8 );
ДатаВремяВККМ 			= CTOD( ДатаВККМ + " " + ВремяВККМ, 7);
ТекущаяДата 			= ДАТАВРЕМЯ( );
РазницаВМинутах 		= АБСОЛЮТНОЕЗНАЧЕНИЕ( РАЗНИЦАДАТ( ДатаВремяВККМ, ТекущаяДата, 'min' ) );
IF ( РазницаВМинутах > _ДОПУСТИМОЕРАСХОЖДЕНИЕВРЕМЕНИККМ )
{
	ВремяККМ 			= ДатаВремяВККМ + "";
	ВремяПК 			= ТекущаяДата + "";
	ТекстВопроса 		= "Дата/Время в ПК """ + ВремяПК + """" + CHR( 13 ) + CHR( 10 ) +
						  "отличается от даты/времени в " + CHR( 13 ) + CHR( 10 ) + 
						  "ККМ """ + ВремяККМ + """" + CHR( 13 ) + CHR( 10 ) + 
						  "более чем на " + _ДОПУСТИМОЕРАСХОЖДЕНИЕВРЕМЕНИККМ + " минут." + CHR( 13 ) + CHR( 10 );
						  
	IF ( РазницаВМинутах > _ДОПУСТИМАЯРАЗНИЦАМИНУТДЛЯСИНХРОНИЗАЦИИ )
	{
		ТекстВопроса	+=  CHR( 13 ) + CHR( 10 );
		ТекстВопроса	+= "Произведите ручную корректировку даты и времени через драйвер ККМ или обратитесть к техническому специалисту.";
		СООБЩЕНИЕ(ТекстВопроса);
		RETURN true;
	}
							  
	ТекстВопроса		+= "Установить дату/время в ККМ """ + ВремяПК + """?";
	ОТВЕТ 				= СООБЩЕНИЕ( ТекстВопроса,"Расхождение даты/времени в ККМ", 4 );
	IF ( ОТВЕТ == 6 ) //если нажали "Да"
	{
		ТекущаяДата 	= ДАТАВРЕМЯ( );
		ДатаНовая 		= DTOC( ТекущаяДата, 7, "." ) + "";
		ВремяНовое 		= ПРАВСИМВ( "00" + ЧАС( ТекущаяДата ), 2 ) + ":" + ПРАВСИМВ( "00" + МИНУТА( ТекущаяДата ), 2 ) + ":" + ПРАВСИМВ( "00" + СЕКУНДА( ТекущаяДата ), 2 );
		
		// Установка даты и времени в ККМ
		// При этом воспользуемся стандартным способом установки через метод writeDateTime(), т.к. в драйвере 10.4.6 json метод установки даты/времени работал некорректно (сдвиг времени на час)
		НоваяДата 		= CTOD( ДатаНовая + " " + ВремяНовое, 7 );
		fptr.setParam( fptr.LIBFPTR_PARAM_DATE_TIME, НоваяДата );
		fptr.writeDateTime( );
		IF ( fptr.errorCode( ) <> 0 )
		{
			ТекстОшибки = "Ошибка (" + fptr.errorCode() + "): " + fptr.errorDescription( );
			СООБЩЕНИЕ( ТекстОшибки, "Ошибка установки даты/времени в ККТ" );
			RETURN false;
		}
	}
}
//В противном случае ничего не делаем
//Контроль даты и времени в ККМ - конец
RETURN true;
