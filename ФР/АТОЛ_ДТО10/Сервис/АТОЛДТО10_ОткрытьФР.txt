IF ( ПУСТО( КОДОБОРУДОВАНИЯ ) )
{
	СООБЩЕНИЕ( "Ошибка работы с ФР (" + МестоВызова + ")." + CHR( 13 ) +"Не определен код оборудования", "Ошибка работы с ККМ" );
	RETURN false;
}

COMPARAMORDER( false );

fptr = _МАССИВККТ[ VAL(КОДОБОРУДОВАНИЯ) ];
ОтсоединятьсяОтУстройства		= ЗАПРОС( "SELECT f_disconnect FROM sprequipment WHERE code = '" + КОДОБОРУДОВАНИЯ + "'" ) == 1;

IF ( ТИП( "fptr" ) <> "O" )
{
	_МАССИВККТ[ VAL(КОДОБОРУДОВАНИЯ) ] = CreateObject( "AddIn.Fptr10", 1 );
	fptr = _МАССИВККТ[ VAL(КОДОБОРУДОВАНИЯ) ];
}

// Если не получмлось создать объект драйера, то ошибка
IF ( ТИП( "fptr" ) <> "O" )	
{
	СООБЩЕНИЕ( "Ошибка работы с ФР (" + МестоВызова + ")." + CHR( 13 ) +"Не удалось создать объект драйвера.");
	RETURN false;
}

//сбрасываем последнюю ошибку, если она есть
fptr.resetError();

IF (fptr.isOpened() == false)
{
	НастройкиККТ 				= ЗАПРОС( "SELECT value FROM param_ex WHERE param = 'ATOLKKTSETTINGS" + КОДОБОРУДОВАНИЯ + "'" );
	
	IF ( !ПУСТО( НастройкиККТ ) )
	{
		// Передаем настройки в драйвер 
		fptr.setSettings( НастройкиККТ );
	}
}

// Соединяемся с ккт
IF ( !fptr.isOpened( ) ) fptr.Open( );

//_МАССИВККТ[ VAL(КОДОБОРУДОВАНИЯ) ] = fptr;

// Если порт занят и в карточке оборудования установлен флаг "Отсоединяться от устройства", то запускаем попытка переподключения к ККТ, пока не освободится или не прервут
IF ( ВСПИСКЕ( fptr.errorCode( ), 3 , 4 ) )
{
	ИмяОборудования 	= ЗАПРОС( "SELECT name FROM sprequipment WHERE code = '" + ALLTRIM(КОДОБОРУДОВАНИЯ) + "'" );
	ТекстВопроса 		= "ККМ """ + ИмяОборудования + """: Порт занят." + CHR( 13 ) + "Переподключиться к ККМ?";
	WHILE ( ВСПИСКЕ( fptr.errorCode( ), 3 , 4 ) )
	{				
		IF ( СООБЩЕНИЕ( ТекстВопроса, "Ожидание ККМ", 4 ) == 6 ) // Если нажали "Да"
		{
			fptr.Open( ); // повтор соединения
		}
		ELSE  // Если нажали "Нет"
		{
			BREAK;
		}
	}
}
ELSE IF (fptr.errorCode( ) <> 0 )
	СООБЩЕНИЕ( "Ошибка подключения к ФР (" + МестоВызова + ")." + CHR( 13 ) + CHR(10) + "Код ошибки: " + fptr.errorCode( ) + ". Описание ошибки: " + fptr.errorDescription( ), МестоВызова );

RETURN fptr.errorCode( ) == 0;
