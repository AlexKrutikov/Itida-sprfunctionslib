// Закрытие банковского дня при наличии безналичных платежей

ТекстЧека = "";
ЗаголовокЧека = "";
ПозицииЧека = "";

try
{
	DriverPayCard = CreateObject( "SBRFSRV.Server", 1 );
}
catch()
{
	DriverPayCard = false;
}
IF ( TYPE("DriverPayCard") <> "O")
{
	Сообщение("Не удалось создать объект драйвера платежных систем." + CHR(13) + "Проверьте корректность установки компонент Сбербанка.","Ошибка загрузки драйвера ПС");
	RETURN false;
}
DriverPayCard.Clear();
Результат = DriverPayCard.NFun(6000);
IF ( Результат <> 0 )
{
	СООБЩЕНИЕ ( "Ошибка при закрытии банковского дня" );
	RETURN false;
}
ELSE
{	
	НОМЕРУСТРОЙСТВАДЛЯПС		= ЗАПРОС( "SELECT code FROM sprequipment WHERE f_paysystem = 1" );
	ИНДЕКСУСТРОЙСВАПЕЧАТИ		= ЕСЛИ(!ПУСТО(НОМЕРУСТРОЙСТВАДЛЯПС), НОМЕРУСТРОЙСТВАДЛЯПС, КОДОБОРУДОВАНИЯ);
	
	КоличествоПустыхСтрок = 0;
	//получаем слип-чек и добавляем в чек
	СлипЧек = DriverPayCard.GParamString("Cheque");		
	РазделительСтрок 	= CHR(10);
	НомерСтрокиСлипа	= 1;
	СлипЧекВрем			= РазделительСтрок + СлипЧек;
	СтрокаСлипа			= ПОЛУЧИТЬСЛОВО( СлипЧекВрем, РазделительСтрок, НомерСтрокиСлипа );
	WHILE ( !ПУСТО( СтрокаСлипа ) OR КоличествоПустыхСтрок < 4  )
	{
		IF ( МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛ" )
			ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, СтрокаСлипа, false, "text", "left", "words", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
		ELSE IF ( МОДЕЛЬОБОРУДОВАНИЯ == "МЕРКУРИЙ" )	
			ФР.МЕРКУРИЙФР_ПечатьСтроки(СтрокаСлипа);
		ELSE IF ( МОДЕЛЬОБОРУДОВАНИЯ == "ШТРИХ" )
			ФР.ШТРИХ_ПечатьСтроки(СтрокаСлипа);
		
		НомерСтрокиСлипа++;
		СтрокаСлипа		= ПОЛУЧИТЬСЛОВО( СлипЧекВрем, РазделительСтрок, НомерСтрокиСлипа );
		
		IF (ПУСТО(СтрокаСлипа))
			КоличествоПустыхСтрок++;
		ELSE
			КоличествоПустыхСтрок = 0;
	}	
	
	
	IF ( МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛ" )
	{
		ЗаголовокЧека = "
		{
			""type"": ""nonFiscal"",";

		ТекстЧека = ЗаголовокЧека + "
		""items"": [
		" + ПозицииЧека + "
		]
		}";
	
		РезультатПечати = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, false, ИНДЕКСУСТРОЙСВАПЕЧАТИ );
	}
	ELSE IF ( МОДЕЛЬОБОРУДОВАНИЯ == "МЕРКУРИЙ" )	
		РезультатПечати = true;
	ELSE IF ( МОДЕЛЬОБОРУДОВАНИЯ == "ШТРИХ" )	
		РезультатПечати = ФР.ШТРИХ_ПечатьЧекаНаФР(  );
		
	IF (РезультатПечати == false)
	{
		СООБЩЕНИЕ( "Ошибка печати сверки итогов на ФР", ФР.ИМЯОБОРУДОВАНИЯ() );
		RETURN false;
	}
	ELSE
	{
		//если успешно напечатали нефискальный чек, то обнуляем текст чека и нефискальные строки
		ТекстЧека = "";
		ЗаголовокЧека = "";
		ПозицииЧека = "";
	}
	
}
DriverPayCard.Clear();
DriverPayCard = false;

RETURN true;
