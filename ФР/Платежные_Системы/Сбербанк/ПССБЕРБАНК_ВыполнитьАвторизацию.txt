IF ( ТипЧека == 0 OR ТипЧека == 6 )
{
	ОтветПС = DriverPayCard.NFun(4000);
}
ELSE IF ( ТипЧека == 1 )
{
	IF ( СООБЩЕНИЕ("Выполнить отмену транзакции или возврат?" + CHR(13) + "Да - ОТМЕНА, Нет - ВОЗВРАТ", "АЙТИДА-СБЕРБАНК", 4) == 6 )
	{
		ОтветПС = DriverPayCard.NFun(4003);
	}
	ELSE
	{
		ОтветПС = DriverPayCard.NFun(4002);
	}
}
	
IF ( ОтветПС <> 0 )
{
	СООБЩЕНИЕ( "Ошибка платежной системы: " + ОтветПС + "." + CHR(13) + "Чек не будет пробит на ККМ." );
	RETURN false;
}

IF ( ПЕРЕМЕННАЯ("_ИСПОЛЬЗОВАТЬНЕПОДТВЕРЖДЕННЫЕТРАНЗАКЦИИ", false) == true )
{
	//включаем возможность аварийной отмены
	//для этого устанавливаем у транзакции статус "неподтвержденной"
	СуммаОплатыПС					= _ККТСУММАБЕЗНАЛ*100;
	DriverPayCard.SParam ("Amount", СуммаОплатыПС);
	ОтветПС = DriverPayCard.NFun(6003);
}

IF ( ОтветПС == 0 )
{
	ПозицииЧека = "";
	
	IF ( TYPE("КОДОБОРУДОВАНИЯ") == "U" )
	КОДОБОРУДОВАНИЯ = ФРКОДОБОРУДОВАНИЯ;

	ЗАПРОС( "INSERT INTO paycardtrans ( equipment, AuthCode, TransType, OperationType, Sum, CardNumber, SlipNumber, TransDate, TransTime, MsgNumber, TerminalID, ReferenceNumber )
			 VALUES ( '" + КОДОБОРУДОВАНИЯ + "', '" + DriverPayCard.GParamString("AuthCode") + "', " + DriverPayCard.GParamString("CardType") + ", " + DriverPayCard.GParamString("MerchantTSN") + ", " + 
			 DriverPayCard.GParamString("Amount")+ ", '" + DriverPayCard.GParamString("ClientCard") + "', " + DriverPayCard.GParamString("MerchantBatchNum") + ", '" + DriverPayCard.GParamString("TrxDate") + "', '" + 
			 DriverPayCard.GParamString("TrxTime") + "', " + DriverPayCard.GParamString("MerchantTSN") + ", '" + DriverPayCard.GParamString("TermNum") + "', '" + DriverPayCard.GParamString("RRN") + "' )" );

	НОМЕРУСТРОЙСТВАДЛЯПС		= ЗАПРОС( "SELECT TOP 1 code FROM sprequipment WHERE f_paysystem = 1" );
	ИНДЕКСУСТРОЙСВАПЕЧАТИ		= ЕСЛИ(!ПУСТО(НОМЕРУСТРОЙСТВАДЛЯПС), НОМЕРУСТРОЙСТВАДЛЯПС, КОДОБОРУДОВАНИЯ);
	НОМЕРКОПИИСЛИПА				= 0;
	
	//получаем слип-чек и добавляем в чек
	СлипЧек = DriverPayCard.GParamString("Cheque");
	
	WHILE ( НОМЕРКОПИИСЛИПА < _КОЛИЧЕСТВОКОПИЙСЛИПА )
	{
		РазделительСтрок 	= CHR(10);
		НомерСтрокиСлипа	= 1;
		СлипЧекВрем			= РазделительСтрок + СлипЧек;
		СтрокаСлипа			= ПОЛУЧИТЬСЛОВО( СлипЧекВрем, РазделительСтрок, НомерСтрокиСлипа );
		WHILE ( !ПУСТО( СтрокаСлипа ) )
		{
			ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, СтрокаСлипа, false, "text", "left", "words", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
			НомерСтрокиСлипа++;
			СтрокаСлипа		= ПОЛУЧИТЬСЛОВО( СлипЧекВрем, РазделительСтрок, НомерСтрокиСлипа );
		}				
		
		//Если установлен режим печати банковского слипа вместе с кассовым чеком и это первый слип и нет неявных ошибок ПС, 
		//то запомним позиции банковского слипа для их последующего добавления к позициям кассового чека
		//При наличии неявных ошибок слип нужно все таки вывести пользователю для обработки результата
		IF (_БАКОВСКИЙСЛИПВМЕСТЕСЧЕКОМ == true AND НОМЕРКОПИИСЛИПА == 0 )
		{
			//запомним первый слип 
			БанковскиеПозицииЧека = ПозицииЧека;
			//текущий слип очистим, чтобы не напечатался
			ПозицииЧека = "";
		}
		ELSE
		{
			ЗаголовокЧека = "
			{
				""type"": ""nonFiscal"",";
			
			ТекстЧека = ЗаголовокЧека + "
			""items"": [
			" + ПозицииЧека + "
			]
			}";
			
			РезультатПечати = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, false, ИНДЕКСУСТРОЙСВАПЕЧАТИ );
			
			IF (РезультатПечати == false)
			{
				WHILE (РезультатПечатиЧека <> true)
				{
					СообщениеПользователю = "Слип не напечатан в ККМ." + CHR(13) + "Повторить печать слипа?";
					КодОтвета = MESSAGEBOX(СообщениеПользователю,"Ошибка печати слипа",5);
					IF (КодОтвета==4) //если нажали "Повторить"
					{
						РезультатПечати = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, false, ИНДЕКСУСТРОЙСВАПЕЧАТИ ); //повторим печать слипа
					}
					ELSE //если нажали "Отмена"
					{
						Вопрос					= "Вы действительно хотите отменить печать слипа?";
						ОтветНаВопрос			= MESSAGEBOX(Вопрос,"Печать слипа",4);
						IF (ОтветНаВопрос == 6)
						{
							РезультатПечати	= false;
							BREAK;
						}
					}
				}
				//RETURN false;
			}
			
			//если успешно напечатали нефискальный чек, то обнуляем текст чека и нефискальные строки
			ТекстЧека = "";
			ЗаголовокЧека = "";
			ПозицииЧека = "";
		}
		
		НОМЕРКОПИИСЛИПА++;
	}
}		
ELSE
{
	СООБЩЕНИЕ( "Ошибка платежной системы: " + ОтветПС + "." + CHR(13) + "Чек не будет пробит на ККМ." );
	//возвращаем ошибку
	RETURN false;
}

RETURN true;
