// Закрытие чека
_ВСЕГОСКИДКАНАЧЕК = _ВСЕГОСКИДКАНАЧЕК - totaldiscount;
_СУММАСКИДКИВСЕГО = totaldiscount;

// Параметры - 
// СуммаОплаты число вещественное, сумма, полученная от покупателя
// ПроцентСкидки число вещественное, процент скидки на чек
// Параметр - FROperatorProfile число, профиль из карточки сотрудника

IF ( !ПУСТО( ИМЯПЛАТЕЖНОЙСИСТЕМЫ ) AND МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" )
{
	IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "ПСАТОЛ")
	{
		IF ( !ФР.ПСАТОЛ_ПровестиОперациюОплаты( ФР.КОДОБОРУДОВАНИЯ() ) )
			RETURN false;
	}
	ELSE IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "СБЕРБАНК")
	{
		IF ( !ФР.ПССБЕРБАНК_ПровестиОперациюОплаты( ФР.КОДОБОРУДОВАНИЯ() ) )
			RETURN false;
	}
}

ЭТОРМК = false;			
IF (TYPE("_МРП") <> "U")
	ЭТОРМК = _МРП == "2";
IF (ЭТОРМК)
{
	//печать комментария после фискальных строк и перед оплатой
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, mode, checktype, name)
			 VALUES ( 'Печать строки', 2, 'left', '" + STDF(КОММЕНТАРИЙ) + "' )" );
} 


//Если тип чека "Прочее/Вскрытие тары", то добавляем только печать нефискальных строк с оплатой
IF ( ТипЧека == 6 ) 
{
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, password, mode, checktype, 
														name, quantity, price, destination)
			 VALUES ( 'Печать строки', '', 0, 0, '================================================', 0, 0, 0 )" );	
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, password, mode, checktype, 
														name, quantity, price, destination)
			 VALUES ( 'Печать строки', '', 1, 0, 'ИТОГ: " + STR( СуммаЧека, 16, 2 ) + "', 0, 0, 0 )" );
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation,checktype)
			 VALUES ( 'Закрытие чека', 0 )" );	
}
ELSE
{
	IF ( ROUND( СуммаНал, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ККТ_КодВидаОплатыНаличные + "', " + STR( СуммаНал + СДАЧА, 16, 2 ) + " )" );
	IF ( ROUND( СуммаБезнал, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ККТ_КодВидаОплатыБезналичные + "', " + STR( СуммаБезнал, 16, 2 ) + " )" );
	IF ( ROUND( ВСЕГОСЕРТИФИКАТЫ, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ККТ_КодВидаОплатыПредоплата + "', " + STR( ВСЕГОСЕРТИФИКАТЫ, 16, 2 ) + " )" );
	IF ( ROUND( ВСЕГОКРЕДИТ, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ККТ_КодВидаОплатыКредит + "', " + STR( ВСЕГОКРЕДИТ, 16, 2 ) + " )" );
		
	IF ( !ЭТОРМК )
	{
		IF ( ROUND( ВСЕГОПРОЧАЯОПЛАТА, 2 ) != 0 )
			ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
					VALUES ( 'Оплата', '" + ККТ_КодВидаОплатыПрочее + "', " + STR( ВСЕГОПРОЧАЯОПЛАТА, 16, 2 ) + " )" );
	}
				
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, price )
			VALUES ( 'Закрытие чека', " + STR( 0, 16, 2 ) + " )" );
}
ФР.ПроизвестиФорматноЛогическийКонтроль();

/*
//для ФФД 1.2 проверим позиции предварительно через ФР
IF ( ALLTRIM(ВерсияФФД) == "1.2" )
{
	IF ( ФР.ЕстьПозицииСМаркировкойВЧеке() )
	{
		IF (МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10")
		{
			//ФР.АТОЛДТО10_ОчиститьТаблицуПроверенныхКМ( ФР.КОДОБОРУДОВАНИЯ() );
			IF ( !ФР.АТОЛДТО10_ПроверитьКМВПозицияхЧека( ФР.КОДОБОРУДОВАНИЯ() ) )
				RETURN false;
		}
	}
}
*/

IF ( МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" )
	РезультатПечатиЧека		= ФР.АтолДТО10_ПечатьЧекаНаФР( );
ELSE IF ( МОДЕЛЬОБОРУДОВАНИЯ == "МЕРКУРИЙ" )
	РезультатПечатиЧека		= ФР.МЕРКУРИЙФР_ПечатьЧекаНаФР( );
	
Результат 				= РезультатПечатиЧека == true;

IF ( !ПУСТО( ИМЯПЛАТЕЖНОЙСИСТЕМЫ ) AND МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" )
{
	IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "ПСАТОЛ")
		ФР.ПСАТОЛ_ЗавершениеОперацииОплаты( Результат );
	IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "СБЕРБАНК")
		ФР.ПССБЕРБАНК_ЗавершениеОперацииОплаты( Результат );
}


НомерЧекаККМ 			= 0;
НомерСменыККМ 			= 0;

RETURN Результат;
