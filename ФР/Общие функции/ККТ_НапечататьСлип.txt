IF ( НОМЕРПОДЧЕКА == 1 AND НОМЕРПОДЧЕКА <= ВСЕГОЧЕКОВ)
	ДОБАВИТЬКОНТЕКСТ("SELECT * FROM paycardtrans WHERE owner = '" + _UNCONFIRMEDID + "' AND fr_code IN ('','" + ФР.КОДОБОРУДОВАНИЯ() + "')", "ОперацииПС");
ELSE
	ДОБАВИТЬКОНТЕКСТ("SELECT * FROM paycardtrans WHERE owner = '" + _UNCONFIRMEDID + "' AND fr_code = '" + ФР.КОДОБОРУДОВАНИЯ() + "'", "ОперацииПС");
	
ВЫБРАТЬКОНТЕКСТ("ОперацииПС");
IF ( КОЛИЧЕСТВОСТРОК("ОперацииПС") > 0 )
{
	ПЕРЕЙТИВНАЧАЛО("ОперацииПС");
	WHILE ( !КОНЕЦКОНТЕКСТА("ОперацииПС") )
	{
		КоличествоСлипов = VAL(ОперацииПС.slipcount);
		ПозицииЧека = "";
		СлипЧек = ОперацииПС.slip;
		НОМЕРКОПИИСЛИПА = 0;
		WHILE ( НОМЕРКОПИИСЛИПА < КоличествоСлипов )
		{
			РазделительСтрок 	= CHR(10);
			НомерСтрокиСлипа	= 1;
			СлипЧекВрем			= РазделительСтрок + СлипЧек;
			СтрокаСлипа			= ПОЛУЧИТЬСЛОВО( СлипЧекВрем, РазделительСтрок, НомерСтрокиСлипа );
			WHILE ( !ПУСТО( СтрокаСлипа ) )
			{
				IF (  МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" )
					ФР.АТОЛДТО10_ДобавитьСтрокуЧека( ПозицииЧека, СтрокаСлипа, false, "text", "left", "words", _ШРИФТТЕКСТАДЛЯНЕФИСКАЛЬНОЙПЕЧАТИ);
				
				НомерСтрокиСлипа++;
				СтрокаСлипа		= ПОЛУЧИТЬСЛОВО( СлипЧекВрем, РазделительСтрок, НомерСтрокиСлипа );
			}				
			
			//Если установлен режим печати банковского слипа вместе с кассовым чеком и это первый слип и нет неявных ошибок ПС, 
			//то запомним позиции банковского слипа для их последующего добавления к позициям кассового чека
			//При наличии неявных ошибок слип нужно все таки вывести пользователю для обработки результата
			IF (_БАКОВСКИЙСЛИПВМЕСТЕСЧЕКОМ == true AND НОМЕРКОПИИСЛИПА == 0 )
			{
				//запомним первый слип 
				БанковскиеПозицииЧека = ПозицииЧека;
				//текущий слип очистим, чтобы не напечатался
				ПозицииЧека = "";
			}
			ELSE
			{
				IF (  МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" )
				{
					ЗаголовокЧека = "
					{
						""type"": ""nonFiscal"",";
					
					ТекстЧека = ЗаголовокЧека + "
					""items"": [
					" + ПозицииЧека + "
					]
					}";
					РезультатПечати = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, false, ФР.КОДОБОРУДОВАНИЯ() );
				}
				
				IF (РезультатПечати == false)
				{
					WHILE (РезультатПечати <> true)
					{
						СообщениеПользователю = "Слип не напечатан в ККМ." + CHR(13) + "Повторить печать слипа?";
						КодОтвета = MESSAGEBOX(СообщениеПользователю,"Ошибка печати слипа",5);
						IF (КодОтвета==4) //если нажали "Повторить"
						{
							IF (  МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" )
								РезультатПечати = ФР.АТОЛДТО10_ФискализироватьЧек( ТекстЧека, false, ФР.КОДОБОРУДОВАНИЯ() ); //повторим печать слипа
						}
						ELSE //если нажали "Отмена"
						{
							Вопрос					= "Вы действительно хотите отменить печать слипа?";
							ОтветНаВопрос			= MESSAGEBOX(Вопрос,"Печать слипа",4);
							IF (ОтветНаВопрос == 6)
							{
								РезультатПечати	= false;
								BREAK;
							}
						}
					}
					//RETURN false;
				}
				
				//если успешно напечатали нефискальный чек, то обнуляем текст чека и нефискальные строки
				ТекстЧека = "";
				ЗаголовокЧека = "";
				ПозицииЧека = "";
			}
			
			НОМЕРКОПИИСЛИПА++;
		}// конец цикла по количеству слипов
		ПРОПУСТИТЬ( 1, "ОперацииПС");
	}//конец цикла по констексту с операциями по платежным системам
}
