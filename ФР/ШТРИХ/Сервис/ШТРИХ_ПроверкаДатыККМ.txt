// Проверим статус ККТ
driverKKM.Password		= FROperatorProfile;
driverKKM.GetECRStatus();

СтатусККМ = driverKKM.ECRMode;

//установка даты и времени работает только в режимах 4, 7, 9
IF ( !ВСПИСКЕ( СтатусККМ, 4, 7, 9 ) )
	RETURN true;

ДатаВККМ 				= ЛЕВСИМВ( driverKKM.Date, 8);
ВремяВККМ 				= ПРАВСИМВ( driverKKM.Time, 8);
ДатаВремяВККМ 			= CTOD(ДатаВККМ + " " + ВремяВККМ, 4);

/*
СООБЩЕНИЕ(	"ДатаВККМ = " + STR( ДатаВККМ ) + CHR(13) + CHR(10) +
			"Время в ККМ = " + STR( ВремяВККМ ) + CHR(13) + CHR(10) +
			"ДатаВремяВККМ = " + STR( ДатаВремяВККМ ) );			
*/

ТекущаяДата 			= ДАТАВРЕМЯ( );
РазницаВМинутах 		= АБСОЛЮТНОЕЗНАЧЕНИЕ( РАЗНИЦАДАТ( ДатаВремяВККМ, ТекущаяДата, 'min' ) );
IF ( РазницаВМинутах > _ДОПУСТИМОЕРАСХОЖДЕНИЕВРЕМЕНИККМ )
{
	ВремяККМ 			= ДатаВремяВККМ + "";
	ВремяПК 			= ТекущаяДата + "";
	ТекстВопроса 		= "Дата/Время в ПК """ + ВремяПК + """" + CHR( 13 ) + CHR( 10 ) +
						  "отличается от даты/времени в " + CHR( 13 ) + CHR( 10 ) + 
						  "ККМ """ + ВремяККМ + """" + CHR( 13 ) + CHR( 10 ) + 
						  "более чем на " + _ДОПУСТИМОЕРАСХОЖДЕНИЕВРЕМЕНИККМ + " минут." + CHR( 13 ) + CHR( 10 );
						  
	IF ( РазницаВМинутах > _ДОПУСТИМАЯРАЗНИЦАМИНУТДЛЯСИНХРОНИЗАЦИИ )
	{
		ТекстВопроса	+=  CHR( 13 ) + CHR( 10 );
		ТекстВопроса	+= "Произведите ручную корректировку даты и времени через драйвер ККМ или обратитесть к техническому специалисту.";
		СООБЩЕНИЕ(ТекстВопроса, ФР.ИМЯОБОРУДОВАНИЯ() );
		RETURN true;
	}
							  
	ТекстВопроса		+= "Установить дату/время в ККМ """ + ВремяПК + """?";
	ОТВЕТ 				= СООБЩЕНИЕ( ТекстВопроса,"Расхождение даты/времени в ККМ", 4 );
	IF ( ОТВЕТ == 6 ) //если нажали "Да"
	{
		ТекущаяДата 	= ДАТАВРЕМЯ( );
		ДатаНовая 		= DTOC( ТекущаяДата, 7, "." ) + "";
		ВремяНовое 		= ПРАВСИМВ( "00" + ЧАС( ТекущаяДата ), 2 ) + ":" + ПРАВСИМВ( "00" + МИНУТА( ТекущаяДата ), 2 ) + ":" + ПРАВСИМВ( "00" + СЕКУНДА( ТекущаяДата ), 2 );
		
		// Установка даты в ККМ
		//новую дату будем устанавливать, только если дата в ККМ не совпадает с текущей (для перевода времени в ночное время)		
		IF ( CTOD( ДатаВККМ, 4 ) <> ДАТА() )
		{
			driverKKM.Date = CTOD( ДатаВККМ, 4 );
			driverKKM.SetDate();
			IF ( driverKKM.ResultCode == 0 AND driverKKM.ECRMode == 6 )
				driverKKM.ConfirmDate();				
		}
		IF ( driverKKM.ResultCode <> 0 )
		{
			ТекстОшибки = "Ошибка (" + driverKKM.ResultCode + ") при установке даты в ККТ. Описание ошибки : " + driverKKM.ResultCodeDescription;
			СООБЩЕНИЕ( ТекстОшибки, ФР.ИМЯОБОРУДОВАНИЯ() );
			RETURN false;
		}
		
		// Установка времени в ККМ
		driverKKM.Time = ВремяНовое;
		driverKKM.SetTime();
		
		IF ( driverKKM.ResultCode <> 0 )
		{
			ТекстОшибки = "Ошибка (" + driverKKM.ResultCode + ") при установке времени в ККТ. Описание ошибки : " + driverKKM.ResultCodeDescription;
			СООБЩЕНИЕ( ТекстОшибки, ФР.ИМЯОБОРУДОВАНИЯ() );
			RETURN false;
		}
	}
}
//В противном случае ничего не делаем
//Контроль даты и времени в ККМ - конец
RETURN true;
