ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИМЯТАБЛИЦЫ, "Предприятие", 1 );КОЛИЧЕСТВОВИДОВДЕЯТЕЛЬНОСТИ	=	ЕСЛИ( !ПУСТО( Предприятие.activity1 ), 1, 0 ) + ЕСЛИ( !ПУСТО( Предприятие.activity2 ), 1, 0 ) + ЕСЛИ( !ПУСТО( Предприятие.activity3 ), 1, 0 ) + 								ЕСЛИ( !ПУСТО( Предприятие.activity4 ), 1, 0 ) + ЕСЛИ( !ПУСТО( Предприятие.activity5 ), 1, 0 ); НомерПопытки			= 0;СИСТЕМНОЕСООБЩЕНИЕ( "Создание предприятия в ГИС Меркурий" );СИСТЕМНОЕСООБЩЕНИЕ( "#2Соединение с сервером ГИС Меркурий" );НомерПопытки			= 0;ВРаботе					= true;НовыйЗапрос				= true;WHILE ( ВРаботе AND НомерПопытки < 50 ){	НомерПопытки++;	IF ( НовыйЗапрос )	{		Текст = "		<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/""  						  xmlns:ws=""http://api.vetrf.ru/schema/cdm/application/ws-definitions"" 						  xmlns:app=""http://api.vetrf.ru/schema/cdm/application""						  xmlns:v2=""http://api.vetrf.ru/schema/cdm/mercury/g2b/applications/v2"" 						  xmlns:base=""http://api.vetrf.ru/schema/cdm/base"" 						  xmlns:v21=""http://api.vetrf.ru/schema/cdm/mercury/vet-document/v2"" 						  xmlns:v22=""http://api.vetrf.ru/schema/cdm/dictionary/v2"">						  			<soapenv:Header/>			<soapenv:Body>				<ws:submitApplicationRequest>					<ws:apiKey>" + МЕРКУРИЙКЛЮЧ + "</ws:apiKey>					<app:application>						<app:serviceId>mercury-g2b.service:2.0</app:serviceId>						<app:issuerId>" + МЕРКУРИЙХОЗСУБЪЕКТ + "</app:issuerId>						<app:issueDate>" + ЗАМЕНИТЬ( TTOC( ДАТАВРЕМЯ( ), 7, "-" ), " ", "T" ) + "</app:issueDate>						<app:data>							<v2:modifyEnterpriseRequest>								<v2:localTransactionId>A0001</v2:localTransactionId>								<v2:initiator>									<v21:login>" + МЕРКУРИЙИНИЦИАТОР + "</v21:login>								</v2:initiator>								<v2:modificationOperation>									<v21:type>CREATE</v21:type>									<v21:resultingList count=""1"" total=""1"" offset=""0"" hasMore=""0"">										<v22:enterprise>											<v22:name>" + ЕГАИС.ЗаменитьСимволы( Предприятие.name )+ "</v22:name>											<v22:type>1</v22:type>											<v22:address>" +  ЕСЛИ( ПУСТО( Предприятие.country ), "", " 												<v22:country>													<base:guid>" + Предприятие.country + "</base:guid>												</v22:country>" ) +  ЕСЛИ( ПУСТО( Предприятие.region ), "", " 												<v22:region>													<base:guid>" + Предприятие.region + "</base:guid>												</v22:region>" ) +  ЕСЛИ( ПУСТО( Предприятие.district ), "", " 												<v22:district>													<base:guid>" + Предприятие.district + "</base:guid>												</v22:district>" ) +  ЕСЛИ( ПУСТО( Предприятие.locality ), "", " 												<v22:locality>													<base:guid>" + Предприятие.locality + "</base:guid>												</v22:locality>" ) +  ЕСЛИ( ПУСТО( Предприятие.sublocality ), "", " 												<v22:sublocality>													<base:guid>" + Предприятие.sublocality + "</base:guid>												</v22:sublocality>" ) + ЕСЛИ( ПУСТО( Предприятие.street ) && ПУСТО( Предприятие.streetname ), "", " 												<v22:street>" +  ЕСЛИ( ПУСТО( Предприятие.street ), "", " 													<base:guid>" + Предприятие.street + "</base:guid>" ) + ЕСЛИ( ПУСТО( Предприятие.streetname ), "", " 													<v22:name>" + ЕГАИС.ЗаменитьСимволы( Предприятие.streetname )+ "</v22:name>" ) + "												</v22:street>" ) +  ЕСЛИ( ПУСТО( Предприятие.house ), "", " 												<v22:house>" + ЕГАИС.ЗаменитьСимволы( Предприятие.house )+ "</v22:house>" ) +  ЕСЛИ( ПУСТО( Предприятие.building ), "", " 												<v22:building>" + ЕГАИС.ЗаменитьСимволы( Предприятие.building )+ "</v22:building>" ) +  ЕСЛИ( ПУСТО( Предприятие.office ), "", " 												<v22:office>" + ЕГАИС.ЗаменитьСимволы( Предприятие.office )+ "</v22:office>" ) +  ЕСЛИ( ПУСТО( Предприятие.postindex ), "", " 												<v22:postIndex>" + ЕГАИС.ЗаменитьСимволы( Предприятие.postindex )+ "</v22:postIndex>" ) +  ЕСЛИ( ПУСТО( Предприятие.addressview ), "", " 												<v22:addressView>" + ЕГАИС.ЗаменитьСимволы( Предприятие.addressview )+ "</v22:addressView>" ) + "											</v22:address>											<v22:activityList count=""" + STR( КОЛИЧЕСТВОВИДОВДЕЯТЕЛЬНОСТИ ) + """ total=""" + STR( КОЛИЧЕСТВОВИДОВДЕЯТЕЛЬНОСТИ ) + """ offset=""0"" hasMore=""0""> " +												ЕСЛИ( ПУСТО( Предприятие.activity1 ), "", "												<v22:activity>													<v22:name>" + ЕГАИС.ЗаменитьСимволы( Предприятие.activity1 )+ "</v22:name>												</v22:activity>" ) + 												ЕСЛИ( ПУСТО( Предприятие.activity2 ), "", "												<v22:activity>													<v22:name>" + ЕГАИС.ЗаменитьСимволы( Предприятие.activity2 )+ "</v22:name>												</v22:activity>" ) + 												ЕСЛИ( ПУСТО( Предприятие.activity3 ), "", "												<v22:activity>													<v22:name>" + ЕГАИС.ЗаменитьСимволы( Предприятие.activity3 )+ "</v22:name>												</v22:activity>" ) + 												ЕСЛИ( ПУСТО( Предприятие.activity4 ), "", "												<v22:activity>													<v22:name>" + ЕГАИС.ЗаменитьСимволы( Предприятие.activity4 )+ "</v22:name>												</v22:activity>" ) + 												ЕСЛИ( ПУСТО( Предприятие.activity5 ), "", "												<v22:activity>													<v22:name>" + ЕГАИС.ЗаменитьСимволы( Предприятие.activity5 )+ "</v22:name>												</v22:activity>" ) + "											</v22:activityList>											<v22:owner>												<base:guid>" + МЕРКУРИЙХОЗСУБЪЕКТ + "</base:guid>											</v22:owner>" + 											ЕСЛИ( ПУСТО( Предприятие.kpp ), "", "											<v22:officialRegistration>												<v22:businessEntity>													<v22:inn>" + ЕГАИС.ЗаменитьСимволы( Предприятие.inn )+ "</v22:inn>												</v22:businessEntity>												<v22:kpp>" + ЕГАИС.ЗаменитьСимволы( Предприятие.kpp ) + "</v22:kpp>											</v22:officialRegistration>" ) + "										</v22:enterprise>									</v21:resultingList>									<v21:reason>" + ЕГАИС.ЗаменитьСимволы( Предприятие.reason )+ "</v21:reason>								</v2:modificationOperation>							</v2:modifyEnterpriseRequest>						</app:data> 					</app:application>				</ws:submitApplicationRequest>			</soapenv:Body>		</soapenv:Envelope>		";		ОтветСервера			= Меркурий.ОтправитьЗапрос( Текст, "ЗАЯВКИ", МЕРКУРИЙЛОГИН, МЕРКУРИЙПАРОЛЬ, МЕРКУРИЙТЕСТОВЫЙКОНТУР );	//	Сообщение( ОтветСервера );		ДОБАВИТЬКОНТЕКСТ( "SET FMTONLY ON SELECT '' AS applicationId, '' AS status, '' AS apl_status, '' AS apl_error SET FMTONLY OFF", "Ответ" );		ЗАГРУЗИТЬ( "Ответ", "XMLSTRING", ОтветСервера );		ПЕРЕЙТИВНАЧАЛО( "Ответ" );		IF ( UPPER( ALLTRIM( Ответ.status ) ) <> "ACCEPTED" ) 		{			IF ( !ПУСТО( ОтветСервера ) )				СИСТЕМНОЕСООБЩЕНИЕ( "#2#ErrorОшибка ГИС Меркурий. " + Ответ.status );			RETURN "";		}		ИДЗаявки				= Ответ.applicationId;		УДАЛИТЬ( "ALL", "Ответ" );		Текст = "		<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" xmlns:ws=""http://api.vetrf.ru/schema/cdm/application/ws-definitions"" >			<soapenv:Header/>			<soapenv:Body>				<ws:receiveApplicationResultRequest>					<ws:apiKey>" + МЕРКУРИЙКЛЮЧ + "</ws:apiKey>					<ws:issuerId>" + МЕРКУРИЙХОЗСУБЪЕКТ + "</ws:issuerId>					<ws:applicationId>" + ИДЗаявки + "</ws:applicationId>				</ws:receiveApplicationResultRequest>			</soapenv:Body>		</soapenv:Envelope>";	}	ОтветСервера		= Меркурий.ОтправитьЗапрос( Текст, "ЗАЯВКИ", МЕРКУРИЙЛОГИН, МЕРКУРИЙПАРОЛЬ, МЕРКУРИЙТЕСТОВЫЙКОНТУР );	IF ( ПУСТО( ОтветСервера ) ) RETURN "";		ЗАГРУЗИТЬ( "Ответ", "XMLSTRING", ОтветСервера, "application", "", "application" );	IF ( AT( ОтветСервера, "APLM0012" ) > 0 )	{		СИСТЕМНОЕСООБЩЕНИЕ( "#2#ErrorОшибка ГИС Меркурий APLM0012. Попытка " + НомерПопытки );		ВРаботе			= true;		НовыйЗапрос		= true;	}	ELSE	{		IF ( UPPER( ALLTRIM( Ответ.status ) ) == "REJECTED" )		{			СИСТЕМНОЕСООБЩЕНИЕ( "#2#ErrorОшибка ГИС Меркурий. " + Ответ.apl_error );			RETURN "";		}		ВРаботе			= UPPER( ALLTRIM( Ответ.status ) ) == "IN_PROCESS"  OR UPPER( ALLTRIM( Ответ.apl_status ) ) == "IN_PROCESS";		НовыйЗапрос		= false;		IF ( ВРаботе )			СИСТЕМНОЕСООБЩЕНИЕ( "#2Запрос обрабатывается. Попытка " + НомерПопытки );		ELSE			СИСТЕМНОЕСООБЩЕНИЕ( "#2Получены данные. Обработка" );	}	ОБРАБОТАТЬСОБЫТИЯ( );	IF ( _ПРЕРВАТЬВЫПОЛНЕНИЕ ) RETURN "";}УДАЛИТЬКОНТЕКСТ( "Предприятие" );IF ( НомерПопытки >= 50 OR _ПРЕРВАТЬВЫПОЛНЕНИЕ ) RETURN "";ДОБАВИТЬКОНТЕКСТ( "SET FMTONLY ON SELECT '' AS bs_guid, '' AS dt_name SET FMTONLY OFF", "Адреса" );ЗАГРУЗИТЬ( "Адреса", "XMLSTRING", ОтветСервера, "merc:enterprise", "", "merc:enterprise", "dt:numberList dt:owner dt:officialRegistration dt:address" );ПЕРЕЙТИВНАЧАЛО( "Адреса" );// Если не получилось, то выходимПредприятие			= СЖАТЬПРОБЕЛЫ( Адреса.bs_guid );УДАЛИТЬКОНТЕКСТ( "Адреса" );IF ( ПУСТО( Предприятие ) ) RETURN "";IF ( !Меркурий.СвязатьПредприятиеХС( Предприятие, МЕРКУРИЙХОЗСУБЪЕКТ, МЕРКУРИЙЛОГИН, МЕРКУРИЙПАРОЛЬ, МЕРКУРИЙТЕСТОВЫЙКОНТУР, МЕРКУРИЙКЛЮЧ, МЕРКУРИЙИНИЦИАТОР ) ) RETURN "";RETURN Предприятие;
