// Связываем предприятие и ХСНомерПопытки			= 0;ВРаботе					= true;НовыйЗапрос				= true;WHILE ( ВРаботе AND НомерПопытки < 50 ){	НомерПопытки++;	IF ( НовыйЗапрос )	{		Текст = "			<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" 							  xmlns:v2=""http://api.vetrf.ru/schema/cdm/mercury/g2b/applications/v2"" 							  xmlns:base=""http://api.vetrf.ru/schema/cdm/base"" 							  xmlns:v21=""http://api.vetrf.ru/schema/cdm/mercury/vet-document/v2"" 							  xmlns:v22=""http://api.vetrf.ru/schema/cdm/dictionary/v2"" 							  xmlns:ws=""http://api.vetrf.ru/schema/cdm/application/ws-definitions""							  xmlns:app=""http://api.vetrf.ru/schema/cdm/application"">				<soapenv:Header/>				<soapenv:Body>					<ws:submitApplicationRequest>						<ws:apiKey>" + МЕРКУРИЙКЛЮЧ + "</ws:apiKey>						<app:application>							<app:serviceId>mercury-g2b.service:2.0</app:serviceId>							<app:issuerId>" + МЕРКУРИЙХОЗСУБЪЕКТ + "</app:issuerId>							<app:issueDate>" + ЗАМЕНИТЬ( TTOC( ДАТАВРЕМЯ( ), 7, "-" ), " ", "T" ) + "</app:issueDate>							<app:data>								<v2:modifyActivityLocationsRequest>									<v2:localTransactionId>A0001</v2:localTransactionId>									<v2:initiator>										<v21:login>" + МЕРКУРИЙИНИЦИАТОР + "</v21:login>									</v2:initiator>									<v2:modificationOperation>										<v21:type>CREATE</v21:type>										<v21:businessEntity>											<base:guid>" + МЕРКУРИЙХОЗСУБЪЕКТ + "</base:guid>										</v21:businessEntity>										<v21:activityLocation>											<v21:enterprise>												<base:guid>" + ПРЕДПРИЯТИЕ + "</base:guid>											</v21:enterprise>										</v21:activityLocation>									</v2:modificationOperation>								</v2:modifyActivityLocationsRequest>							</app:data> 						</app:application>					</ws:submitApplicationRequest>				</soapenv:Body>			</soapenv:Envelope>		";		ОтветСервера			= Меркурий.ОтправитьЗапрос( Текст, "ЗАЯВКИ", МЕРКУРИЙЛОГИН, МЕРКУРИЙПАРОЛЬ, МЕРКУРИЙТЕСТОВЫЙКОНТУР );	//	Сообщение( ОтветСервера );		ДОБАВИТЬКОНТЕКСТ( "SET FMTONLY ON SELECT '' AS applicationId, '' AS status, '' AS apl_status, '' AS apl_error SET FMTONLY OFF", "Ответ" );		ЗАГРУЗИТЬ( "Ответ", "XMLSTRING", ОтветСервера );		ПЕРЕЙТИВНАЧАЛО( "Ответ" );		IF ( UPPER( ALLTRIM( Ответ.status ) ) <> "ACCEPTED" ) 		{			IF ( !ПУСТО( ОтветСервера ) )				СИСТЕМНОЕСООБЩЕНИЕ( "#2#ErrorОшибка ГИС Меркурий. " + Ответ.status );			RETURN false;		}		ИДЗаявки				= Ответ.applicationId;		УДАЛИТЬ( "ALL", "Ответ" );		Текст = "		<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" xmlns:ws=""http://api.vetrf.ru/schema/cdm/application/ws-definitions"" >			<soapenv:Header/>			<soapenv:Body>				<ws:receiveApplicationResultRequest>					<ws:apiKey>" + МЕРКУРИЙКЛЮЧ + "</ws:apiKey>					<ws:issuerId>" + МЕРКУРИЙХОЗСУБЪЕКТ + "</ws:issuerId>					<ws:applicationId>" + ИДЗаявки + "</ws:applicationId>				</ws:receiveApplicationResultRequest>			</soapenv:Body>		</soapenv:Envelope>";	}	ОтветСервера		= Меркурий.ОтправитьЗапрос( Текст, "ЗАЯВКИ", МЕРКУРИЙЛОГИН, МЕРКУРИЙПАРОЛЬ, МЕРКУРИЙТЕСТОВЫЙКОНТУР );	IF ( ПУСТО( ОтветСервера ) ) RETURN false;		ЗАГРУЗИТЬ( "Ответ", "XMLSTRING", ОтветСервера, "application", "", "application" );	IF ( AT( ОтветСервера, "APLM0012" ) > 0 )	{		СИСТЕМНОЕСООБЩЕНИЕ( "#2#ErrorОшибка ГИС Меркурий APLM0012. Попытка " + НомерПопытки );		ВРаботе			= true;		НовыйЗапрос		= true;	}	ELSE	{		IF ( UPPER( ALLTRIM( Ответ.status ) ) == "REJECTED" )		{			СИСТЕМНОЕСООБЩЕНИЕ( "#2#ErrorОшибка ГИС Меркурий. " + Ответ.apl_error );			RETURN false;		}		ВРаботе			= UPPER( ALLTRIM( Ответ.status ) ) == "IN_PROCESS"  OR UPPER( ALLTRIM( Ответ.apl_status ) ) == "IN_PROCESS";		НовыйЗапрос		= false;		IF ( ВРаботе )			СИСТЕМНОЕСООБЩЕНИЕ( "#2Запрос обрабатывается. Попытка " + НомерПопытки );		ELSE			СИСТЕМНОЕСООБЩЕНИЕ( "#2Получены данные. Обработка" );	}	ОБРАБОТАТЬСОБЫТИЯ( );	IF ( _ПРЕРВАТЬВЫПОЛНЕНИЕ ) BREAK;}RETURN true;
