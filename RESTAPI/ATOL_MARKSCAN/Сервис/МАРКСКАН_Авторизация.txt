// Токены авторизации храним в контексте из трех полей КодОборудования, Токен, ВремяАвторизации
IF ( !ВЫБРАТЬКОНТЕКСТ( "ТокеныМаркСкан" ) )
	IF ( !ДОБАВИТЬКОНТЕКСТ( "LOCAL: Устройство char, Токен char, ВремяАвторизации int", "ТокеныМаркСкан" ) ) RETURN "";

ВЫБРАТЬКОНТЕКСТ( "ТокеныМаркСкан" );
ПЕРЕЙТИВНАЧАЛО( "ТокеныМаркСкан" );
НАШЛИ			= false;
Устройство		= UPPER( ALLTRIM( КОДОБОРУДОВАНИЯ ) );
_ERRORCODE		= 0;
ПРОДЛЕВАЕМТОКЕН = false;

WHILE ( !КОНЕЦКОНТЕКСТА( "ТокеныМаркСкан" ) && !НАШЛИ )
{
	Нашли		= UPPER( ALLTRIM( ТокеныМаркСкан.Устройство ) ) == Устройство;
	IF ( !НАШЛИ ) ПРОПУСТИТЬ( 1, "ТокеныМаркСкан" );
}
IF ( !НАШЛИ )
{
	ДОБАВИТЬСТРОКИ( 1, "ТокеныМаркСкан" );
	ИЗМЕНИТЬПОЛЕ( "ТокеныМаркСкан", "Устройство", Устройство );
}
ELSE IF ( ( TICKCOUNT( ) - ТокеныМаркСкан.ВремяАвторизации ) < 86400000 && !ПУСТО( ТокеныМаркСкан.Токен ) ) RETURN ТокеныМаркСкан.Токен;
ELSE ПРОДЛЕВАЕМТОКЕН = true;

МаркСканТокен = "";
АдресРесурса = "/v3/authorization";

IF ( ПРОДЛЕВАЕМТОКЕН )
{
	//формируем строку для аутентификации	
	Заголовки[0] = "Content-type: application/json; charset=utf-8";
	
	ТэгИнтегратор = ДАННЫЕ_JSON("integrator", "itida-integrator");
	ТэгИДИнтегратора = ДАННЫЕ_JSON("id", "itida4");
	ТэгДеталиИнтегратора = ДАННЫЕ_JSON("details", "{ " + ТэгИДИнтегратора + ", " + ТэгИнтегратор + " }");
	ТэгПротокол = ДАННЫЕ_JSON("protocol", "atolmsk");
	ТэгНаименованиеМетода = ДАННЫЕ_JSON("name", "authorization");
	
	ТелоЗапроса = "{ " + ДАННЫЕ_JSON("document", "{ " + ТэгНаименованиеМетода + ", " + ТэгПротокол + ", " + ТэгДеталиИнтегратора + " }") + " }";
	
	try
	{
		ТекстОшибки	= "Сервер " + АдресСервера + CHR( 13 ) + "вернул сообщение об ошибке: " + CHR( 13 );
		
		Ответ		= ПЕРЕКОДИРОВАТЬ( RESTAPI.МАРКСКАН_POSTЗАПРОС( АдресСервера, АдресРесурса, ТелоЗапроса, "Заголовки" ), "UTF-8", "ANSI" );
		
		IF ( !RESTAPI.МАРКСКАН_ПРОВЕРКАНАОШИБКИ( @Ответ ) ) THROW ( Ответ );
		//проверим поле наличие обязательного поля в ответе, чтобы понимать что получили то что требуется.
		//проверять бужем по полю signature (можно по: id,name,role,expired)
		ПолеДокумент = ПОЛЕ_JSON( Ответ, "document", "" );
		ДеталиОтвета = ПОЛЕ_JSON( ПолеДокумент, "details", "");
		МаркСканТокен = ПОЛЕ_JSON( ДеталиОтвета, "token", "");
	}
	catch ( ТекстСообщения )
	{
		HTTPCLOSE( Соединение );
		СООБЩЕНИЕ( ТекстСообщения );
		ИЗМЕНИТЬПОЛЕ( "ТокеныМаркСкан", "Токен", "" );
		RETURN "";
	}
	HTTPCLOSE( Соединение );	

	//запишем токен и время авторизации в контекст с токеном
	ИЗМЕНИТЬПОЛЕ( "ТокеныМаркСкан", "Токен", МаркСканТокен );
	ИЗМЕНИТЬПОЛЕ( "ТокеныМаркСкан", "ВремяАвторизации", TICKCOUNT( ) );
	
}
	
RETURN МаркСканТокен.Токен;
