//Выгрузка документов
IF ( !ПУСТО( КОДДОКУМЕНТА ) OR !ПУСТО( СПИСОКДОКУМЕНТОВ ) ) 
{
	IF ( !ПУСТО( СПИСОКДОКУМЕНТОВ ) )
		ДОБАВИТЬКОНТЕКСТ( "SELECT dbase, code, ic FROM " + СПИСОКДОКУМЕНТОВ, "СписокДокументов", 1 );
	ELSE
		ДОБАВИТЬКОНТЕКСТ( "SELECT DB_NAME( ) AS dbase, '" + КОДДОКУМЕНТА + "' AS code, " + ИДДОКУМЕНТА + " AS ic", "СписокДокументов", 1 );
		
	WHILE ( !КОНЕЦКОНТЕКСТА( "СписокДокументов" ) )
	{
		IF ( СписокДокументов.code == "001" OR СписокДокументов.code == "002" OR СписокДокументов.code == "003"  OR СписокДокументов.code == "005"
		OR СписокДокументов.code == "007" OR СписокДокументов.code == "019" OR СписокДокументов.code == "045" OR СписокДокументов.code == "055" OR СписокДокументов.code == "MRK" )
		{
			АлкоДок = false;
			НаименованиеДокумента = "";
			document = СоздатьОбъект("Cleverence.Warehouse.Document",1);
			
			IF (СписокДокументов.code == "MRK")
			{
				ИДДок		= ИДДОКУМЕНТА;
				Номер		= ЗАПРОС( "SELECT ndok FROM mark_in WHERE identity_column= "  + ИДДОКУМЕНТА );
				Датадок		= ЗАПРОС( "SELECT date FROM mark_in WHERE identity_column= "  + ИДДОКУМЕНТА );
			}
			ELSE
			{
				ИДДок 		= ЗАПРОС( "SELECT identity_column FROM spr000 WHERE code= '"  + СписокДокументов.code + "' AND ic= " + СписокДокументов.ic );	
				Номер		= ЗАПРОС( "SELECT ndok FROM spr000 WHERE code= '"  + СписокДокументов.code + "' AND ic= " + СписокДокументов.ic );
				Датадок		= ЗАПРОС( "SELECT date FROM spr000 WHERE code= '"  + СписокДокументов.code + "' AND ic= " + СписокДокументов.ic );
			}
			ИмяДок	= 0;
			ИдЕГАИС = "";
			ТипДокумента = "";
			Отправлять_в_ЕГАИС = 0;
			IF (СписокДокументов.code =="001" OR СписокДокументов.code =="002" OR СписокДокументов.code =="003" OR СписокДокументов.code =="045")
			{
				ИдЕГАИС		= ЗАПРОС( "SELECT egaisid FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic );
			}
			IF (СписокДокументов.code =="001" OR СписокДокументов.code =="002")
			{
				ТипДокумента = ЗАПРОС( "SELECT ttntype FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic );
				Отправлять_в_ЕГАИС = ЗАПРОС( "SELECT egaisstatus FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic );
			}
			IF (СписокДокументов.code =="003")
			{
				Отправлять_в_ЕГАИС = ЗАПРОС( "SELECT egaisstatus FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic );
				ТипДокумента = ЗАПРОС( "SELECT f_income FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic );
			}
			//определим тип документа в MobileSmarts по типу документа в Айтида
			IF (СписокДокументов.code =="001" AND ПУСТО(ИдЕГАИС)) //если поле "ЕГАИС ИД" не заполнено, то документ считается обычным поступлением
			{
				ИмяДок = "Поступление";
			}
			ELSE IF (СписокДокументов.code =="001" AND !ПУСТО(ИдЕГАИС)) //если поле "ЕГАИС ИД" заполнено, то документ считается загруженным из ЕГАИС
			{
				ИмяДок = "ПоступлениеЕГАИС";
				АлкоДок = true;
			}
			ELSE IF (СписокДокументов.code =="002" AND ТипДокумента == 1 AND Отправлять_в_ЕГАИС > 0) //выгружаем только расходные накладные со статусом отличным от статуса "Не отправлять в ЕГАИС"
			{
				ИмяДок = "ВозвратЕГАИС";
				АлкоДок = true;
			}
			ELSE IF (СписокДокументов.code =="003" AND ТипДокумента == 0 AND Отправлять_в_ЕГАИС > 0) //выгружаем только списания со статусом отличным от статуса "Не отправлять в ЕГАИС"
			{
				ИмяДок = "СписаниеЕГАИС";
				АлкоДок = true;
			}
			ELSE IF (СписокДокументов.code =="005") //Переоценка
			{
				ИмяДок = "Переоценка";
			}
			ELSE IF (СписокДокументов.code =="007") //Инвентаризация ТМЦ
			{
				ИмяДок = "Инвентаризация";
			}
			ELSE IF (СписокДокументов.code =="019") //Внутреннее перемещение
			{
				ИмяДок = "Перемещение";
			}
			ELSE IF (СписокДокументов.code =="045") //Инвентаризация ЕГАИС
			{
				ИмяДок = "АлкоСборНачальныхОстатков";
				АлкоДок = true;
			}
			ELSE IF (СписокДокументов.code =="055") //Возврат поставщику
			{
				ИмяДок = "Возврат";
			}
			ELSE IF (СписокДокументов.code == "MRK") //Маркировка - приёмка
			{
				ИмяДок = "Поступление";
			}
			//\\ определили тип документа
			
			IF (ИмяДок == 0)
			{
				RETURN false;
			}
			НаименованиеДокумента = ИмяДок;
									
			ПолноеИмяДок = НаименованиеДокумента + " №" + Номер + " от " + Датадок + ЕСЛИ(!ПУСТО(ИдЕГАИС),"("+ИдЕГАИС+")","");
			document.Id = ИДДок;					//Уникальный идентификатор документа
			document.Name = ПолноеИмяДок;			//Название документа
			document.Appointment = "Общая";			//Назначение документа - код пользователя или имя группы, которым данный документ назначается на исполнение
			document.CreateDate = Датадок;			//Дата создания документа
			document.DocumentTypeName = ИмяДок;		//Должно соответствовать одному из доступных пользователю типов документов
			document.InProcess = 0;					//Признак того, что документ захвачен пользователем на обработку
			document.Finished  = 0;					//Признак того, что обработка документа пользователем была завершена, и его можно забирать назад в учетную систему
			document.Modified  = 0;					//Признак того, что документ был изменен
			//Склад = VAL(ЗАПРОС( "SELECT sklad FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic ));
			document.WarehouseId = 1;//Склад; 	//Идентификатор склада, к которому привязан документ
			document.Description = НаименованиеДокумента + ЕСЛИ(!ПУСТО(ИдЕГАИС),"Номер ТТН ЕГАИс: "+ИдЕГАИС+"","");//Описание документа
			document.Priority = 1;					//Приоритет документа. Более приоритетные документы раньше отдаются на терминал для обработки
			//document.Barcode = "";				//Штрихкод документа
			document.DistributeByBarcode = 0;		//Признак выдачи документа по штрихкоду. Документы с таким признаком не поступают на мобильный терминал автоматически, 
													//а могут быть выбраны с сервера только по штрихкоду. 
													//Свойство может успешно применяться только при наличии постоянной связи с сервером
			IF (СписокДокументов.code <> "MRK")
			{
				document.SetField("КонтрольКолва",ЗАПРОС( "SELECT dbo.fn_getfloat_ex('DOC','"+СписокДокументов.code+"','MS_контроль_количества',0,identity_column,0,'') FROM spr"+СписокДокументов.code+" WHERE identity_column = " + СписокДокументов.ic ));
			}
													//Контроль количества по заявке. 
													//1 – контролируется, в документ нельзя принимать товары, которых нет в заявке, а также нельзя превышать количество товара, который в заявке есть
													//0 – без контроля.
													
			IF (АлкоДок)
			{
				document.SetField("КонтрольМарок", true); //необходимость проверки старых марок, выгруженных в план документа				
			}
			СерверныйДокумент = "";
			IF (СписокДокументов.code <> "MRK")
			{
				СерверныйДокумент = ЗАПРОС( "SELECT dbo.fn_getfloat_ex('DOC','"+СписокДокументов.code+"','MS_серверный_документ',0,identity_column,0,'') FROM spr"+СписокДокументов.code+" WHERE identity_column = " + СписокДокументов.ic );
			}
			IF (!ПУСТО(СерверныйДокумент)) document.ServerHosted = СерверныйДокумент;
			
			IF (СписокДокументов.code =="019") //Внутреннее перемещение
			{
				СкладОткуда = ЗАПРОС( "SELECT sklad FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic );
				СкладКуда = ЗАПРОС( "SELECT sklad_d FROM spr"+СписокДокументов.code+" WHERE identity_column= " + СписокДокументов.ic );
				ИмяСкладаОткуда = ЗАПРОС("SELECT name FROM sprskl WHERE code = '" + СкладОткуда + "'");
				ИмяСкладаКуда = ЗАПРОС("SELECT name FROM sprskl WHERE code = '" + СкладКуда + "'");
				document.SetField("ИдСклада1СОткуда", СкладОткуда);
				document.SetField("ИдСклада1СКуда", СкладКуда);
				document.SetField("ИмяСкладаОткуда", ИмяСкладаОткуда);
				document.SetField("ИмяСкладаКуда", ИмяСкладаКуда);				
			}
			ИсточникАлкоКода = "sprres";			// по умолчанию источником алкокода товара является справочник ресурсов (для документа инвентаризации)										
			IF (СписокДокументов.code =="001" OR СписокДокументов.code =="002" OR СписокДокументов.code =="003" OR СписокДокументов.code =="045")
			{
				//document.SetField("НомерЕГАИС", ИдЕГАИС);//Номер документа в системе ЕГАИС
				ИсточникАлкоКода = "spec";			//для прихода, расхода и инвентаризации ЕГАИС Алкокод берем из спецификации документа
			}
			IF (ИмяДок == "ПоступлениеЕГАИС" OR ИмяДок == "Поступление")
			{
				ИмяПоляСЦеной = "ЦенаПриемки";				
			}
			ELSE
			{
				ИмяПоляСЦеной = "";
			}
			
						
			IF (СписокДокументов.code =="MRK")
			{
				ДОБАВИТЬКОНТЕКСТ( "SELECT DISTINCT sprnn.maincode AS maincode, spec.ed, spec.nn, spec.name, spec.cena, dbo.fn_getbarcodes_ex( spec.nn ) AS barcodes, sprnn.code AS Артикул, sprnn.nnvid AS ВидАлкоголя, sprnn.d_litr AS Объем,
						sprnn.edd_litr AS ЕдиницаОбъема, sprnn.weight AS Вес, sprnn.a_proc AS Крепость, sprnn.alcocode AS Алкокод, '' AS Производитель, spr.vendorname AS ПроизводительИмя, spr.vendorinn AS ПроизводительИНН,
						spr.vendorkpp AS ПроизводительКПП, " + ЕСЛИ(ПУСТО(СКЛАД),"0","dbo.fn_calcsklad( spec.nn, '', '" + СКЛАД + "', '001', '' )") + " AS Остаток
						FROM mark_in spr
						INNER JOIN mark_in_spec spec ON spr.identity_column = spec.ic
						INNER JOIN sprnn sprnn ON spec.nn = sprnn.nn 
						WHERE spr.identity_column = " + ИДДОКУМЕНТА, "Спецификация" );
			}
			ELSE
			{
				ДОБАВИТЬКОНТЕКСТ( "SELECT sprres.maincode, sprres.a_code, spec.nnname, spec.kolp, spec.nn, spec.cena, sprres.nnvid, sprres.d_litr, sprres.a_proc, "+ИсточникАлкоКода+".alcocode, sprres.importer,
								spec.ic AS spec_ic, spec.identity_column AS identity_column, (SELECT TOP 1 boxnumber FROM barcodes bc WHERE bc.code = '" + СписокДокументов.code + "' AND bc.ic = spec.ic AND bc.spec_ic = spec.identity_column)  AS boxnumber
							   FROM spec" + СписокДокументов.code + " spec
							   INNER JOIN sprres ON sprres.code = spec.nn
							   WHERE spec.ic = " + СписокДокументов.ic, "Спецификация" );				
			}
						
			WHILE ( !КОНЕЦКОНТЕКСТА( "Спецификация" ) )
			{
				IF (СписокДокументов.code <> "MRK")
				{
					//марки
					ДОБАВИТЬКОНТЕКСТ("SELECT barcode, boxnumber FROM barcodes WHERE ic = '" + Спецификация.spec_ic + "' AND spec_ic = '" + Спецификация.identity_column + "'", "Марки");
					IF (КОЛИЧЕСТВОСТРОК("Марки") > 0)
					{
						WHILE (!КОНЕЦКОНТЕКСТА("Марки"))
						{
							Алкомарка = Марки.barcode;
							
							documentItem = СоздатьОбъект("Cleverence.Warehouse.DocumentItem",1);
							КодТовара		= Спецификация.maincode;
							Количество		= 1;
							ЦенаТовара		= Спецификация.cena;
							АлкоКодВ		= Спецификация.nnvid;
							АлкоНаим		= ЗАПРОС( "SELECT name FROM sprnnvid WHERE code = '"+АлкоКодВ+"'");
							Объем			= Спецификация.d_litr;
							Крепость		= Спецификация.a_proc;
							Алкокод			= Спецификация.alcocode;
							Производитель	= Спецификация.importer;
							ПроизводительИмя= ЗАПРОС( "SELECT shortname FROM sprclient WHERE code = '"+Производитель+"'");
							ПроизводительИНН= ЗАПРОС( "SELECT inn FROM sprclient WHERE code = '"+Производитель+"'");
							ПроизводительКПП= ЗАПРОС( "SELECT kpp FROM sprclient WHERE code = '"+Производитель+"'");
							ШККоробки		= Марки.boxnumber;
							
							documentItem.ProductId = КодТовара;								//Идентификатор товара для которого описана данная позиция
							documentItem.PackingId = КодТовара;								//Идентификатор упаковки для заданного товара
							documentItem.CurrentQuantity = 0;								//Текущее количество твоара в позиции
							documentItem.DeclaredQuantity = Количество;						//Заданное количество в позиции
							//шк коробки
							documentItem.SSCC = ШККоробки;									//коробка, паллета...
							//documentItem.FirstStorageBarcode  = ШККоробки;
							documentItem.SetField("ШтрихкодРодителя", ШККоробки);
							
							IF ( !ПУСТО(ИмяПоляСЦеной) )
								documentItem.SetField(ИмяПоляСЦеной, STR(ЦенаТовара,10,2));		//Стоимость
							
							IF (АлкоКодВ <> "" AND АлкоДок == true)
							{
								documentItem.SetField("Алко", true);
								documentItem.SetField("АлкоКодВ", АлкоКодВ); 			//Код вида алкогольной продукции
								documentItem.SetField("АлкоНаим", АлкоНаим);			//Наименование вида алкогольной продукции
								documentItem.SetField("АлкоОбъем", Объем);				//Объем
								documentItem.SetField("АлкоКрепость", Крепость);		//Крепость
								documentItem.SetField("Производитель", ПроизводительИмя);//Производитель
								documentItem.SetField("ПроизвИНН", ПроизводительИНН);	//ИНН Производителя
								documentItem.SetField("ПроизвКПП", ПроизводительКПП);	//КПП Производителя
								documentItem.SetField("АлкоКод", Алкокод);				//Код алкогольной продукции	
								documentItem.SetField("АлкоПДФ", Алкомарка);			//Марка
							}
							document.DeclaredItems.Add(documentItem);						
							
							ПРОПУСТИТЬ( 1, "Марки" );
						}
						УДАЛИТЬКОНТЕКСТ( "Марки" );	
					}
					
					ELSE
					{
						Алкомарка = "";
						documentItem = СоздатьОбъект("Cleverence.Warehouse.DocumentItem",1);
						КодТовара		= Спецификация.maincode;
						Количество		= Спецификация.kolp;
						ЦенаТовара		= Спецификация.cena;
						АлкоКодВ		= Спецификация.nnvid;
						АлкоНаим		= ЗАПРОС( "SELECT name FROM sprnnvid WHERE code = '"+АлкоКодВ+"'");
						Объем			= Спецификация.d_litr;
						Крепость		= Спецификация.a_proc;
						Алкокод			= Спецификация.alcocode;
						Производитель	= Спецификация.importer;
						ПроизводительИмя= ЗАПРОС( "SELECT shortname FROM sprclient WHERE code = '"+Производитель+"'");
						ПроизводительИНН= ЗАПРОС( "SELECT inn FROM sprclient WHERE code = '"+Производитель+"'");
						ПроизводительКПП= ЗАПРОС( "SELECT kpp FROM sprclient WHERE code = '"+Производитель+"'");
						ШККоробки		= Спецификация.boxnumber;
						
						documentItem.ProductId = КодТовара;								//Идентификатор товара для которого описана данная позиция
						documentItem.PackingId = КодТовара;								//Идентификатор упаковки для заданного товара
						documentItem.CurrentQuantity = 0;								//Текущее количество твоара в позиции
						documentItem.DeclaredQuantity = Количество;						//Заданное количество в позиции
						documentItem.SSCC  = ШККоробки;									//коробка, паллета...
						//documentItem.FirstStorageBarcode  = ШККоробки;
						documentItem.SetField("ШтрихкодРодителя", ШККоробки);
						
						//передадим цену для поступления ЕГАИС и простого поступления
						IF ( !ПУСТО( ИмяПоляСЦеной ) )
							documentItem.SetField(ИмяПоляСЦеной, STR(ЦенаТовара,10,2));		//Стоимость
						//ШтрихКоды		= ЗАМЕНИТЬ( ЗАПРОС( "SELECT dbo.fn_getbarcodes_ex( '" + Спецификация.nn + "' )" ), ",", "|" );
						
						IF (АлкоКодВ <> "" AND АлкоДок == true)
						{
							documentItem.SetField("Алко", true);
							documentItem.SetField("АлкоКодВ", АлкоКодВ); 			//Код вида алкогольной продукции
							documentItem.SetField("АлкоНаим", АлкоНаим);			//Наименование вида алкогольной продукции
							documentItem.SetField("АлкоОбъем", Объем);				//Объем
							documentItem.SetField("АлкоКрепость", Крепость);		//Крепость
							documentItem.SetField("Производитель", ПроизводительИмя);//Производитель
							documentItem.SetField("ПроизвИНН", ПроизводительИНН);	//ИНН Производителя
							documentItem.SetField("ПроизвКПП", ПроизводительКПП);	//КПП Производителя
							documentItem.SetField("АлкоКод", Алкокод);				//Код алкогольной продукции	
							//documentItem.SetField("АлкоПДФ", Алкомарка);			//Марка
						}
						document.DeclaredItems.Add(documentItem);
					}
					ПРОПУСТИТЬ( 1, "Спецификация" );
				}
			}
			УДАЛИТЬКОНТЕКСТ( "Спецификация" );
			
			//добавление документа в коллекцию выгружаемых документов
			outDocuments.Add(document);
		}
		ПРОПУСТИТЬ( 1, "СписокДокументов" );
	}
	УДАЛИТЬКОНТЕКСТ( "СписокДокументов" );
//выгрузка документов
connector.SetDocuments(outDocuments);
}
