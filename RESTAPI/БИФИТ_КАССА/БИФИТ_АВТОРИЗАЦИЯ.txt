// Токены авторизации храним в контексте мз трех полей КодОборудования, Токен, ВремяАвторизации
IF ( !ВЫБРАТЬКОНТЕКСТ( "ТокеныБифит" ) )
	IF ( !ДОБАВИТЬКОНТЕКСТ( "LOCAL: Предприятие char, Токен char, ВремяАвторизации int", "ТокеныБифит" ) ) RETURN "";

ВЫБРАТЬКОНТЕКСТ( "ТокеныБифит" );
ПЕРЕЙТИВНАЧАЛО( "ТокеныБифит" );
НАШЛИ			= false;
Предприятие		= UPPER( ALLTRIM( КОДОБОРУДОВАНИЯ ) );
_ERRORCODE		= 0;
WHILE ( !КОНЕЦКОНТЕКСТА( "ТокеныБифит" ) && !НАШЛИ )
{
	Нашли		= UPPER( ALLTRIM( ТокеныБифит.Предприятие ) ) == Предприятие;
	IF ( !НАШЛИ ) ПРОПУСТИТЬ( 1, "ТокеныБифит" );
}
IF ( !НАШЛИ )
{
	ДОБАВИТЬСТРОКИ( 1, "ТокеныБифит" );
	ИЗМЕНИТЬПОЛЕ( "ТокеныБифит", "Предприятие", Предприятие );
}
ELSE IF ( ( TICKCOUNT( ) - ТокеныБифит.ВремяАвторизации ) < 100000 && !ПУСТО( ТокеныБифит.Токен ) ) RETURN ТокеныБифит.Токен;

БифитТокен = "";
АдресСервера = "https://kassa.bifit.com";
Заголовки[0] = "Content-Type: application/x-www-form-urlencoded";
Заголовки[1] = "Accept: */*";
Заголовки[2] = "Accept-Encoding: gzip, deflate, br";

try
{
	Данные = "username=" + ЛОГИН + "&password=" + RESTAPI.URLENCODING(SHA256(ПАРОЛЬ,"S")) + "&client_id=cashdesk-rest-client&client_secret=cashdesk-rest-client&grant_type=password";
	
	ТекстОшибки			= "Сервер " + АдресСервера + CHR( 13 ) + "вернул сообщение об ошибке: " + CHR( 13 );
	Соединение 			= HTTPCONNECT( АдресСервера,"", true, ИмяФайлаЖурнала );
	ПерекодированныеДанные	= Данные;
	Ответ				= ПЕРЕКОДИРОВАТЬ( HTTPPOST( Соединение, "/cashdesk-api/v1/oauth/token", ПерекодированныеДанные, "Заголовки" ), "UTF-8", "ANSI" );	
		
	IF ( !RESTAPI.БИФИТ_ПРОВЕРКАНАОШИБКИ( @Ответ ) ) THROW ( Ответ );
	ЗАГРУЗИТЬJSON( "Авторизация", Ответ );
	if ( ТИП( "Авторизация.access_token" ) != "C" ) THROW( ТекстОшибки + Ответ );
	БифитТокен			= ЗНАЧЕНИЕПОЛЯ( "Авторизация", "access_token" );
}
catch ( ТекстСообщения )
{
	HTTPCLOSE( Соединение );
	СООБЩЕНИЕ( ТекстСообщения );
	ИЗМЕНИТЬПОЛЕ( "ТокеныБифит", "Токен", "" );
	RETURN "";
}
HTTPCLOSE( Соединение );	

//запишем токен и время авторизации в контекст с токеном
ИЗМЕНИТЬПОЛЕ( "ТокеныБифит", "Токен", БифитТокен );
ИЗМЕНИТЬПОЛЕ( "ТокеныБифит", "ВремяАвторизации", TICKCOUNT( ) );

Заголовки[0] = "";
Заголовки[1] = "";
Заголовки[2] = "";

RETURN БифитТокен;
