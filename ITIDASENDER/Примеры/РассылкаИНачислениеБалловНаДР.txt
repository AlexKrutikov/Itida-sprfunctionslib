//заполним контекст клиентами владельцами дисконтных карт (только с картами, которые не заблокированы и с действующим сроком)
ДОБАВИТЬКОНТЕКСТ("SELECT client.code AS clientcode, card.code AS cardcode, ISNULL(client.ctext, client.name) AS clientname, client.telefon, client.birthdate AS birthdate, client.clientgroup, client.cardn AS clientcardn,
client.sex, card.name AS cardname, card.cardn AS cardn, card.card_type, card.block, card.note AS cardnote, card.str_date, card.end_date
FROM sprmclient client
INNER JOIN sprmcard card ON client.code = card.client
WHERE client.folder = 0 AND client.notavail = 0 AND card.block <> 1 AND DATEDIFF(day, card.str_date, GETDATE()) >= 0 AND DATEDIFF(day, card.end_date, GETDATE()) <= 0", "КлиентыКарты");
ВЫБРАТЬКОНТЕКСТ("КлиентыКарты");
КоличествоНачислений = 0;
WHILE (!КОНЕЦКОНТЕКСТА("КлиентыКарты"))
{
	ДатаРождения = КлиентыКарты.birthdate;
	ДатаРожденияМЕСЯЦ = МЕСЯЦ(ДатаРождения);
	ДатаРожденияДЕНЬ = ДЕНЬ(ДатаРождения);
	
	ТЕКУЩАЯДАТА = Дата();
	
	ТекущаяДатаДЕНЬ = ДЕНЬ(ТЕКУЩАЯДАТА);
	ТекущаяДатаМЕСЯЦ = МЕСЯЦ(ТЕКУЩАЯДАТА);
	ТекущаяДатаГОД = ГОД(ТЕКУЩАЯДАТА);
	
	ДАТАРОЖДЕНИЯСРАВНЕНИЕТЕКСТ = ALLTRIM(ДатаРожденияДЕНЬ) + "." + ALLTRIM(ДатаРожденияМЕСЯЦ) + "." + ALLTRIM(ТекущаяДатаГОД);
	ДАТАРОЖДЕНИЯСРАВНЕНИЕ = CTOD(ДАТАРОЖДЕНИЯСРАВНЕНИЕТЕКСТ);
	
	//условие - за 1 день до ДР начисляются 500 бонусов и действуют за 1д до ДР, в день ДР и 7 дней после
	//сроком управлять будет Фронтол, мы будем только начислять и отправлять смс тому, у кого ДР
	РазницаВДатах = DATEDIFF(ТЕКУЩАЯДАТА,ДАТАРОЖДЕНИЯСРАВНЕНИЕ, 'day');
	//СООБЩЕНИЕ("ДАТАРОЖДЕНИЯСРАВНЕНИЕ: " + ALLTRIM(ДАТАРОЖДЕНИЯСРАВНЕНИЕ) + CHR(13) + CHR(10) + "Дата текстом: " + ДАТАРОЖДЕНИЯСРАВНЕНИЕТЕКСТ + CHR(13) + CHR(10) + "Разница с текущей датой (дней): " + РазницаВДатах);
	IF ( РазницаВДатах >= -1 AND РазницаВДатах <= 7 )
	{
		КодКарты = КлиентыКарты.cardcode;
		НомерКарты = КлиентыКарты.cardn;
		Телефон = КлиентыКарты.telefon;
		ИмяКлиента = КлиентыКарты.clientname;
				
		КодСчетчикаДР = 3;
		СуммаНачисленияДР = 500;
		ДОБАВИТЬКОНТЕКСТ("SELECT * FROM specmcard_counters WHERE cardn= '" + STDF( НомерКарты ) + "' AND counter = '" + КодСчетчикаДР + "'", "ДанныеПоНачислениям", 1);
		ВЫБРАТЬКОНТЕКСТ("ДанныеПоНачислениям");
		IF ( КОЛИЧЕСТВОСТРОК("ДанныеПоНачислениям") > 0 )
		{
			ДатаИзменения = ДанныеПоНачислениям.edit_dat;
			ДатаИзмененияГОД = ГОД(ДатаИзменения);
			ДатаИзмененияМЕСЯЦ = МЕСЯЦ(ДатаИзменения);
			ДатаИзмененияДЕНЬ = ДЕНЬ(ДатаИзменения);
			//если в этом году начисляли, то пропускаем
			IF ( ДатаИзмененияГОД == ТекущаяДатаГОД )
			{
				УДАЛИТЬКОНТЕКСТ("ДанныеПоНачислениям");
				ВЫБРАТЬКОНТЕКСТ("КлиентыКарты");
				ПРОПУСТИТЬ( 1, "КлиентыКарты");
				CONTINUE;
			}
		}
		
		КоличествоНачислений++;
		// Обновляем информацию о начислениях и бонусах
		ЗАПРОС("DELETE FROM specmcard_counters WHERE cardn= '" + STDF( НомерКарты ) + "' AND counter = '" + КодСчетчикаДР + "'" );
		// Добавляем сумму к начислению к общей сумме начислений и сумму бонуса к общей сумме бонусов
		ЗАПРОС("INSERT INTO specmcard_counters (cardn, date, counter, summa )
			   VALUES ('" + STDF( НомерКарты ) + "', '', '" + КодСчетчикаДР + "', " + STR( СуммаНачисленияДР, 20, 8 ) + ")");
			   
		//оповестим пользователя о начислении бонусов
		ТекстСообщения = ALLTRIM(ИмяКлиента) + ". Подзравляем вас с днём рождения! Вам начислено " + СуммаНачисленияДР + " бонусов, которыми вы можете оплатить до 20% от суммы чека в течение недели в нашем кафе.";
		ITIDASENDER.СМСЦЕНТР_ОТПРАВКАСМС(Телефон, ТекстСообщения);
		
		УДАЛИТЬКОНТЕКСТ("ДанныеПоНачислениям");
		ВЫБРАТЬКОНТЕКСТ("КлиентыКарты");
	}
	ПРОПУСТИТЬ( 1, "КлиентыКарты");
}
IF (КоличествоНачислений == 0)
	СООБЩЕНИЕ("Нет клиентов с ближайшими ДР для рассылки СМС");
ELSE
	СООБЩЕНИЕ("Отправлено " + КоличествоНачислений + " СМС");
