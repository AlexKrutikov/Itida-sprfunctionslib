IF ( ПУСТО( КОДШАБЛОНА ) )
{
	СООБЩЕНИЕ("Не определен ИД Шаблона для привязки карт","LoCards - выгрузка карт");
	RETURN false;
}

IF ( ПУСТО( ДАННЫЕПОКАРТАМ ) )
{
	СООБЩЕНИЕ("Не определен список карт для выгрузки", "LoCards - выгрузка карт");
	RETURN false;
}

ИмяФайлаСКартами = RESTAPI.LOCARDS_ФайлОбмена("", "ВЫГРУЗКАCSV");

ФайлОбмена	= ФАЙЛОТКРЫТЬ( ИмяФайлаСКартами, 1, 1 );
ФАЙЛУСТАНОВИТЬУКАЗАТЕЛЬ( ФайлОбмена, 0, 0, 2 );
ФАЙЛЗАПИСАТЬСТРОКУ( ФайлОбмена, CHR( 0xef ) + CHR( 0xbb ) + CHR( 0xbf ) + ПЕРЕКОДИРОВАТЬ(  ДАННЫЕПОКАРТАМ, "ANSI", "UTF-8" ) );
ФАЙЛЗАКРЫТЬ( ФайлОбмена );

Локардс_JWTToken = RESTAPI.LOCARDS_JWTToken();
IF ( ПУСТО( Локардс_JWTToken ) )
{
	СООБЩЕНИЕ("Не определен токен для обмена с LoCards","LoCards");
	RETURN false;
}

УспешноеВыполнение = false;
Локардс_АдресСервера = "https://api.lo.cards";
АдресРесурса = "/v1/card/import?templateId="+КОДШАБЛОНА;

ОТВЕТ_локардс = "";
Граница				= "------------------------975764a1c0b00c61";

ФайлОбмена	= ФАЙЛОТКРЫТЬ( ИмяФайлаСКартами, 1, 1 );
ФАЙЛУСТАНОВИТЬУКАЗАТЕЛЬ(ФайлОбмена, 0);
СТРОКАДАННЫХ = ФАЙЛПРОЧИТАТЬ(ФайлОбмена, "S", ФАЙЛРАЗМЕР(ФайлОбмена) );
ФАЙЛЗАКРЫТЬ( ФайлОбмена );

СТРОКАДЛЯОТПРАВКИ	= "--" + Граница + CHR( 13 ) + CHR( 10 ) + "Content-Disposition: form-data; name=""file""; filename=""" + ИмяФайлаОбмена + """" + CHR( 13 ) + CHR( 10 ) + 
														"Content-Type: application/vnd.ms-excel" + CHR( 13 ) + CHR( 10 ) + CHR( 13 ) + CHR( 10 ) + СТРОКАДАННЫХ + CHR( 13 ) + CHR( 10 ) + 
														"--" + Граница + "--" + CHR( 13 ) + CHR( 10 );

Заголовки[0] = "Authorization: Bearer " + ALLTRIM( Локардс_JWTToken );	
Заголовки[1] = "Content-Type: multipart/form-data; boundary=" + Граница;	

СИСТЕМНОЕСООБЩЕНИЕ("Отправка запроса со списком карт в LoCards");
ОТВЕТ_локардс = RESTAPI.LOCARDS_POSTЗАПРОС( Локардс_АдресСервера, АдресРесурса, СТРОКАДЛЯОТПРАВКИ, "Заголовки" );

IF ( !ПУСТО( ОТВЕТ_локардс) AND ОТВЕТ_локардс != false )
	УспешноеВыполнение = ПОЛЕ_JSON( ОТВЕТ_локардс, "success", false);

RETURN УспешноеВыполнение == true OR УспешноеВыполнение == "true";
