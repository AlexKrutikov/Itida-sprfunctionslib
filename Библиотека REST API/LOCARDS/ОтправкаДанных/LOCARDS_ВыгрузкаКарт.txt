Локардс_Токен = RESTAPI.LOCARDS_TOKEN( "" );
IF ( ПУСТО(Локардс_Токен) )
{
	СООБЩЕНИЕ("Не определен токен LOCARDS. " + CHR(13) + CHR(10) + "Выгрузка карт в Locards проведена не будет.", "Locards - выгрузка карт");
	RETURN false;
}

УСЛОВИЕПОКАРТАМ = "";
IF ( !ПУСТО( СПИСОККАРТ ) )
{
	ИмяТаблицы			= "##" + УНИКАЛЬНОЕИМЯ( );
	ЗАПРОС( "CREATE TABLE " + ИмяТаблицы + "( cardNumber char(30) ) " );
									
	IF ( !ДОБАВИТЬКОНТЕКСТ( "LOCAL: id char(20), cardNumber char(30), phone char(11), firstName varchar(30), lastName varchar(30), middleName varchar(30), birthday datetime, balance float", "КартыЛокардс" ) ) RETURN false;
	
	ЗАГРУЗИТЬJSON("ВсеКарты", СПИСОККАРТ, "Карта");
	ЗАГРУЗИТЬ( "КартыЛокардс", "JSON", ЗНАЧЕНИЕПОЛЯ( "ВсеКарты", "Карта" ) );
	ВЫГРУЗИТЬ( ИмяТаблицы, "cardNumber", "", "КартыЛокардс" );
	
	УСЛОВИЕПОКАРТАМ = " AND cardn not in ( SELECT cardNumber FROM " + ИмяТаблицы + ")";
}

//сформируем массив карт для выгрузки
ДОБАВИТЬКОНТЕКСТ("SELECT
					name, 
					REPLACE( REPLACE( REPLACE( telefon, '+', ''), '-', ''), ' ', '') AS Телефон, 
					cardn AS НомерКарты, 
					birthdate AS ДеньРождения,
					sex AS Пол,
					0 AS Накопления,
					dbo.fn_calccard_bonus( cardn, 'БОНУС', GETDATE() ) AS Баланс,
					dbo.fn_calccard_turnover( card, '', 0 ) AS ВсегоПотречено
				FROM sprmclient
				WHERE notavail = 0 AND cardn <> '' AND name <> '' AND telefon <> '' AND LEN(telefon) = 11 
				AND datalength(RTRIM(name)) - datalength(replace(RTRIM(name), ' ', '')) > 0 " + УСЛОВИЕПОКАРТАМ, "СписокКартКлиентов");
				
СписокКарт = "";
ПОКА ( !КОНЕЦКОНТЕКСТА( "СписокКартКлиентов" ) )
{
	ДанныеКарты = "";
	ДанныеКарты += "{";
	ДанныеКарты += ДАННЫЕ_JSON("firstName", ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 2 ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("middleName", ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 3 ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("lastName", ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 1 ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("phone", ЕСЛИ( ЛЕВСИМВ( СписокКартКлиентов.Телефон, 1 ) == "8", "7" + ПРАВСИМВ( СписокКартКлиентов.Телефон, ДЛИНА( СписокКартКлиентов.Телефон ) - 1 ), СписокКартКлиентов.Телефон ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("cardNumber", СписокКартКлиентов.НомерКарты ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("categoryId", "" ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("birthday", DTOC( СписокКартКлиентов.ДеньРождения, 7, "-" ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("gender", СписокКартКлиентов.Пол ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("balance", ЕСЛИ( СписокКартКлиентов.Баланс < 0, 0, СписокКартКлиентов.Баланс ) );
	ДанныеКарты += "}";
	
	СписокКарт += ЕСЛИ( !ПУСТО( СписокКарт ), ",", "") + ДанныеКарты;
	ПРОПУСТИТЬ( 1, "СписокКартКлиентов" );
}
УДАЛИТЬКОНТЕКСТ("СписокКартКлиентов");

ТелоЗапроса = "{" + """cards"": [" + СписокКарт + "], ""pushScheduledAt"": 0" + "}";

УспешноеВыполнение = false;
Локардс_АдресСервера = "https://api.lo.cards";

АдресРесурса = "/v1/crm/card/import";

Заголовки[0] = "Authorization: Bearer " + ALLTRIM( Локардс_Токен );	
Заголовки[1] = "Content-Type: application/json; charset=utf-8";	
	
ОТВЕТ_локардс = RESTAPI.LOCARDS_POSTЗАПРОС( Локардс_АдресСервера, АдресРесурса, ТелоЗапроса, "Заголовки" );

IF ( !ПУСТО( ОТВЕТ_локардс) AND ОТВЕТ_локардс != false )
	УспешноеВыполнение = ПОЛЕ_JSON( ОТВЕТ_локардс, "success", false);
	

RETURN УспешноеВыполнение == true OR УспешноеВыполнение == "true";
