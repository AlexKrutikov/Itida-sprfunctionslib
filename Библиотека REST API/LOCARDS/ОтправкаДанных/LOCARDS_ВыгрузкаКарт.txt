Локардс_Токен = RESTAPI.LOCARDS_TOKEN( "" );
IF ( ПУСТО(Локардс_Токен) )
{
	СООБЩЕНИЕ("Не определен токен LOCARDS. " + CHR(13) + CHR(10) + "Выгрузка карт в Locards проведена не будет.", "Locards - выгрузка карт");
	RETURN false;
}

//создадим временную таблицу для карт из Локардс
ИмяТаблицы			= "##" + УНИКАЛЬНОЕИМЯ( );
ЗАПРОС( "CREATE TABLE " + ИмяТаблицы + "( cardNumber char(30), phone char(11) ) " );

УСЛОВИЕПОКАРТАМ = "";
IF ( !ПУСТО( СПИСОККАРТ ) )
{										
	ЗАГРУЗИТЬJSON("КартыЛокардс", СПИСОККАРТ, "Данные");
	ПОКА ( !КОНЕЦКОНТЕКСТА("КартыЛокардс") )
	{
		ЗАПРОС("INSERT INTO " + ИмяТаблицы + " (cardNumber, phone)
				VALUES ('" + ПОЛЕ_JSON( КартыЛокардс.Данные, "cardNumber") + "','" +  ПОЛЕ_JSON( КартыЛокардс.Данные, "phone") + "') ");
				
		ПРОПУСТИТЬ(1, "КартыЛокардс");
	}	
	
	УСЛОВИЕПОКАРТАМ = " AND cardn not in ( SELECT cardNumber FROM " + ИмяТаблицы + ") AND REPLACE( REPLACE( REPLACE( telefon, '+', ''), '-', ''), ' ', '') not in ( SELECT phone FROM " + ИмяТаблицы + ")";
	
	УДАЛИТЬКОНТЕКСТ("КартыЛокардс");
}

//сформируем массив карт для выгрузки
ДОБАВИТЬКОНТЕКСТ("SELECT
					name, 
					REPLACE( REPLACE( REPLACE( telefon, '+', ''), '-', ''), ' ', '') AS Телефон, 
					cardn AS НомерКарты, 
					birthdate AS ДеньРождения,
					CASE WHEN sex = 0 THEN 1 ELSE sex END AS Пол,
					0 AS Накопления,
					dbo.fn_calccard_bonus( cardn, 'БОНУС', GETDATE() ) AS Баланс,
					dbo.fn_calccard_turnover( card, '', 0 ) AS ВсегоПотречено
				FROM sprmclient
				WHERE notavail = 0 AND cardn <> '' AND name <> '' AND telefon <> '' AND LEN(telefon) = 11 
				AND datalength(RTRIM(name)) - datalength(replace(RTRIM(name), ' ', '')) > 0 " + УСЛОВИЕПОКАРТАМ, "СписокКартКлиентов");

ВсегоКартКлиентов = КОЛИЧЕСТВОСТРОК("СписокКартКлиентов");
ИНДИКАТОР("Выгрузка карт клиентов", ВсегоКартКлиентов);
ВЫБРАТЬКОНТЕКСТ("СписокКартКлиентов");
СписокКарт = "";
ПОКА ( !КОНЕЦКОНТЕКСТА( "СписокКартКлиентов" ) )
{
	IF ( НОМЕРСТРОКИ("СписокКартКлиентов") % 100 == 0 ) ИНДИКАТОР( НОМЕРСТРОКИ( "СписокКартКлиентов" ), "Выгрузка карты " + НомерСтроки("СписокКартКлиентов") + " из " + ВсегоКартКлиентов);
	ДанныеКарты = "";
	ДанныеКарты += "{";
	ДанныеКарты += ДАННЫЕ_JSON("firstName", ПЕРЕКОДИРОВАТЬ( ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 2 ) , "ANSI", "UTF-8" ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("middleName", ПЕРЕКОДИРОВАТЬ( ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 3 ) , "ANSI", "UTF-8" ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("lastName", ПЕРЕКОДИРОВАТЬ( ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 1 ) , "ANSI", "UTF-8" ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("phone", ЕСЛИ( ЛЕВСИМВ( СписокКартКлиентов.Телефон, 1 ) == "8", "7" + ПРАВСИМВ( СписокКартКлиентов.Телефон, ДЛИНА( СписокКартКлиентов.Телефон ) - 1 ), СписокКартКлиентов.Телефон ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("cardNumber", СписокКартКлиентов.НомерКарты ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("categoryId", "1" ) + ",";
	ДанныеКарты += """birthday"":""" + DTOC( СписокКартКлиентов.ДеньРождения, 7, "-" ) + """" + ",";
	ДанныеКарты += ДАННЫЕ_JSON("gender", СписокКартКлиентов.Пол ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("balance", ЕСЛИ( СписокКартКлиентов.Баланс < 0, 0, СписокКартКлиентов.Баланс ) );
	ДанныеКарты += "}";
	
	СписокКарт += ЕСЛИ( !ПУСТО( СписокКарт ), ",", "") + ДанныеКарты;
	ПРОПУСТИТЬ( 1, "СписокКартКлиентов" );
}
УДАЛИТЬКОНТЕКСТ("СписокКартКлиентов");

ЗАПРОС("DROP TABLE " + ИмяТаблицы);

IF ( !ПУСТО( СписокКарт ) )
{
	ТелоЗапроса = "{" + """cards"": [" + СписокКарт + "], ""pushScheduledAt"": 0" + "}";

	УспешноеВыполнение = false;
	Локардс_АдресСервера = "https://api.lo.cards";

	АдресРесурса = "/v1/crm/card/import";

	Заголовки[0] = "Authorization: Bearer " + ALLTRIM( Локардс_Токен );	
	Заголовки[1] = "Content-Type: application/json; charset=utf-8";	
	
	СИСТЕМНОЕСООБЩЕНИЕ("Отправка запроса со списком карт в LoCards");
	ОТВЕТ_локардс = RESTAPI.LOCARDS_POSTЗАПРОС( Локардс_АдресСервера, АдресРесурса, ТелоЗапроса, "Заголовки" );

	IF ( !ПУСТО( ОТВЕТ_локардс) AND ОТВЕТ_локардс != false )
		УспешноеВыполнение = ПОЛЕ_JSON( ОТВЕТ_локардс, "success", false);
}
ELSE
{
	СООБЩЕНИЕ("Нет новых карт для выгрузки", "LoCards - выгрузка карт");
	УспешноеВыполнение = true;
}
	
ИНДИКАТОР();	
СИСТЕМНОЕСООБЩЕНИЕ();

RETURN УспешноеВыполнение == true OR УспешноеВыполнение == "true";
