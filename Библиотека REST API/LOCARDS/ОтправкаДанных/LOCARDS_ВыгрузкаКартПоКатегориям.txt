Локардс_Токен = RESTAPI.LOCARDS_TOKEN( "" );
IF ( ПУСТО(Локардс_Токен) )
{
	СООБЩЕНИЕ("Не определен токен LOCARDS. " + CHR(13) + CHR(10) + "Выгрузка карт в Locards проведена не будет.", "Locards - выгрузка карт");
	RETURN false;
}

//создадим временную таблицу для карт из Локардс
ИмяТаблицы			= "##" + УНИКАЛЬНОЕИМЯ( );
ЗАПРОС( "CREATE TABLE " + ИмяТаблицы + "( cardNumber char(30), phone char(11) ) " );

УСЛОВИЕПОКАРТАМ = "";
IF ( !ПУСТО( СПИСОККАРТ ) )
{										
	ЗАГРУЗИТЬJSON("КартыЛокардс", СПИСОККАРТ, "Данные");
	ПОКА ( !КОНЕЦКОНТЕКСТА("КартыЛокардс") )
	{
		ЗАПРОС("INSERT INTO " + ИмяТаблицы + " (cardNumber, phone)
				VALUES ('" + ПОЛЕ_JSON( КартыЛокардс.Данные, "cardNumber") + "','" +  ПОЛЕ_JSON( КартыЛокардс.Данные, "phone") + "') ");
				
		ПРОПУСТИТЬ(1, "КартыЛокардс");
	}	
	
	УСЛОВИЕПОКАРТАМ = " AND client.cardn not in ( SELECT cardNumber FROM " + ИмяТаблицы + ") AND REPLACE( REPLACE( REPLACE( client.telefon, '+', ''), '-', ''), ' ', '') not in ( SELECT phone FROM " + ИмяТаблицы + ")";
	
	УДАЛИТЬКОНТЕКСТ("КартыЛокардс");
}

//сформируем массив карт для выгрузки
ДОБАВИТЬКОНТЕКСТ("SELECT
					client.name, 
					REPLACE( REPLACE( REPLACE( client.telefon, '+', ''), '-', ''), ' ', '') AS Телефон, 
					card.cardn AS НомерКарты, 
					client.birthdate AS ДеньРождения,
					CASE WHEN client.sex = 0 THEN 1 ELSE client.sex END AS Пол,
					0 AS Накопления,
					dbo.fn_calccard_bonus( card.cardn, 'БОНУС', GETDATE() ) AS Баланс,
					dbo.fn_calccard_turnover( card.code, '', 0 ) AS ВсегоПотречено,
					card.discount, card.bonus,
					(SELECT ctext FROM sprbonus WHERE code = card.bonus) AS ШаблонБонус,
					(SELECT ctext FROM specmdiscount WHERE code = card.discount) AS ШаблонСкидка
				FROM sprmclient client
				INNER JOIN sprmcard card ON client.card = card.code OR card.client = client.code
				WHERE client.notavail = 0 AND client.cardn <> '' AND client.name <> '' AND client.telefon <> '' AND LEN(client.telefon) >= 11 AND LEN(client.telefon) <= 12
				AND datalength(RTRIM(client.name)) - datalength(replace(RTRIM(client.name), ' ', '')) > 0  " + УСЛОВИЕПОКАРТАМ, "СписокКартКлиентов");

ВсегоКартКлиентов = КОЛИЧЕСТВОСТРОК("СписокКартКлиентов");
ИНДИКАТОР("Выгрузка карт клиентов", ВсегоКартКлиентов);
ВЫБРАТЬКОНТЕКСТ("СписокКартКлиентов");
СписокКарт = "";
ПОКА ( !КОНЕЦКОНТЕКСТА( "СписокКартКлиентов" ) )
{
	IF ( НОМЕРСТРОКИ("СписокКартКлиентов") % 100 == 0 ) ИНДИКАТОР( НОМЕРСТРОКИ( "СписокКартКлиентов" ), "Выгрузка карты " + НомерСтроки("СписокКартКлиентов") + " из " + ВсегоКартКлиентов);
	
	НазваниеКатегории = "";
	IF ( !ПУСТО(СписокКартКлиентов.discount) )
		НазваниеКатегории = СписокКартКлиентов.ШаблонСкидка;
	ELSE
		НазваниеКатегории = СписокКартКлиентов.ШаблонБонус;	
	
	ДанныеКарты = "";
	ДанныеКарты += "{";
	ДанныеКарты += ДАННЫЕ_JSON("firstName", ПЕРЕКОДИРОВАТЬ( ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 2 ) , "ANSI", "UTF-8" ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("middleName", ПЕРЕКОДИРОВАТЬ( ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 3 ) , "ANSI", "UTF-8" ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("lastName", ПЕРЕКОДИРОВАТЬ( ПОЛУЧИТЬСЛОВО( " " + СписокКартКлиентов.name + " ", " ", " ", 1 ) , "ANSI", "UTF-8" ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("phone", ЕСЛИ( ЛЕВСИМВ( СписокКартКлиентов.Телефон, 1 ) == "8", "7" + ПРАВСИМВ( СписокКартКлиентов.Телефон, ДЛИНА( СписокКартКлиентов.Телефон ) - 1 ), СписокКартКлиентов.Телефон ) ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("cardNumber", СписокКартКлиентов.НомерКарты ) + ",";	
	ДанныеКарты += """birthday"":""" + DTOC( СписокКартКлиентов.ДеньРождения, 7, "-" ) + """" + ",";
	ДанныеКарты += ДАННЫЕ_JSON("gender", СписокКартКлиентов.Пол ) + ",";
	ДанныеКарты += ДАННЫЕ_JSON("balance", ЕСЛИ( СписокКартКлиентов.Баланс < 0, 0, СписокКартКлиентов.Баланс ) );
	ДанныеКарты += ДАННЫЕ_JSON("categoryId", ПЕРЕКОДИРОВАТЬ( НазваниеКатегории, "ANSI", "UTF-8" ) );
	ДанныеКарты += "}";
	
	СписокКарт += ЕСЛИ( !ПУСТО( СписокКарт ), ",", "") + ДанныеКарты;
	ПРОПУСТИТЬ( 1, "СписокКартКлиентов" );
}
УДАЛИТЬКОНТЕКСТ("СписокКартКлиентов");

ЗАПРОС("DROP TABLE " + ИмяТаблицы);

IF ( !ПУСТО( СписокКарт ) )
{
	ТелоЗапроса = "{" + """cards"": [" + СписокКарт + "], ""pushScheduledAt"": 0" + "}";

	УспешноеВыполнение = false;
	Локардс_АдресСервера = "https://api.lo.cards";

	АдресРесурса = "/v1/crm/card/import";

	Заголовки[0] = "Authorization: Bearer " + ALLTRIM( Локардс_Токен );	
	Заголовки[1] = "Content-Type: application/json; charset=utf-8";	
	
	СИСТЕМНОЕСООБЩЕНИЕ("Отправка запроса со списком карт в LoCards");
	ОТВЕТ_локардс = RESTAPI.LOCARDS_POSTЗАПРОС( Локардс_АдресСервера, АдресРесурса, ТелоЗапроса, "Заголовки" );

	IF ( !ПУСТО( ОТВЕТ_локардс) AND ОТВЕТ_локардс != false )
		УспешноеВыполнение = ПОЛЕ_JSON( ОТВЕТ_локардс, "success", false);
}
ELSE
{
	СООБЩЕНИЕ("Нет новых карт для выгрузки", "LoCards - выгрузка карт");
	УспешноеВыполнение = true;
}
	
ИНДИКАТОР();	
СИСТЕМНОЕСООБЩЕНИЕ();

RETURN УспешноеВыполнение == true OR УспешноеВыполнение == "true";
