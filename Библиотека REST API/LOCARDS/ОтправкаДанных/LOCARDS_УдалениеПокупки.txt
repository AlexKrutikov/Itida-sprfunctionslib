IF ( ПУСТО( ИДЕНТИФИКАТОРЧЕКА ) )
{
	СООБЩЕНИЕ("Не определен идентификатор чека. " + CHR(13) + CHR(10) + "Отравка операции отмены в Locards проведена не будет.", "Locards - отправка отмены операции");
	RETURN false;
}

IF ( ПУСТО( ИДЕНТИФИКАТОРОСНОВАНИЯ ) AND ЭТОВОЗВРАТ == true )
{
	СООБЩЕНИЕ("Не определен идентификатор чека основания. " + CHR(13) + CHR(10) + "Отравка операции отмены в Locards проведена не будет.", "Locards - отправка отмены операции");
	RETURN false;
}

IF ( ПУСТО( НОМЕРКАРТЫ ) ) 
{
	//СООБЩЕНИЕ("Не определен номер карты. " + CHR(13) + CHR(10) + "Отравка операции отмены в Locards проведена не будет.", "Locards - отправка отмены операции");
	RETURN false;
}

Локардс_Токен = RESTAPI.LOCARDS_TOKEN( НОМЕРКАРТЫ );
IF ( ПУСТО(Локардс_Токен) )
{
	СООБЩЕНИЕ("Не определен токен LOCARDS. " + CHR(13) + CHR(10) + "Отравка операции отмены в Locards проведена не будет.", "Locards - отправка отмены операции");
	RETURN false;
}

//_ЧЕКДЛЯОТМЕНЫ = ЗАПРОС("SELECT identity_column FROM chequelist WHERE rid = '" + ИДЕНТИФИКАТОРОСНОВАНИЯ + "'");
IF ( ЭТОВОЗВРАТ == true )
{
	ДОБАВИТЬКОНТЕКСТ("SELECT ch1.subtotal - ch2.subtotal AS delta, ch1.identity_column FROM chequelist ch1 
					INNER JOIN chequelist ch2 ON CONVERT( varchar( 50 ), ch1.rid ) = ch2.deal
					WHERE ch2.deal = '" + ИДЕНТИФИКАТОРОСНОВАНИЯ + "' AND ch2.identity_column = '" + ИДЕНТИФИКАТОРЧЕКА + "'", "ДанныеДляОтмены");

					
	ВЫБРАТЬКОНТЕКСТ("ДанныеДляОтмены");

	IF ( КОЛИЧЕСТВОСТРОК("ДанныеДляОтмены") == 0 )
	{
		СООБЩЕНИЕ("Не определены данные по чеку для отмены операции в системе LOCARDS. " + CHR(13) + CHR(10) + "Отравка операции отмены в Locards проведена не будет.", "Locards - отправка отмены операции");
		RETURN false;
	}
	РазницаСумм = ДанныеДляОтмены.delta;
	_ЧЕКДЛЯОТМЕНЫ = ДанныеДляОтмены.identity_column;
	УДАЛИТЬКОНТЕКСТ("ДанныеДляОтмены");
}
ELSE
{
	РазницаСумм = 0;
	_ЧЕКДЛЯОТМЕНЫ = ИДЕНТИФИКАТОРЧЕКА;
}

IF ( РазницаСумм <> 0 )
{
	СООБЩЕНИЕ(	"Сумма чека основания отличается от суммы текущего чека. " + CHR(13) + CHR(10) + 
				"Отравка операции отмены в Locards проведена не будет." + CHR(13) + CHR(10) + CHR(13) + CHR(10) + 
				"Произведите изменение баллов клиента вручную в личном кабинете", "Locards - отправка отмены операции");
	RETURN false;
}

УспешноеВыполнение = false;
Локардс_АдресСервера = "https://api.lo.cards";

АдресРесурса = "/v1/crm/sale/" + _ЧЕКДЛЯОТМЕНЫ;

Заголовки[0] = "Authorization: Bearer " + ALLTRIM( Локардс_Токен );	
Заголовки[1] = "Content-Type: application/json; charset=utf-8";	
	
ОТВЕТ_локардс = RESTAPI.LOCARDS_DELETEЗАПРОС( Локардс_АдресСервера, АдресРесурса, "Заголовки" );

IF ( !ПУСТО( ОТВЕТ_локардс) AND ОТВЕТ_локардс != false )
	УспешноеВыполнение = ПОЛЕ_JSON( ОТВЕТ_локардс, "success", false);

IF ( УспешноеВыполнение == false OR УспешноеВыполнение == "false" )
	СООБЩЕНИЕ("Не удалось удалить операцю продажи в системе Locards", "Locards - отправка отмены операции");

RETURN УспешноеВыполнение == true OR УспешноеВыполнение == "true";
