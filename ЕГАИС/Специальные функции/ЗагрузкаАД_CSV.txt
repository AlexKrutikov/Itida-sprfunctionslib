IF ( ПУСТО( ИмяФайла ) )	ИмяФайла		= ФАЙЛВЫБРАТЬ( 1, "Файлы CSV|*.csv" );IF ( ПУСТО( ИмяФайла ) ) RETURN REPLICATE( "-", 10 );// Формируем таблицу из 100 полей для первоначальной загрузки данныхИмяВременнойТаблицы		= "##" + УНИКАЛЬНОЕИМЯ( );СтрокаЗапроса			= "CREATE TABLE " + ИмяВременнойТаблицы + "( field0 varchar( 250 )";FOR ( index = 1; index < 100; index ++ )	СтрокаЗапроса		+= ",field" + STR( index ) + " varchar( 250 )";СтрокаЗапроса		+= ")";ЗАПРОС( СтрокаЗапроса );ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяВременнойТаблицы, "ЛокальныеДанные" );ЗАПРОС( "DROP TABLE " + ИмяВременнойТаблицы );	// Загружаем CSV в таблицу ЗАГРУЗИТЬ( "ЛокальныеДанные", "csv", ИмяФайла, ";" );// Создаем временную таблицу для сбора номеров накладных и объемов поставкиЗАПРОС( "CREATE TABLE " + ИмяВременнойТаблицы + "( [П000000000003] varchar( 10 ), NameOrg varchar( 250 ), INN varchar( 250 ), KPP varchar( 250 ), [П200000000013] datetime, 												   [П200000000014] varchar( 250 ), [П200000000016] float, identity_column int IDENTITY( 1, 1 ) )" );ВЫБРАТЬКОНТЕКСТ( "ЛокальныеДанные" );ПЕРЕЙТИВНАЧАЛО( "ЛокальныеДанные" );Состояние				= 0;НомерПоля				= 0;FOR ( локальный_индекс = 1; локальный_индекс <= 30; локальный_индекс++ ) ПОЛЕ[ локальный_индекс ]	= -1;WHILE ( !КОНЕЦКОНТЕКСТА( "ЛокальныеДанные" ) && Состояние != 5 ){	Состояние			= 0;	НомерПоля			= 0;	FOR ( индекс = 0; индекс < 100; индекс++ )	{		ЗначениеПоля	= СЖАТЬПРОБЕЛЫ( ЗНАЧЕНИЕПОЛЯ( индекс ) );		IF ( Состояние == 0 && !ПУСТО( ЗначениеПоля ) && VAL( ЗначениеПоля ) == НомерПоля + 1 )		{			НомерПоля++;			ПОЛЕ[ НомерПоля ]	= индекс;		}		ELSE IF ( Состояние == 0 && НомерПоля != 0 && !ПУСТО( ЗначениеПоля ) && НомерПоля < 20 )		{			// Если посчитали, что нашои подзаголовк таблицы с номерами поле, а встретилось инродное поле, то сбрасываем счетчик			НомерПоля			= 0;			FOR ( локальный_индекс = 1; локальный_индекс <= 30; локальный_индекс++ ) ПОЛЕ[ локальный_индекс ]	= -1;		}	}	// Нашли начало таблицы. Со следующей строки должны идти строки накладной	IF ( НомерПоля >= 20 )	{		ПРОПУСТИТЬ( 1, "ЛокальныеДанные" );		СТОП					= false;		WHILE ( !КОНЕЦКОНТЕКСТА( "ЛокальныеДанные" ) && !СТОП )		{			ВидПродукции		= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 2 ] );			Производитель		= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 3 ] );			ИНН					= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 4 ] );			КПП					= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 5 ] );			Дата				= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 17 ] );			Номер				= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 18 ] );			Объем				= VAL( ЗАМЕНИТЬ( ЗАМЕНИТЬ( ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 20 ] ), " ", "" ), CHR( 160 ), "" ) );			IF ( !ПУСТО( VAL( Номер ) ) )				ЗАПРОС( "INSERT INTO " + ИмяВременнойТаблицы + "( [П000000000003], NameOrg, INN, KPP, [П200000000013], [П200000000014], [П200000000016]  )						 VALUES ( '" + STDF( ВидПродукции ) + "', '" + STDF( Производитель ) + "', '" + STDF( ИНН ) + "', '" + STDF( КПП ) + "', 								  '" + ДАТАИЗСТРОКИ( Дата ) + "', '" + STDF( Номер ) + "', " + STR( Объем, 20, 8 ) + " )" );			// Добавляем запись 			ПРОПУСТИТЬ( 1, "ЛокальныеДанные" );		}	}	ПРОПУСТИТЬ( 1, "ЛокальныеДанные" );}// формируем итоги в разрезе вида продукцииТаблицаИтогов		= "##" + УНИКАЛЬНОЕИМЯ( );ЗАПРОС( "SELECT [П000000000003], [П200000000013], [П200000000014], SUM( [П200000000016] ) AS [П200000000016], CONVERT( float, 0 ) AS kolp		 INTO " + ТаблицаИтогов + "		 FROM " + ИмяВременнойТаблицы + "		 GROUP BY [П000000000003], [П200000000013], [П200000000014]" );RETURN ТаблицаИтогов;
