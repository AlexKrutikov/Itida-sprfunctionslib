// Выбираем еоходимые документы, проходим по списку и формруем акты
ЕГАИС.ИнициализироватьОбмен( );

Версия2ЕГАИС		= false; //VAL( ЗАПРОС( "SELECT value FROM param_ex WHERE param = 'EGAIS_VERSION2" + СКЛАД + "'" ) ) > 0;
Версия3ЕГАИС		= true; //VAL( ЗАПРОС( "SELECT value FROM param_ex WHERE param = 'EGAIS_VERSION3" + СКЛАД + "'" ) ) > 0;

try 
{
	// Может быть несколько типов запросов. В зависимости от этого вызываем разные методы
	IF ( ТИПЗАПРОСА == "QUERYAP" )
		RETURN ЕСЛИ( Версия2ЕГАИС OR Версия3ЕГАИС, ЕГАИС.ЗапроситьТовары_В2( ИННПАРТНЕРА ), ЕГАИС.ЗапроситьТовары( ИННПАРТНЕРА ) );
	ELSE IF ( ТИПЗАПРОСА == "QUERYPARTNER" )
		RETURN ЕСЛИ( Версия2ЕГАИС OR Версия3ЕГАИС, ЕГАИС.ЗапроситьКонтрагента_В2( ИННПАРТНЕРА ), ЕГАИС.ЗапроситьКонтрагента( ИННПАРТНЕРА ) );
	ELSE IF ( ТИПЗАПРОСА == "QUERYTTN" )
	{
		IF ( LEFT( ИННПАРТНЕРА, 6 ) == "FORMB:" )
			RETURN ЕГАИС.ЗапроситьДвиженияСправкиБ( ПОДСТРОКА( ИННПАРТНЕРА, 7 ) );
		RETURN ЕГАИС.ЗапроситьТТН( ИННПАРТНЕРА );
	}
	ELSE IF ( ТИПЗАПРОСА == "QUERYFORMBHISTORY" )
		RETURN ЕГАИС.ЗапроситьДвиженияСправкиБ( ИННПАРТНЕРА );
	ELSE IF ( ТИПЗАПРОСА == "TTN" )
		RETURN ЕГАИС.ВыгрузитьРасходныеНакладные( );
	ELSE IF ( ТИПЗАПРОСА == "BALANCE_ACT" )
		RETURN ЕГАИС.ВыгрузитьАктыПостановкиНаБаланс( );
	ELSE IF ( ТИПЗАПРОСА == "SALDO" )
		RETURN ЕСЛИ( Версия2ЕГАИС OR Версия3ЕГАИС, ЕГАИС.ЗапроситьОстатки_В2( ), ЕГАИС.ЗапроситьОстатки( ) );
	ELSE IF ( ТИПЗАПРОСА == "OUT_ACT" )
		RETURN ЕГАИС.ВыгрузитьАктыСписанияПродукции( );
	ELSE IF ( ТИПЗАПРОСА == "DELETE_URL" )
		RETURN ЕГАИС.УдалитьФайл( );
	ELSE IF ( ТИПЗАПРОСА == "QUERYAP_LIST" )
		RETURN ЕСЛИ( Версия2ЕГАИС OR Версия3ЕГАИС, ЕГАИС.ЗапроситьТоварыПоАлкоКоду_В2( ИМЯТАБЛИЦЫ ), ЕГАИС.ЗапроситьТоварыПоАлкоКоду( ИМЯТАБЛИЦЫ ) );
	ELSE IF ( ТИПЗАПРОСА == "QUERYMARKRESTS" )
		RETURN ЕГАИС.ЗапроситьОстаткиМарок( ИМЯТАБЛИЦЫ, @КодДокумента, @ИДДокумента );
	ELSE IF ( ТИПЗАПРОСА == "QUERYAP_LIST_V1" )
		RETURN ЕГАИС.ЗапроситьТоварыПоАлкоКоду( ИМЯТАБЛИЦЫ );
	ELSE IF ( ТИПЗАПРОСА == "REJECTTTNACT" )
		RETURN ЕГАИС.ВыгрузитьАктыОтменыНакладных( ИМЯТАБЛИЦЫ );
	ELSE IF ( ТИПЗАПРОСА == "CHECKMARK_LIST" )
		RETURN ЕГАИС.ВыгрузитьСписокМарокВФайл( ИМЯТАБЛИЦЫ, ИМЯФАЙЛА );
	ELSE IF ( ТИПЗАПРОСА == "VNP_ACT" )
		RETURN ЕГАИС.ВыгрузитьВнутренниеПеремещения( ИМЯТАБЛИЦЫ );
	ELSE IF ( ТИПЗАПРОСА == "DKS_ACT" )
		RETURN ЕГАИС.ВыгрузитьДКС( ИМЯТАБЛИЦЫ );
	ELSE IF ( ТИПЗАПРОСА == "QUERYRETAILSALDO" )
		RETURN ЕГАИС.ЗапроситьОстаткиВМагазине( );
	ELSE IF ( ТИПЗАПРОСА == "SENDVERSIONINFO" )
		RETURN ЕГАИС.ЗапросИзмененияВерсииФормата( ВЕРСИЯ );
	ELSE IF ( ТИПЗАПРОСА == "QUERYUNCHECKEDTTN" )
		RETURN ЕГАИС.ЗапроситьНеобработанныеТТН_В2( );	
	ELSE IF ( ТИПЗАПРОСА == "QUERYFORMA" )
		RETURN ЕГАИС.ЗапроситьСправкуА_В2( ИДСПРАВКИА, false);	
	ELSE IF ( ТИПЗАПРОСА == "QUERYDOCFORMA" )
		RETURN ЕГАИС.ЗапроситьИнформациюПоСправкеА( КОДДОКУМЕНТА, ИДДОКУМЕНТА );	
	ELSE IF ( ТИПЗАПРОСА == "QUERYFORMB" )
		RETURN ЕГАИС.ЗапроситьСправкуБ_В2( ИДСПРАВКИБ );	
	ELSE IF ( ТИПЗАПРОСА == "QUERYMARK" )
		RETURN ЕГАИС.ЗапроситьМаркиПоНомеру_В2( ТИПМАРКИ, СЕРИЯМАРКИ, НОМЕРМАРКИ );	
	ELSE IF ( ТИПЗАПРОСА == "REJECTSACT" )
		RETURN ЕГАИС.ЗапроситьОтменуПроведенияСписания_В2( ИДАКТА );	
	ELSE IF ( ТИПЗАПРОСА == "REJECTBACT" )
		RETURN ЕГАИС.ЗапроситьОтменуПроведенияПостановкиНаБаланс_В2( ИДАКТА );	
	ELSE IF ( ТИПЗАПРОСА == "REJECTTTN" )
		RETURN ЕГАИС.ЗапроситьОтменуПроведенияТТН_В2( ИДТТН );	
	ELSE IF ( ТИПЗАПРОСА == "QUERYCLIENTS" )
		RETURN ЕГАИС.ЗапросОКлиентах_В2( ЕГАИСИД, ДАТА );	
	ELSE IF ( ТИПЗАПРОСА == "VNP_TTN" )
		RETURN ЕГАИС.ВыгрузитьПриходыКакВнутренниеПеремещения( ИМЯТАБЛИЦЫ );
	ELSE IF ( ТИПЗАПРОСА == "VNP_RET_TTN" )
		RETURN ЕГАИС.ВозвратИзТорговогоЗалаПоПриходам( ИМЯТАБЛИЦЫ );
	ELSE IF ( ТИПЗАПРОСА == "SENDANYFILE" )
		RETURN ЕГАИС.ВыгрузитьВнешнийФайл( КАТАЛОГУТМ, ИМЯФАЙЛАВУТМ );
	ELSE IF ( ТИПЗАПРОСА == "QUERYFORMBMARKS" )
		RETURN ЕГАИС.ЗапроситьОстаткиМарокПоСправкеБ( ИДСПРАВКИБ );

		
	// Проверяем накладные, возможно, по некоторым уже были отправлены акты
	ДОБАВИТЬКОНТЕКСТ( "SELECT ndok, date FROM spr001 WHERE egaisstatus > 0 AND identity_column IN ( SELECT ic FROM " + ИМЯТАБЛИЦЫ + " )", "СписокНакладных" );
	ТекстСообщения		= "";
	WHILE ( !КОНЕЦКОНТЕКСТА( "СписокНакладных" ) )
	{
		ТекстСообщения	+= СписокНакладных.ndok + " от " + DTOC( СписокНакладных.date ) + CHR( 13 );
		ПРОПУСТИТЬ( 1, "СписокНакладных" );
	}
	УДАЛИТЬКОНТЕКСТ( "СписокНакладных" );
	IF ( !ПУСТО( ТекстСообщения ) )
	{
		СООБЩЕНИЕ( "По следующим накладным уже были отправлены акты. Измените статус отправки акта в ЕГАИС и повторите отправку." + CHR( 13 ) + ТекстСообщения, "Отправка актов" );
		RETURN false;
	}

	// Проверяем соответствие типа акта, указанного в документе, с выгружаемыми данными
	ДОБАВИТЬКОНТЕКСТ( "SELECT ndok, date 
					   FROM spr001 spr001 
					   WHERE identity_column IN ( SELECT ic FROM " + ИМЯТАБЛИЦЫ + " ) AND
							 egaisact <> CASE WHEN NOT EXISTS( SELECT * FROM spec001 WHERE ic = spr001.identity_column AND kolp > realkolp ) THEN 1 ELSE
										 CASE WHEN NOT EXISTS( SELECT * FROM spec001 WHERE ic = spr001.identity_column AND realkolp > 0 ) THEN 3 ELSE 2 END END", "СписокНакладных" );
	ТекстСообщения		= "";
	WHILE ( !КОНЕЦКОНТЕКСТА( "СписокНакладных" ) )
	{
		ТекстСообщения	+= СписокНакладных.ndok + " от " + DTOC( СписокНакладных.date ) + CHR( 13 );
		ПРОПУСТИТЬ( 1, "СписокНакладных" );
	}
	УДАЛИТЬКОНТЕКСТ( "СписокНакладных" );
	IF ( !ПУСТО( ТекстСообщения ) )
	{
		СООБЩЕНИЕ( "В следующих накладных указан неверный тип акта. " + CHR( 13 ) + ТекстСообщения + CHR( 13 ) + "Документы не были отправлены в ЕГАИС", "Отправка актов", 0 );
		RETURN false;
	}
	  
	// Проходим по списку отмеченных документов и отправляем акты
	ДОБАВИТЬКОНТЕКСТ( "SELECT identity_column AS ic, egaisver 
					   FROM spr001 spr001 
					   WHERE identity_column IN ( SELECT ic FROM " + ИМЯТАБЛИЦЫ + " )", "СписокДокументов" );
	IF ( КОЛИЧЕСТВОСТРОК( "СписокДокументов" ) == 0 )
	{
		СООБЩЕНИЕ( "Необходимо отметить хотя бы одну накладную, для отправки акта по ней.", "Отправка актов" );
		RETURN false;
	}
	WHILE ( !КОНЕЦКОНТЕКСТА( "СписокДокументов" ) )
	{
		// Версия акта должна соответствовать версии накладной
		Версия3ЕГАИС		= UPPER( ALLTRIM( СписокДокументов.egaisver ) ) == "WAYBILL_V3";
		Версия4ЕГАИС		= UPPER( ALLTRIM( СписокДокументов.egaisver ) ) == "WAYBILL_V4";
		Результат			= true;
		IF ( Версия3ЕГАИС )
			Результат		= ЕГАИС.ОтправитьАКТ_В3( СписокДокументов.ic );
		ELSE IF ( Версия4ЕГАИС )
			Результат		= ЕГАИС.ОтправитьАКТ_В4( СписокДокументов.ic );
		ELSE
			Результат		= ЕГАИС.ОтправитьАКТ_В2( СписокДокументов.ic );
		IF ( !Результат ) RETURN false;
		
		ПРОПУСТИТЬ( 1, "СписокДокументов" );
	}
	УДАЛИТЬКОНТЕКСТ( "СписокДокументов" );
}
catch ( )
{
	СООБЩЕНИЕ( "В процессе обмена с ЕГАИС произошли ошибки." + CHR( 13 ) + "Операция была прервана" );
	RETURN false;
}
RETURN true;
