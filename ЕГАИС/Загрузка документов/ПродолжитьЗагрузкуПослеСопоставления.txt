IF ( !ЕГАИС.СформироватьТовары( СОЗДАВАТЬТОВАРЫ, ИДЗАГРУЗКИ ) ) RETURN false;IF ( !ЕГАИС.СформироватьДокументы( ) ) RETURN false;IF ( !ЕГАИС.СформироватьИнвентаризации( ) ) RETURN false;// Удаляем ответы на запросы (url содержит Reply, т.к. в других местах эти файлы не удаляются)УдалятьФайлы	= VAL( ЗАПРОС( "SELECT value FROM param_ex WHERE param = 'EGAIS_DELETEFILES" + СКЛАД + "'" ) ) != 0;ВЫБРАТЬКОНТЕКСТ( "СписокДокументов" );ПЕРЕЙТИВНАЧАЛО( "СписокДокументов" );WHILE ( !КОНЕЦКОНТЕКСТА( "СписокДокументов" ) ){	IF ( ATC( СписокДокументов.url, "Reply" ) > 0 )	{		// Выполняем команду DELETE с нужным URL		IF ( УдалятьФайлы )			_РЕЗУЛЬТАТУДАЛЕНИЯ	= _РЕЗУЛЬТАТУДАЛЕНИЯ AND ЕГАИС.HTTPCommand( "DELETE", СписокДокументов.url );					// Сам запрос удаляем в любом случае, т.к. больше ответов на него не придет		IF ( !ПУСТО( СписокДокументов.replyid ) AND НАЙТИ( "СписокИсходящихДокументов", "replyid", СписокДокументов.replyid ) )			ЕГАИС.HTTPCommand( "DELETE", СписокИсходящихДокументов.url );	}	ПРОПУСТИТЬ( 1, "СписокДокументов" );}УДАЛИТЬКОНТЕКСТ( "СписокДокументов" );ДополнительноеСообщение		= "";IF ( !_РЕЗУЛЬТАТУДАЛЕНИЯ )	ДополнительноеСообщение	= CHR( 13 ) + CHR( 13 ) + "Были ошибки при удалении файлов из транспортного модуля ЕГАИС.";ДОБАВИТЬКОНТЕКСТ( "SELECT DISTINCT wb_NUMBER, wb_Date FROM " + ЕГАИСТаблицаСтрокНакладных + " WHERE egaisid = ''", "НезагруженныеНакладные" );IF ( КОЛИЧЕСТВОСТРОК( "НезагруженныеНакладные" ) > 0 ){	ДополнительноеСообщение	+= CHR( 13 ) + CHR( 13 ) + "В транспортном модуле ЕГАИС обнаружены накладные без соответствующих справок Б. Эти накладные не были загружены.";	WHILE( !КОНЕЦКОНТЕКСТА( "НезагруженныеНакладные" ) )	{		ДополнительноеСообщение	+= CHR( 13 ) + "№ " + НезагруженныеНакладные.wb_NUMBER + " от " + DTOC( НезагруженныеНакладные.wb_date );		ПРОПУСТИТЬ( 1, "НезагруженныеНакладные" );	}	УДАЛИТЬКОНТЕКСТ( "НезагруженныеНакладные" );}// Освобождаем ресурсы удаляя временные таблицы и контекстыЕГАИС.УдалитьВременныеТаблицы( );ИнформацияОСозданныхОбъектах			= "";IF ( ЕГАИСКоличествоСозданныхТоваров != 0 OR ЕГАИСКоличествоСозданныхКонтрагентов != 0 OR ЕГАИСКоличествоСозданныхНакладных != 0 OR ЕГАИСКоличествоСозданныхИнвентаризаций != 0 OR ЕГАИСКоличествоОтправленныхЗапросов != 0 ){	ИнформацияОСозданныхОбъектах		= CHR( 13 ) + "Было добавлено:";	IF ( ЕГАИСКоличествоСозданныхТоваров != 0 )		ИнформацияОСозданныхОбъектах	+= CHR( 13 ) + "    карточек товаров " + STR( ЕГАИСКоличествоСозданныхТоваров ) + " шт.;";	IF ( ЕГАИСКоличествоСозданныхКонтрагентов != 0 )		ИнформацияОСозданныхОбъектах	+= CHR( 13 ) + "    карточек контрагентов " + STR( ЕГАИСКоличествоСозданныхКонтрагентов ) + " шт.;";	IF ( ЕГАИСКоличествоСозданныхНакладных != 0 )		ИнформацияОСозданныхОбъектах	+= CHR( 13 ) + "    приходных накладных " + STR( ЕГАИСКоличествоСозданныхНакладных ) + " шт.;";	IF ( ЕГАИСКоличествоСозданныхИнвентаризаций != 0 )		ИнформацияОСозданныхОбъектах	+= CHR( 13 ) + "    инвентаризаций ЕГАИС " + STR( ЕГАИСКоличествоСозданныхИнвентаризаций ) + " шт.;";	IF ( ЕГАИСКоличествоОтправленныхЗапросов != 0 )		ИнформацияОСозданныхОбъектах	+= CHR( 13 ) + "Было отправленно запросов ЕГАИС " + STR( ЕГАИСКоличествоОтправленныхЗапросов ) + " шт.;";}IF ( ЕГАИСКоличествоИзвещений != 0 )	ИнформацияОСозданныхОбъектах		+= ЕСЛИ( !ПУСТО( ИнформацияОСозданныхОбъектах ), CHR( 13 ), "" ) + CHR( 13 ) + "Было обработано " + ЗАМЕНИТЬ( ПРОПИСЬ( ЕГАИСКоличествоИзвещений, "извещение", "извещения", "извещений" ), "один ", "одно " ) + " от ЕГАИС.";СООБЩЕНИЕ( "Загрузка данных из ЕГАИС произведена успешно." + ЕСЛИ( ПУСТО( ИнформацияОСозданныхОбъектах ) AND ПУСТО( ДополнительноеСообщение ), 			CHR( 13 ) + "В УТМ нет новых документов ", ИнформацияОСозданныхОбъектах ) + ЕСЛИ( !ПУСТО( ДополнительноеСообщение ), CHR( 13 ) + "Дополнительная информация:" + ДополнительноеСообщение, "" ) );RETURN true;
