ДОБАВИТЬКОНТЕКСТ( "SET FMTONLY ON SELECT CONVERT( int, 0 ) AS count, CONVERT( int, 0 ) AS total, CONVERT( int, 0 ) AS offset SET FMTONLY OFF", "Данные" );ДОБАВИТЬКОНТЕКСТ( "SET FMTONLY ON SELECT '' AS bs_guid, '' AS dt_name, '' AS dt_fullname, '' AS dt_englishname, '' AS dt_code, '' AS dt_code3 SET FMTONLY OFF", "Страны" );Количество				= 0;ТекущееСмещение			= 0;ОбщееКоличество			= 0;СИСТЕМНОЕСООБЩЕНИЕ( "Запрос справочника стран" );WHILE ( Количество == 0 OR ТекущееСмещение < ОбщееКоличество ){	Количество			= 100;	Текст = "	<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" 					  xmlns:v2=""http://api.vetrf.ru/schema/cdm/registry/ws-definitions/v2"" 					  xmlns:base=""http://api.vetrf.ru/schema/cdm/base"" 					  xmlns:v21=""http://api.vetrf.ru/schema/cdm/dictionary/v2"">	   <soapenv:Header/>	   <soapenv:Body>		  <v2:getAllCountryListRequest>			 <base:listOptions>				<base:count>" + Количество + "</base:count>				<base:offset>" + ТекущееСмещение + "</base:offset>			 </base:listOptions>		   </v2:getAllCountryListRequest>	   </soapenv:Body>	</soapenv:Envelope>	";	ОтветСервера			= Меркурий.ОтправитьЗапрос( Текст, "АДРЕСА", МЕРКУРИЙЛОГИН, МЕРКУРИЙПАРОЛЬ, МЕРКУРИЙТЕСТОВЫЙКОНТУР );	ЗАГРУЗИТЬ( "Данные", "XMLSTRING", ОтветСервера );	ЗАГРУЗИТЬ( "Страны", "XMLSTRING", ОтветСервера, 'dt:country' );	ПЕРЕЙТИВНАЧАЛО( "Данные" );		ТекущееСмещение		= Данные.offset + Данные.count;	IF ( ОбщееКоличество == 0 )	{		ОбщееКоличество	= Данные.total;		IF ( ОбщееКоличество > 10 )			ИНДИКАТОР( "Загрузка стран", ОбщееКоличество );	}	ELSE IF ( ОбщееКоличество > 10 )		ИНДИКАТОР( ТекущееСмещение, "Загружено " + STR( ТекущееСмещение ) + " из " + STR( ОбщееКоличество ) );			УДАЛИТЬ( "ALL", "Данные" );}ИНДИКАТОР( );УДАЛИТЬКОНТЕКСТ( "Данные" );// Запишем полученный результат в справочник странПЕРЕЙТИВНАЧАЛО( "Страны" );WHILE ( !КОНЕЦКОНТЕКСТА( "Страны" ) ){	__SQL {		IF EXISTS( SELECT * FROM mrc_countries WHERE guid = '[[STDF( Страны.bs_guid )]]' ) 			UPDATE mrc_countries SET name= '[[STDF( Страны.dt_name )]]', fullname= '[[STDF( Страны.dt_fullname )]]', 								   englishname= '[[STDF( Страны.dt_englishname )]]', code2= '[[STDF( Страны.dt_code )]]', code3= '[[STDF( Страны.dt_code3 )]]' 			WHERE guid = '[[STDF( Страны.bs_guid )]]';		ELSE			INSERT INTO mrc_countries ( guid, name, fullname, englishname, code2, code3 ) 			VALUES ( '[[STDF( Страны.bs_guid )]]', '[[STDF( Страны.dt_name )]]', '[[STDF( Страны.dt_fullname )]]', '[[STDF( Страны.dt_englishname )]]', '[[STDF( Страны.dt_code )]]', '[[STDF( Страны.dt_code3 )]]' );	}	ПРОПУСТИТЬ( 1, "Страны" );}УДАЛИТЬКОНТЕКСТ( "Страны" );RETURN true;
