СЕРТИФИКАТ				= ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'MARK_CERTIFICATE" + ПРЕДПРИЯТИЕ + "'" );ТЕСТОВЫЙКОНТУР			= VAL( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'MARK_APITEST" + ПРЕДПРИЯТИЕ + "'" ) ) != 0 ;ЭВОТОРТОКЕН				= Маркировка.ЭВОТОРАвторизация( ПРЕДПРИЯТИЕ, СЕРТИФИКАТ );IF ( ПУСТО( ЭВОТОРТОКЕН ) ) RETURN false;АдресСервера 			= ЕСЛИ( ТЕСТОВЫЙКОНТУР, "https://edo-v2.platformaofd.ru", "https://edo.platformaofd.ru" );Заголовки[ 0 ]			= "Authorization: Bearer " + ЭВОТОРТОКЕН;Заголовки[ 1 ]			= "";// Проходим по дням периода и запрашиваем документы из Платформа ЭДОtry{	ТекстОшибки			= "Сервер " + АдресСервера + CHR( 13 ) + "вернул сообщение об ошибке: " + CHR( 13 );	Соединение 			= HTTPCONNECT( АдресСервера, "", true, Маркировка.ФАЙЛЖУРНАЛА( ) );	// Получаем содержимое документа	Заголовки[ 1 ]		= "accept: application/xml";	Ответ				= HTTPGET( Соединение, "api/v2/documents/" + ИДДОКУМЕНТА + "/content", "Заголовки" );	IF ( !МАРКИРОВКА.ЭВОТОРПРОВЕРКАНАОШИБКИ( @Ответ ) ) THROW ( Ответ );	ШифрованныеДанные	= ШИФРОВАНИЕ( СЕРТИФИКАТ, Ответ, 1, true, false, _МАРКИРОВКА_ХРАНИЛИЩЕСЕРТИФИКАТОВ );	Заголовки[ 1 ]		= "Content-Type: application/octet-stream";	Ответ				= HTTPPUT( Соединение, "api/v2/documents/" + ИДДОКУМЕНТА + "/signature", ШифрованныеДанные, "Заголовки" );	IF ( !МАРКИРОВКА.ЭВОТОРПРОВЕРКАНАОШИБКИ( @Ответ ) ) THROW ( Ответ );}catch ( ТекстСообщения ){	HTTPCLOSE( Соединение );	IF ( !ПУСТО( ТекстСообщения ) ) СООБЩЕНИЕ( ТекстСообщения );	RETURN false;}HTTPCLOSE( Соединение );RETURN true;
